<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Pain Assessment | Physiosmetic</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- html2canvas for Chart capture -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Lottie Player for Animations -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <!-- Translations Dictionary -->
    <script src="translations.js"></script>

    <style>
        :root {
            --primary: #F37021;
            --primary-light: #ff9d5c;
            --primary-dark: #d85f15;
            --secondary: #4385F5;
            --dark-bg: #050A14;
            --card-bg: rgba(10, 15, 25, 0.95);
            --border-color: rgba(243, 112, 33, 0.2);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Enhanced focus states for accessibility */
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            border-radius: 4px;
        }

        button:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 4px;
        }

        /* ANIMATED BACKGROUND */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #050A14 0%, #0a1525 50%, #050A14 100%);
            z-index: -1;
        }

        .animated-background::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(243, 112, 33, 0.05) 0%, transparent 70%);
            animation: backgroundPulse 15s ease-in-out infinite;
        }

        @keyframes backgroundPulse {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(10%, 10%) scale(1.1); }
        }

        /* CONTAINER */
        #pain-assessment {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 0 1.5rem;
            position: relative;
        }

        /* PREMIUM HEADER */
        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .assessment-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(243, 112, 33, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 1;
        }

        /* SVG ICON STYLE */
        .icon-svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .ai-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: avatarPulse 3s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(243, 112, 33, 0.4);
        }

        .ai-avatar svg {
            width: 32px;
            height: 32px;
            fill: white;
        }

        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(243, 112, 33, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 50px rgba(243, 112, 33, 0.8); }
        }

        .ai-avatar.thinking::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 16px;
            height: 16px;
            background: var(--success);
            border-radius: 50%;
            animation: blink 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px var(--success);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .header-text h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
        }

        .header-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            z-index: 1;
        }

        /* GENDER TOGGLE */
        .gender-toggle {
            display: flex;
            background: rgba(243, 112, 33, 0.1);
            padding: 0.25rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .gender-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .gender-btn:hover {
            color: var(--text-primary);
        }

        .gender-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: #fff;
            box-shadow: 0 4px 12px rgba(243, 112, 33, 0.3);
        }

        .voice-toggle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(243, 112, 33, 0.1);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-toggle:hover {
            background: rgba(243, 112, 33, 0.2);
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .voice-toggle.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-color: var(--primary);
            animation: voicePulse 1s ease-in-out infinite;
        }

        @keyframes voicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .language-selector {
            display: flex;
            gap: 0.5rem;
            background: rgba(243, 112, 33, 0.1);
            padding: 0.5rem;
            border-radius: 12px;
        }

        .lang-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: rgba(243, 112, 33, 0.15);
            color: var(--text-primary);
        }

        .lang-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: #fff;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(243, 112, 33, 0.3);
        }

        /* PROGRESS INDICATOR */
        .progress-indicator {
            margin-bottom: 2rem;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 1rem;
        }

        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(243, 112, 33, 0.2);
            z-index: 1;
            border-radius: 2px;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light), var(--primary));
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(243, 112, 33, 0.8), 0 0 40px rgba(243, 112, 33, 0.4);
            border-radius: 2px;
            animation: shimmer 2s linear infinite;
            position: relative;
            overflow: hidden;
        }

        .progress-line-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: slideShimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes slideShimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .progress-step {
            position: relative;
            z-index: 2;
            text-align: center;
            flex: 1;
        }

        .step-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 3px solid rgba(243, 112, 33, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .step-circle:hover {
            transform: scale(1.1);
            border-color: rgba(243, 112, 33, 0.5);
        }

        .progress-step.active .step-circle {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-color: var(--primary);
            box-shadow: 0 0 25px rgba(243, 112, 33, 0.8);
            transform: scale(1.15);
        }

        .progress-step.completed .step-circle {
            background: var(--success);
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.6);
        }

        .step-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .progress-step.active .step-label {
            color: var(--primary);
            font-weight: 600;
        }

        /* MAIN CARD */
        .assessment-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 2.5rem;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            min-height: 600px;
            position: relative;
            overflow: hidden;
        }

        .assessment-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, rgba(243, 112, 33, 0.1), rgba(67, 133, 245, 0.1));
            border-radius: 24px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .assessment-card:hover::before {
            opacity: 1;
        }

        /* STEP CONTENT */
        .step-content {
            display: none;
            animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .step-content.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .step-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .step-description {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        /* BODY DIAGRAM WITH GENDER TOGGLE */
        .body-diagram-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            align-items: start;
        }

        .body-svg-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .body-svg {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 10px 40px rgba(243, 112, 33, 0.3));
            transition: filter 0.3s ease;
        }

        .body-part {
            fill: rgba(243, 112, 33, 0.08);
            stroke: rgba(243, 112, 33, 0.3);
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .body-part:hover {
            fill: rgba(243, 112, 33, 0.25);
            stroke: var(--primary);
            stroke-width: 3;
            transition: all 0.15s ease;
            filter: drop-shadow(0 0 15px rgba(243, 112, 33, 1));
        }

        .body-part.selected {
            fill: rgba(0, 242, 255, 0.4);
            stroke: #00f2ff;
            stroke-width: 4;
            animation: partGlow 2s ease-in-out infinite, pulseHighlight 0.3s ease-out;
            filter: drop-shadow(0 0 20px rgba(0, 242, 255, 1));
        }

        @keyframes pulseHighlight {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.05);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes partGlow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* PAIN TOOLTIP */
        .pain-tooltip {
            position: absolute;
            background: rgba(243, 112, 33, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 1rem;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8);
            min-width: 200px;
            backdrop-filter: blur(10px);
        }

        .pain-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        .tooltip-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .tooltip-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .tooltip-types {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .pain-type-badge {
            padding: 0.25rem 0.75rem;
            background: rgba(243, 112, 33, 0.15);
            border: 1px solid rgba(243, 112, 33, 0.3);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--primary);
        }

        .pain-intensity-selector {
            background: rgba(243, 112, 33, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
        }

        .intensity-title {
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }

        .intensity-levels {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .intensity-level {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .intensity-level:hover {
            background: rgba(243, 112, 33, 0.1);
            border-color: var(--primary);
            transform: translateX(8px);
        }

        .intensity-level.selected {
            background: linear-gradient(135deg, rgba(243, 112, 33, 0.25), rgba(67, 133, 245, 0.25));
            border-color: var(--primary);
            box-shadow: 0 4px 20px rgba(243, 112, 33, 0.4);
        }

        .intensity-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 0 10px currentColor;
        }

        .intensity-level[data-level="mild"] .intensity-dot {
            background: var(--success);
        }

        .intensity-level[data-level="moderate"] .intensity-dot {
            background: var(--warning);
        }

        .intensity-level[data-level="severe"] .intensity-dot {
            background: var(--danger);
        }

        /* OPTIONS GRID */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .option-card {
            background: rgba(243, 112, 33, 0.05);
            border: 2px solid rgba(243, 112, 33, 0.2);
            border-radius: 16px;
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .option-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(243, 112, 33, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .option-card:hover::before {
            left: 100%;
        }

        .option-card:hover {
            background: rgba(243, 112, 33, 0.12);
            border-color: rgba(243, 112, 33, 0.4);
            transform: translateY(-6px);
            box-shadow: 0 12px 28px rgba(243, 112, 33, 0.25);
        }

        .option-card.selected {
            background: linear-gradient(135deg, rgba(243, 112, 33, 0.25), rgba(67, 133, 245, 0.25));
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(243, 112, 33, 0.4);
        }

        .option-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option-icon svg {
            width: 100%;
            height: 100%;
            fill: var(--primary);
        }

        /* LOADING WITH AI AVATAR */
        .loading-analysis {
            display: none;
            text-align: center;
            padding: 4rem 0;
        }

        .loading-analysis.active {
            display: block;
        }

        .loading-avatar {
            width: 120px;
            height: 120px;
            margin: 0 auto 2rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            animation: loadingPulse 2s ease-in-out infinite;
        }

        .loading-avatar svg {
            width: 60px;
            height: 60px;
            fill: white;
        }

        @keyframes loadingPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 50px rgba(243, 112, 33, 0.5);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 100px rgba(243, 112, 33, 0.9);
            }
        }

        .loading-ring {
            position: absolute;
            width: 140px;
            height: 140px;
            border: 5px solid transparent;
            border-top-color: var(--primary-light);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* AI TYPING INDICATOR */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: rgba(243, 112, 33, 0.1);
            border-radius: 20px;
            margin: 1rem 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.3; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* AI CHAT RESULTS */
        .ai-chat-results {
            display: none;
        }

        .ai-chat-results.active {
            display: block;
        }

        .chat-messages {
            max-width: 100%;
            margin: 0 auto 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chat-message {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            opacity: 0;
            transform: translateY(20px);
            animation: messageSlideIn 0.5s ease forwards;
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(243, 112, 33, 0.4);
        }

        .chat-avatar svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .chat-bubble {
            flex: 1;
            background: rgba(243, 112, 33, 0.08);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.25rem;
            position: relative;
        }

        .chat-bubble::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 16px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid rgba(243, 112, 33, 0.08);
        }

        .message-title {
            font-weight: 700;
            font-size: 1.125rem;
            margin-bottom: 0.75rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message-content {
            color: var(--text-secondary);
            line-height: 1.8;
        }

        /* FOLLOW-UP QUESTION INPUT */
        .follow-up-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(243, 112, 33, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }

        .follow-up-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
            display: flex;
            align-items: center;
        }

        .follow-up-chat-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            scroll-behavior: smooth;
        }

        .follow-up-chat-container:empty::before {
            content: 'No messages yet. Ask a question to start the conversation!';
            display: block;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 2rem;
        }

        .chat-message-user {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px 12px 4px 12px;
            margin-bottom: 0.75rem;
            max-width: 80%;
            margin-left: auto;
            animation: slideInRight 0.3s ease;
        }

        .chat-message-ai {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            padding: 0.75rem 1rem;
            border-radius: 12px 12px 12px 4px;
            margin-bottom: 0.75rem;
            max-width: 80%;
            animation: slideInLeft 0.3s ease;
            border-left: 3px solid var(--primary);
        }

        .chat-typing-indicator {
            display: inline-flex;
            gap: 4px;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            max-width: fit-content;
        }

        .chat-typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }

        .chat-typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .chat-typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .follow-up-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .mic-btn {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn:hover {
            background: rgba(243, 112, 33, 0.1);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .mic-btn.recording {
            background: var(--primary);
            animation: pulse 1s infinite;
        }

        .mic-btn.recording svg {
            fill: white !important;
        }

        .follow-up-input {
            flex: 1;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .follow-up-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(243, 112, 33, 0.1);
        }

        .follow-up-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .follow-up-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 112, 33, 0.5);
        }

        /* CHART CONTAINER */
        .chart-container {
            background: rgba(243, 112, 33, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .chart-title {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        /* SUMMARY CARD */
        .summary-card {
            background: linear-gradient(135deg, rgba(243, 112, 33, 0.1), rgba(67, 133, 245, 0.1));
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(243, 112, 33, 0.15), transparent);
            border-radius: 50%;
            filter: blur(60px);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .summary-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .summary-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .summary-item {
            background: rgba(10, 15, 25, 0.6);
            padding: 1.25rem;
            border-radius: 12px;
            border: 1px solid rgba(243, 112, 33, 0.2);
        }

        .summary-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            position: relative;
            z-index: 1;
        }

        .summary-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-download {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 16px rgba(243, 112, 33, 0.3);
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(243, 112, 33, 0.5);
        }

        .btn-share {
            background: rgba(67, 133, 245, 0.15);
            color: var(--secondary);
            border: 2px solid var(--secondary);
        }

        .btn-share:hover {
            background: rgba(67, 133, 245, 0.25);
            transform: translateY(-2px);
        }

        /* DAILY TIPS */
        .daily-tips {
            margin: 2rem 0;
        }

        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .tip-card {
            background: linear-gradient(135deg, rgba(243, 112, 33, 0.08), rgba(67, 133, 245, 0.08));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .tip-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(243, 112, 33, 0.2);
            border-color: var(--primary);
        }

        .tip-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .tip-icon svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* FEEDBACK SECTION */
        .feedback-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(243, 112, 33, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            text-align: center;
        }

        .feedback-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .feedback-btn {
            padding: 0.875rem 1.75rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .feedback-btn:hover {
            background: rgba(243, 112, 33, 0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .feedback-btn.selected {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-color: var(--primary);
            color: #fff;
        }

        /* ENHANCED REHAB PLAN STYLES */
        .rehab-plan-container {
            margin-top: 2rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .rehab-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            backdrop-filter: blur(20px);
        }

        .rehab-header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rehab-icon {
            width: 48px;
            height: 48px;
            fill: var(--primary);
            flex-shrink: 0;
        }

        .rehab-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .rehab-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0.25rem 0 0 0;
        }

        .rehab-header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .rehab-action-btn {
            padding: 0.6rem;
            background: rgba(243, 112, 33, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--primary);
        }

        .rehab-action-btn:hover {
            background: rgba(243, 112, 33, 0.2);
            transform: scale(1.05);
        }

        .difficulty-selector {
            padding: 0.6rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .difficulty-selector:hover {
            border-color: var(--primary);
        }

        .difficulty-selector option {
            background: var(--dark-bg);
            color: var(--text-primary);
        }

        .rehab-progress-container {
            margin-bottom: 2rem;
            padding: 1.25rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .progress-percentage {
            color: var(--primary);
            font-size: 1.1rem;
            font-weight: 700;
        }

        .progress-bar-bg {
            width: 100%;
            height: 12px;
            background: rgba(243, 112, 33, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 10px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(243, 112, 33, 0.5);
        }

        .exercises-grid {
            display: grid;
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .exercise-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease-out backwards;
        }

        .exercise-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(243, 112, 33, 0.2);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            cursor: pointer;
            user-select: none;
        }

        .exercise-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .exercise-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            position: relative;
        }

        .exercise-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .exercise-checkbox.checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .exercise-icon {
            width: 48px;
            height: 48px;
            background: rgba(243, 112, 33, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .exercise-info {
            flex: 1;
            min-width: 0;
        }

        .exercise-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 0.25rem 0;
        }

        .exercise-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .exercise-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .difficulty-badge.beginner {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .difficulty-badge.intermediate {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .difficulty-badge.advanced {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .expand-icon {
            width: 24px;
            height: 24px;
            fill: var(--text-secondary);
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .exercise-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .exercise-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
        }

        .exercise-card.expanded .exercise-content {
            max-height: 600px;
            padding: 0 1.25rem 1.25rem 1.25rem;
        }

        .exercise-description {
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(243, 112, 33, 0.05);
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .exercise-steps {
            margin-bottom: 1rem;
        }

        .exercise-steps-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .exercise-steps ol {
            margin: 0;
            padding-left: 1.5rem;
            color: var(--text-secondary);
        }

        .exercise-steps li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .exercise-tips {
            padding: 1rem;
            background: rgba(67, 133, 245, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--secondary);
        }

        .exercise-tips-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .exercise-tips-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .rehab-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .rehab-btn {
            flex: 1;
            min-width: 200px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
        }

        .btn-primary-rehab {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .btn-primary-rehab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 112, 33, 0.4);
        }

        .btn-secondary-rehab {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary-rehab:hover {
            border-color: var(--primary);
            background: rgba(243, 112, 33, 0.1);
        }

        .ai-connect-notice {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .connect-ai-btn {
            padding: 0.6rem 1.25rem;
            background: var(--warning);
            color: var(--dark-bg);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .rehab-plan-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .rehab-header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .difficulty-selector {
                flex: 1;
            }

            .exercise-header-left {
                flex-direction: column;
                align-items: flex-start;
            }

            .exercise-meta {
                flex-direction: column;
                gap: 0.5rem;
            }

            .rehab-actions {
                flex-direction: column;
            }

            .rehab-btn {
                width: 100%;
            }
        }

        /* NAVIGATION */
        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2.5rem;
            justify-content: space-between;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: #fff;
            box-shadow: 0 4px 16px rgba(243, 112, 33, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(243, 112, 33, 0.5);
        }

        .btn-primary.pulse {
            animation: buttonPulse 2s ease-in-out infinite;
        }

        @keyframes buttonPulse {
            0%, 100% {
                box-shadow: 0 4px 16px rgba(243, 112, 33, 0.3);
            }
            50% {
                box-shadow: 0 6px 32px rgba(243, 112, 33, 0.8), 0 0 48px rgba(243, 112, 33, 0.4);
                transform: scale(1.02);
            }
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* RESPONSIVE */
        @media (max-width: 968px) {
            .body-diagram-container {
                grid-template-columns: 1fr;
            }

            .pain-intensity-selector {
                order: -1;
            }

            .header-controls {
                flex-direction: column;
                gap: 0.5rem;
            }

            .summary-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .assessment-header {
                flex-direction: column;
                gap: 1rem;
            }

            .header-left {
                flex-direction: column;
                text-align: center;
            }

            .nav-buttons {
                flex-direction: column-reverse;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .step-title {
                font-size: 1.5rem;
            }

            .chart-wrapper {
                height: 250px;
            }
        }

        /* API CONFIG MODAL */
        .config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .config-modal.active {
            display: flex;
        }

        .config-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }

        .config-card h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-family: 'Space Grotesk', sans-serif;
        }

        .config-input-group {
            margin-bottom: 1.5rem;
        }

        .config-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .config-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'Inter', monospace;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .config-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
        }

        .config-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(243, 112, 33, 0.4);
        }

        .config-help {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(67, 133, 245, 0.1);
            border-left: 3px solid var(--secondary);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .config-help a {
            color: var(--secondary);
            text-decoration: none;
        }

        .config-help a:hover {
            text-decoration: underline;
        }

        /* ENHANCED INPUT FIELDS */
        .enhanced-inputs {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .input-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .input-select:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .input-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .input-textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .radio-label:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--primary);
        }

        .radio-label input[type="radio"] {
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .radio-label input[type="radio"]:checked + span {
            color: var(--primary);
            font-weight: 600;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .checkbox-label:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--primary);
        }

        .checkbox-label input[type="checkbox"] {
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"]:checked + span {
            color: var(--primary);
            font-weight: 600;
        }

        .slider-container {
            position: relative;
        }

        .input-slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            margin-bottom: 0.5rem;
        }

        .input-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .input-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--primary);
        }

        .input-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        .input-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--primary);
        }

        .slider-value {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(67, 133, 245, 0.2);
            border-radius: 6px;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .subsection-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* CONTEXT QUESTIONS */
        .context-questions-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .context-question {
            margin-bottom: 1.5rem;
        }

        .context-question:last-child {
            margin-bottom: 0;
        }

        .question-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            gap: 1rem;
        }

        .voice-buttons {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .voice-btn {
            padding: 0.5rem;
            background: rgba(243, 112, 33, 0.1);
            border: 1px solid rgba(243, 112, 33, 0.3);
            border-radius: 8px;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            background: rgba(243, 112, 33, 0.2);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .voice-btn:active {
            transform: scale(0.95);
        }

        .voice-btn.listening,
        .voice-btn.speaking {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-color: var(--primary);
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* SELECTED PARTS DISPLAY */
        .selected-parts-display {
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.1), rgba(0, 200, 255, 0.05));
            border: 2px solid #00f2ff;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .selected-parts-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #00f2ff;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .selected-parts-list {
            color: var(--text);
            font-size: 1rem;
            font-weight: 500;
        }

        .selected-parts-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .part-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.2), rgba(0, 200, 255, 0.1));
            border: 1px solid #00f2ff;
            border-radius: 20px;
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: #00f2ff;
            animation: badgeFadeIn 0.3s ease-out;
        }

        /* Selected Parts Feedback Bar (Step 1) */
        .selected-parts-bar {
            margin: 1.5rem auto 0;
            padding: 1rem 1.5rem;
            max-width: 600px;
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.08), rgba(0, 200, 255, 0.04));
            border: 2px solid rgba(0, 242, 255, 0.3);
            border-radius: 12px;
            text-align: center;
            font-size: 1rem;
            color: var(--text);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            animation: fadeInUp 0.4s ease-out;
            transition: all 0.3s ease;
        }

        .selected-parts-bar:empty::before {
            content: 'ðŸ‘† Click on body parts above to select them';
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .selected-parts-bar .feedback-label {
            font-weight: 700;
            color: #00f2ff;
            margin-right: 0.5rem;
        }

        .selected-parts-bar .part-name {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.25), rgba(0, 200, 255, 0.15));
            border: 1px solid #00f2ff;
            border-radius: 16px;
            padding: 0.3rem 0.7rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: #00f2ff;
            animation: badgeFadeIn 0.3s ease-out;
        }

        @keyframes badgeFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .selected-parts-empty {
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
            padding: 0.5rem;
        }

        /* IMPACT OPTIONS */
        .impact-section {
            margin: 2rem 0;
        }

        .impact-options {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center;
            animation: impactFadeIn 0.4s ease-out;
        }

        @keyframes impactFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 600px) {
            .impact-options {
                flex-direction: column;
            }
        }

        .impact-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1rem;
            flex: 1 1 200px;
            min-width: 200px;
            max-width: 250px;
        }

        .impact-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(243, 112, 33, 0.4), 0 0 20px rgba(243, 112, 33, 0.3);
        }

        .impact-card:focus {
            outline: 2px solid #00f2ff;
            outline-offset: 2px;
        }

        .impact-card.selected {
            background: linear-gradient(135deg, rgba(243, 112, 33, 0.1), rgba(255, 140, 66, 0.1));
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(243, 112, 33, 0.3);
        }

        .impact-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(243, 112, 33, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .impact-card:hover .impact-icon,
        .impact-card.selected .impact-icon {
            background: var(--primary);
            transform: scale(1.1);
        }

        .impact-icon svg {
            width: 24px;
            height: 24px;
            fill: var(--primary);
        }

        .impact-card:hover .impact-icon svg,
        .impact-card.selected .impact-icon svg {
            fill: white;
        }

        .impact-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .impact-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .impact-options {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* AI-POWERED IMPACT SECTION */
        .ai-impact-container {
            margin: 2rem 0;
        }

        .ai-loading {
            text-align: center;
            padding: 2rem;
            background: rgba(0, 242, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(0, 242, 255, 0.2);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 1rem;
            border: 4px solid rgba(0, 242, 255, 0.2);
            border-top: 4px solid #00f2ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dynamic-impact {
            background: linear-gradient(135deg, rgba(0, 242, 255, 0.05), rgba(0, 200, 255, 0.02));
            border: 2px solid rgba(0, 242, 255, 0.3);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 1.5rem;
            position: relative;
        }

        .ai-badge {
            position: absolute;
            top: -12px;
            right: 20px;
            background: linear-gradient(135deg, #00f2ff, #0099cc);
            color: #000;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 242, 255, 0.3);
        }

        .impact-section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #00f2ff;
            margin: 1.5rem 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .impact-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .context-questions-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .context-question {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .context-question.answered {
            border-color: rgba(0, 242, 255, 0.5);
            background: rgba(0, 242, 255, 0.05);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .question-label {
            display: block;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .question-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .option-btn {
            flex: 1;
            min-width: 80px;
            padding: 0.6rem 1.2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-btn:hover {
            background: rgba(0, 242, 255, 0.1);
            border-color: #00f2ff;
            transform: translateY(-2px);
        }

        .option-btn.selected {
            background: linear-gradient(135deg, #00f2ff, #0099cc);
            border-color: #00f2ff;
            color: #000;
            font-weight: 600;
        }

        .trigger-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .trigger-btn {
            padding: 0.6rem 1.2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: var(--text);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            animation: pulseIn 0.5s ease-out forwards;
        }

        @keyframes pulseIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .trigger-btn:hover {
            background: rgba(243, 112, 33, 0.1);
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(243, 112, 33, 0.3);
        }

        .trigger-btn.selected {
            background: linear-gradient(135deg, var(--primary), #ff8c42);
            border-color: var(--primary);
            color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(243, 112, 33, 0.4);
        }

        /* CONTEXT SUMMARY CHIPS */
        .context-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
        }

        .context-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(243, 112, 33, 0.2), rgba(255, 140, 66, 0.2));
            border: 1px solid rgba(243, 112, 33, 0.3);
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            animation: chipFadeIn 0.4s ease;
        }

        .context-chip svg {
            width: 16px;
            height: 16px;
            fill: var(--primary);
        }

        @keyframes chipFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* STICKY LANGUAGE BAR */
        .sticky-lang-bar {
            position: fixed;
            top: 2rem;
            right: 2rem;
            display: flex;
            gap: 0.5rem;
            z-index: 999;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 0.5rem;
            border-radius: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .sticky-lang-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 20px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sticky-lang-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .sticky-lang-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .lang-flag {
            display: inline-block;
            margin-right: 0.25rem;
            font-size: 1rem;
        }

        /* STICKY PROGRESS HEADER */
        .sticky-progress-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 998;
            background: rgba(5, 10, 20, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .progress-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            opacity: 1;
        }

        .progress-step.completed {
            opacity: 0.8;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(243, 112, 33, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-number {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-color: var(--primary);
            color: white;
            box-shadow: 0 0 20px rgba(243, 112, 33, 0.5);
        }

        .progress-step.completed .step-number {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .progress-step.active .step-label {
            color: var(--text-primary);
        }

        .progress-bar-bg {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 2px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(243, 112, 33, 0.5);
        }

        @media (max-width: 768px) {
            .sticky-lang-bar {
                top: auto;
                bottom: 5rem;
                right: 1rem;
                flex-direction: column;
            }

            .sticky-progress-header {
                padding: 0.75rem 1rem;
            }

            .step-label {
                display: none;
            }

            .progress-steps {
                justify-content: center;
                gap: 1.5rem;
                margin-bottom: 0.75rem;
            }

            .context-chips {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .input-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .radio-group {
                flex-direction: column;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }

        /* VOICE WAVE ANIMATION */
        .voice-wave {
            display: inline-flex;
            gap: 2px;
            align-items: center;
            margin-left: 0.5rem;
        }

        .voice-wave span {
            width: 2px;
            height: 12px;
            background: white;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }

        .voice-wave span:nth-child(2) { animation-delay: 0.1s; }
        .voice-wave span:nth-child(3) { animation-delay: 0.2s; }

        @keyframes wave {
            0%, 100% { height: 8px; }
            50% { height: 16px; }
        }

        /* VOICE CONTROLS */
        .voice-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
        }

        .voice-control-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--secondary) 0%, #2563eb 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .voice-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(67, 133, 245, 0.4);
        }

        .voice-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .voice-control-btn.playing {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        /* LOTTIE ICONS */
        .lottie-icon {
            width: 60px;
            height: 60px;
        }

        .loading-lottie {
            width: 150px;
            height: 150px;
        }

        /* FLOATING ACTION BAR */
        .floating-action-bar {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 1000;
            animation: slideInFromRight 0.5s ease;
        }

        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .fab-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(243, 112, 33, 0.4);
            transition: all 0.3s ease;
        }

        .fab-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 24px rgba(243, 112, 33, 0.6);
        }

        .fab-btn:active {
            transform: scale(0.95);
        }

        .fab-btn .icon-svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        @media (max-width: 768px) {
            .floating-action-bar {
                bottom: 1rem;
                right: 1rem;
            }

            .fab-btn {
                width: 48px;
                height: 48px;
            }

            .fab-btn .icon-svg {
                width: 20px;
                height: 20px;
            }
        }

        /* FADE-IN ANIMATION FOR RESULTS */
        .ai-chat-results.active {
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .summary-card, .chart-container, .daily-tips {
            animation: fadeIn 0.5s ease;
            animation-fill-mode: both;
        }

        .summary-card {
            animation-delay: 0.2s;
        }

        .chart-container:nth-of-type(1) {
            animation-delay: 0.4s;
        }

        .chart-container:nth-of-type(2) {
            animation-delay: 0.6s;
        }

        .daily-tips {
            animation-delay: 0.8s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="animated-background"></div>

    <!-- STICKY LANGUAGE BAR (3 Languages Only) -->
    <div class="sticky-lang-bar" id="stickyLangBar">
        <button class="sticky-lang-btn active" data-lang="en" onclick="switchLanguage('en')">EN</button>
        <button class="sticky-lang-btn" data-lang="hi" onclick="switchLanguage('hi')">à¤¹à¤¿à¤‚</button>
        <button class="sticky-lang-btn" data-lang="regional" onclick="switchLanguage('regional')" id="regionalLangBtn" style="display:none;"></button>
    </div>

    <!-- STICKY PROGRESS HEADER -->
    <div class="sticky-progress-header" id="stickyProgressHeader" style="display:none;">
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Location</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Duration</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Impact</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Analysis</div>
                </div>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 25%"></div>
            </div>
        </div>
    </div>

    <!-- API Configuration Modal -->
    <div class="config-modal" id="configModal">
        <div class="config-card">
            <h2>
                <svg class="icon-svg" viewBox="0 0 24 24" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
                API Configuration
            </h2>

            <div class="config-input-group">
                <label for="openaiKey">OpenAI API Key</label>
                <input type="password" id="openaiKey" class="config-input" placeholder="sk-...">
            </div>

            <div class="config-input-group">
                <label for="googleTranslateKey">Google Translate API Key (Optional - FASTEST! <2s)</label>
                <input type="password" id="googleTranslateKey" class="config-input" placeholder="AIza...">
                <small style="color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 4px; display: block;">
                    âš¡ Ultra-fast translation in &lt;2 seconds (highly recommended)
                </small>
            </div>

            <div class="config-input-group">
                <label for="deeplKey">DeepL API Key (Optional - for supported languages)</label>
                <input type="password" id="deeplKey" class="config-input" placeholder="DeepL-Auth-Key ...">
                <small style="color: rgba(255,255,255,0.5); font-size: 12px; margin-top: 4px; display: block;">
                    Fallback: Free MyMemory API (slower but works for all languages)
                </small>
            </div>

            <div class="config-input-group">
                <label for="ttsProvider">TTS Provider</label>
                <select id="ttsProvider" class="config-select">
                    <option value="browser">Browser Speech Synthesis (Free)</option>
                    <option value="openai">OpenAI TTS (Premium)</option>
                    <option value="elevenlabs">ElevenLabs (Premium)</option>
                    <option value="google">Google Cloud TTS (Premium)</option>
                </select>
            </div>

            <div class="config-input-group" id="openaiVoiceGroup" style="display:none;">
                <label for="openaiVoice">OpenAI Voice Style</label>
                <select id="openaiVoice" class="config-select">
                    <option value="alloy">Alloy (Neutral)</option>
                    <option value="echo">Echo (Male)</option>
                    <option value="fable">Fable (British Male)</option>
                    <option value="onyx">Onyx (Deep Male)</option>
                    <option value="nova">Nova (Female)</option>
                    <option value="shimmer">Shimmer (Soft Female)</option>
                </select>
            </div>

            <div class="config-input-group" id="ttsKeyGroup" style="display:none;">
                <label for="ttsKey">TTS API Key</label>
                <input type="password" id="ttsKey" class="config-input" placeholder="Enter API key">
            </div>

            <button class="config-btn" onclick="saveConfig()">Save Configuration</button>

            <div class="config-help">
                <strong>Need an API key?</strong><br>
                â€¢ OpenAI: <a href="https://platform.openai.com/api-keys" target="_blank">Get API Key</a><br>
                â€¢ Google Translate: <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Get API Key (âš¡ Fastest!)</a><br>
                â€¢ DeepL: <a href="https://www.deepl.com/pro-api" target="_blank">Get API Key (Free 500k chars/month)</a><br>
                â€¢ ElevenLabs: <a href="https://elevenlabs.io" target="_blank">Get API Key</a><br>
                â€¢ Google Cloud TTS: <a href="https://cloud.google.com/text-to-speech" target="_blank">Get API Key</a>
            </div>
        </div>
    </div>

    <div id="pain-assessment">
        <!-- PREMIUM HEADER -->
        <div class="assessment-header">
            <div class="header-left">
                <lottie-player class="lottie-icon" src="https://assets9.lottiefiles.com/packages/lf20_puciaact.json" background="transparent" speed="1" loop autoplay></lottie-player>
                <div class="header-text">
                    <h1 id="headerTitle">AI-Powered Pain Assessment</h1>
                    <p id="headerSubtitle">Real-time physiotherapy insights powered by GPT-4</p>
                </div>
            </div>
            <div class="header-controls">
                <button class="voice-toggle" id="voiceToggle" onclick="toggleVoice()">
                    <svg class="icon-svg" viewBox="0 0 24 24" id="voiceIcon">
                        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                    </svg>
                    <span class="voice-wave" id="voiceWave" style="display:none;">
                        <span></span>
                        <span></span>
                        <span></span>
                    </span>
                </button>
                <button class="voice-toggle" onclick="openConfig()" style="margin-left:0.5rem;">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                </button>
                <div class="language-selector">
                    <button class="lang-btn active" data-lang="en" onclick="switchLanguage('en')">EN</button>
                    <button class="lang-btn" data-lang="hi" onclick="switchLanguage('hi')">à¤¹à¤¿à¤‚</button>
                </div>
            </div>
        </div>

        <!-- PROGRESS -->
        <div class="progress-indicator">
            <div class="progress-steps">
                <div class="progress-line">
                    <div class="progress-line-fill" id="progressLineFill"></div>
                </div>
                <div class="progress-step active" data-step="1" onclick="goToStep(1)">
                    <div class="step-circle">1</div>
                    <div class="step-label" id="stepLabel1">Body Map</div>
                </div>
                <div class="progress-step" data-step="2" onclick="goToStep(2)">
                    <div class="step-circle">2</div>
                    <div class="step-label" id="stepLabel2">Duration</div>
                </div>
                <div class="progress-step" data-step="3" onclick="goToStep(3)">
                    <div class="step-circle">3</div>
                    <div class="step-label" id="stepLabel3">Impact</div>
                </div>
                <div class="progress-step" data-step="4" onclick="goToStep(4)">
                    <div class="step-circle">âœ“</div>
                    <div class="step-label" id="stepLabel4">Results</div>
                </div>
            </div>
        </div>

        <!-- MAIN CARD -->
        <div class="assessment-card">
            <!-- STEP 1: INTERACTIVE BODY MAP -->
            <div class="step-content active" id="step1">
                <h2 class="step-title" id="step1Title">Where does it hurt?</h2>
                <p class="step-description" id="step1Description">Click on your body to select the pain area and intensity</p>

                <div class="body-diagram-container">
                    <div class="body-svg-wrapper">
                        <!-- Pain Tooltip -->
                        <div class="pain-tooltip" id="painTooltip">
                            <div class="tooltip-title" id="tooltipTitle">Neck Pain</div>
                            <div class="tooltip-info" id="tooltipInfo">Common pain types:</div>
                            <div class="tooltip-types">
                                <span class="pain-type-badge">Muscle</span>
                                <span class="pain-type-badge">Joint</span>
                                <span class="pain-type-badge">Nerve</span>
                            </div>
                        </div>

                        <!-- Male Body SVG (default) -->
                        <svg class="body-svg" id="maleSvg" viewBox="0 0 200 400" xmlns="http://www.w3.org/2000/svg">
                            <!-- Head -->
                            <ellipse class="body-part" data-part="head" data-pain-types="Muscle,Nerve,Tension" cx="100" cy="30" rx="22" ry="27" onclick="selectBodyPart('head')" onmouseenter="showTooltip(event, 'head')" onmouseleave="hideTooltip()"/>

                            <!-- Neck -->
                            <rect class="body-part" data-part="neck" data-pain-types="Muscle,Joint,Nerve" x="88" y="57" width="24" height="28" rx="6" onclick="selectBodyPart('neck')" onmouseenter="showTooltip(event, 'neck')" onmouseleave="hideTooltip()"/>

                            <!-- Shoulders -->
                            <ellipse class="body-part" data-part="shoulder" data-pain-types="Muscle,Joint,Tendon" cx="70" cy="92" rx="20" ry="14" onclick="selectBodyPart('shoulder')" onmouseenter="showTooltip(event, 'shoulder')" onmouseleave="hideTooltip()"/>
                            <ellipse class="body-part" data-part="shoulder" data-pain-types="Muscle,Joint,Tendon" cx="130" cy="92" rx="20" ry="14" onclick="selectBodyPart('shoulder')" onmouseenter="showTooltip(event, 'shoulder')" onmouseleave="hideTooltip()"/>

                            <!-- Upper Back -->
                            <rect class="body-part" data-part="back" data-pain-types="Muscle,Disc,Nerve" x="82" y="97" width="36" height="40" rx="10" onclick="selectBodyPart('back')" onmouseenter="showTooltip(event, 'back')" onmouseleave="hideTooltip()"/>

                            <!-- Arms -->
                            <rect class="body-part" data-part="arm" data-pain-types="Muscle,Nerve" x="48" y="102" width="18" height="65" rx="9" onclick="selectBodyPart('arm')" onmouseenter="showTooltip(event, 'arm')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="arm" data-pain-types="Muscle,Nerve" x="134" y="102" width="18" height="65" rx="9" onclick="selectBodyPart('arm')" onmouseenter="showTooltip(event, 'arm')" onmouseleave="hideTooltip()"/>

                            <!-- Elbows -->
                            <circle class="body-part" data-part="elbow" data-pain-types="Joint,Tendon" cx="57" cy="167" r="11" onclick="selectBodyPart('elbow')" onmouseenter="showTooltip(event, 'elbow')" onmouseleave="hideTooltip()"/>
                            <circle class="body-part" data-part="elbow" data-pain-types="Joint,Tendon" cx="143" cy="167" r="11" onclick="selectBodyPart('elbow')" onmouseenter="showTooltip(event, 'elbow')" onmouseleave="hideTooltip()"/>

                            <!-- Lower Back -->
                            <rect class="body-part" data-part="back" data-pain-types="Muscle,Disc,Nerve" x="78" y="137" width="44" height="45" rx="12" onclick="selectBodyPart('back')" onmouseenter="showTooltip(event, 'back')" onmouseleave="hideTooltip()"/>

                            <!-- Hips -->
                            <ellipse class="body-part" data-part="hip" data-pain-types="Joint,Muscle" cx="78" cy="192" rx="18" ry="20" onclick="selectBodyPart('hip')" onmouseenter="showTooltip(event, 'hip')" onmouseleave="hideTooltip()"/>
                            <ellipse class="body-part" data-part="hip" data-pain-types="Joint,Muscle" cx="122" cy="192" rx="18" ry="20" onclick="selectBodyPart('hip')" onmouseenter="showTooltip(event, 'hip')" onmouseleave="hideTooltip()"/>

                            <!-- Thighs -->
                            <rect class="body-part" data-part="leg" data-pain-types="Muscle,Nerve" x="66" y="212" width="20" height="75" rx="10" onclick="selectBodyPart('leg')" onmouseenter="showTooltip(event, 'leg')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="leg" data-pain-types="Muscle,Nerve" x="114" y="212" width="20" height="75" rx="10" onclick="selectBodyPart('leg')" onmouseenter="showTooltip(event, 'leg')" onmouseleave="hideTooltip()"/>

                            <!-- Knees -->
                            <circle class="body-part" data-part="knee" data-pain-types="Joint,Cartilage,Ligament" cx="76" cy="290" r="14" onclick="selectBodyPart('knee')" onmouseenter="showTooltip(event, 'knee')" onmouseleave="hideTooltip()"/>
                            <circle class="body-part" data-part="knee" data-pain-types="Joint,Cartilage,Ligament" cx="124" cy="290" r="14" onclick="selectBodyPart('knee')" onmouseenter="showTooltip(event, 'knee')" onmouseleave="hideTooltip()"/>

                            <!-- Lower Legs -->
                            <rect class="body-part" data-part="leg" data-pain-types="Muscle,Nerve" x="68" y="304" width="16" height="72" rx="8" onclick="selectBodyPart('leg')" onmouseenter="showTooltip(event, 'leg')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="leg" data-pain-types="Muscle,Nerve" x="116" y="304" width="16" height="72" rx="8" onclick="selectBodyPart('leg')" onmouseenter="showTooltip(event, 'leg')" onmouseleave="hideTooltip()"/>

                            <!-- Ankles & Feet -->
                            <ellipse class="body-part" data-part="ankle" data-pain-types="Joint,Ligament" cx="76" cy="380" rx="11" ry="9" onclick="selectBodyPart('ankle')" onmouseenter="showTooltip(event, 'ankle')" onmouseleave="hideTooltip()"/>
                            <ellipse class="body-part" data-part="ankle" data-pain-types="Joint,Ligament" cx="124" cy="380" rx="11" ry="9" onclick="selectBodyPart('ankle')" onmouseenter="showTooltip(event, 'ankle')" onmouseleave="hideTooltip()"/>
                        </svg>

                        <!-- Female Body SVG (hidden by default) -->
                        <svg class="body-svg" id="femaleSvg" style="display:none;" viewBox="0 0 200 400" xmlns="http://www.w3.org/2000/svg">
                            <!-- Similar structure to male but with feminine proportions -->
                            <ellipse class="body-part" data-part="head" data-pain-types="Muscle,Nerve,Tension" cx="100" cy="30" rx="20" ry="26" onclick="selectBodyPart('head')" onmouseenter="showTooltip(event, 'head')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="neck" data-pain-types="Muscle,Joint,Nerve" x="90" y="56" width="20" height="26" rx="5" onclick="selectBodyPart('neck')" onmouseenter="showTooltip(event, 'neck')" onmouseleave="hideTooltip()"/>
                            <ellipse class="body-part" data-part="shoulder" data-pain-types="Muscle,Joint,Tendon" cx="72" cy="90" rx="18" ry="12" onclick="selectBodyPart('shoulder')" onmouseenter="showTooltip(event, 'shoulder')" onmouseleave="hideTooltip()"/>
                            <ellipse class="body-part" data-part="shoulder" data-pain-types="Muscle,Joint,Tendon" cx="128" cy="90" rx="18" ry="12" onclick="selectBodyPart('shoulder')" onmouseenter="showTooltip(event, 'shoulder')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="back" data-pain-types="Muscle,Disc,Nerve" x="84" y="95" width="32" height="38" rx="9" onclick="selectBodyPart('back')" onmouseenter="showTooltip(event, 'back')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="arm" data-pain-types="Muscle,Nerve" x="50" y="100" width="16" height="62" rx="8" onclick="selectBodyPart('arm')" onmouseenter="showTooltip(event, 'arm')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="arm" data-pain-types="Muscle,Nerve" x="134" y="100" width="16" height="62" rx="8" onclick="selectBodyPart('arm')" onmouseenter="showTooltip(event, 'arm')" onmouseleave="hideTooltip()"/>
                            <circle class="body-part" data-part="elbow" data-pain-types="Joint,Tendon" cx="58" cy="162" r="10" onclick="selectBodyPart('elbow')" onmouseenter="showTooltip(event, 'elbow')" onmouseleave="hideTooltip()"/>
                            <circle class="body-part" data-part="elbow" data-pain-types="Joint,Tendon" cx="142" cy="162" r="10" onclick="selectBodyPart('elbow')" onmouseenter="showTooltip(event, 'elbow')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="back" data-pain-types="Muscle,Disc,Nerve" x="80" y="133" width="40" height="42" rx="11" onclick="selectBodyPart('back')" onmouseenter="showTooltip(event, 'back')" onmouseleave="hideTooltip()"/>
                            <ellipse class="body-part" data-part="hip" data-pain-types="Joint,Muscle" cx="76" cy="186" rx="20" ry="22" onclick="selectBodyPart('hip')" onmouseenter="showTooltip(event, 'hip')" onmouseleave="hideTooltip()"/>
                            <ellipse class="body-part" data-part="hip" data-pain-types="Joint,Muscle" cx="124" cy="186" rx="20" ry="22" onclick="selectBodyPart('hip')" onmouseenter="showTooltip(event, 'hip')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="leg" data-pain-types="Muscle,Nerve" x="68" y="208" width="18" height="78" rx="9" onclick="selectBodyPart('leg')" onmouseenter="showTooltip(event, 'leg')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="leg" data-pain-types="Muscle,Nerve" x="114" y="208" width="18" height="78" rx="9" onclick="selectBodyPart('leg')" onmouseenter="showTooltip(event, 'leg')" onmouseleave="hideTooltip()"/>
                            <circle class="body-part" data-part="knee" data-pain-types="Joint,Cartilage,Ligament" cx="77" cy="288" r="13" onclick="selectBodyPart('knee')" onmouseenter="showTooltip(event, 'knee')" onmouseleave="hideTooltip()"/>
                            <circle class="body-part" data-part="knee" data-pain-types="Joint,Cartilage,Ligament" cx="123" cy="288" r="13" onclick="selectBodyPart('knee')" onmouseenter="showTooltip(event, 'knee')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="leg" data-pain-types="Muscle,Nerve" x="70" y="301" width="14" height="70" rx="7" onclick="selectBodyPart('leg')" onmouseenter="showTooltip(event, 'leg')" onmouseleave="hideTooltip()"/>
                            <rect class="body-part" data-part="leg" data-pain-types="Muscle,Nerve" x="116" y="301" width="14" height="70" rx="7" onclick="selectBodyPart('leg')" onmouseenter="showTooltip(event, 'leg')" onmouseleave="hideTooltip()"/>
                            <ellipse class="body-part" data-part="ankle" data-pain-types="Joint,Ligament" cx="77" cy="378" rx="10" ry="8" onclick="selectBodyPart('ankle')" onmouseenter="showTooltip(event, 'ankle')" onmouseleave="hideTooltip()"/>
                            <ellipse class="body-part" data-part="ankle" data-pain-types="Joint,Ligament" cx="123" cy="378" rx="10" ry="8" onclick="selectBodyPart('ankle')" onmouseenter="showTooltip(event, 'ankle')" onmouseleave="hideTooltip()"/>
                        </svg>
                    </div>

                    <div class="pain-intensity-selector">
                        <div class="intensity-title" id="intensityTitle">Pain Intensity</div>
                        <div class="intensity-levels">
                            <div class="intensity-level" data-level="mild" onclick="selectIntensity('mild')">
                                <div class="intensity-dot"></div>
                                <div class="intensity-text">
                                    <span class="intensity-label" id="intensityMild">Mild (1-3)</span>
                                    <span class="intensity-desc" id="intensityMildDesc">Noticeable but manageable</span>
                                </div>
                            </div>
                            <div class="intensity-level" data-level="moderate" onclick="selectIntensity('moderate')">
                                <div class="intensity-dot"></div>
                                <div class="intensity-text">
                                    <span class="intensity-label" id="intensityModerate">Moderate (4-6)</span>
                                    <span class="intensity-desc" id="intensityModerateDesc">Interferes with activities</span>
                                </div>
                            </div>
                            <div class="intensity-level" data-level="severe" onclick="selectIntensity('severe')">
                                <div class="intensity-dot"></div>
                                <div class="intensity-text">
                                    <span class="intensity-label" id="intensitySevere">Severe (7-10)</span>
                                    <span class="intensity-desc" id="intensitySevereDesc">Significantly limiting</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selected Parts Feedback Bar -->
                <div id="selectedPartsDisplay" class="selected-parts-bar"></div>
            </div>

            <!-- STEP 2: DURATION -->
            <div class="step-content" id="step2">
                <h2 class="step-title" id="step2Title">How long have you had this pain?</h2>
                <p class="step-description" id="step2Description">Understanding duration helps predict recovery time</p>
                <div class="options-grid">
                    <div class="option-card" data-duration="hours" onclick="selectDuration('hours')">
                        <div class="option-icon">
                            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                        </div>
                        <div class="option-text" id="durationHours">Few Hours</div>
                    </div>
                    <div class="option-card" data-duration="days" onclick="selectDuration('days')">
                        <div class="option-icon">
                            <svg viewBox="0 0 24 24"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>
                        </div>
                        <div class="option-text" id="durationDays">Few Days</div>
                    </div>
                    <div class="option-card" data-duration="weeks" onclick="selectDuration('weeks')">
                        <div class="option-icon">
                            <svg viewBox="0 0 24 24"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"/></svg>
                        </div>
                        <div class="option-text" id="durationWeeks">Few Weeks</div>
                    </div>
                    <div class="option-card" data-duration="months" onclick="selectDuration('months')">
                        <div class="option-icon">
                            <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg>
                        </div>
                        <div class="option-text" id="durationMonths">Months+</div>
                    </div>
                </div>
            </div>

            <!-- STEP 3: IMPACT -->
            <div class="step-content" id="step3">
                <h2 class="step-title" id="step3Title">How does it affect your daily life?</h2>
                <p class="step-description" id="step3Description">Provide detailed information about your pain</p>

                <!-- ENHANCED INPUT FIELDS -->
                <div class="enhanced-inputs">
                    <div class="input-row">
                        <div class="input-group">
                            <label class="input-label">Pain Frequency</label>
                            <select id="painFrequency" class="input-select">
                                <option value="">Select frequency</option>
                                <option value="occasional">Occasional (1-2 times/week)</option>
                                <option value="frequent">Frequent (3-5 times/week)</option>
                                <option value="constant">Constant (Daily/All day)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Pain Type</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="painType" value="dull">
                                    <span>Dull/Aching</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="painType" value="sharp">
                                    <span>Sharp/Stabbing</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="painType" value="throbbing">
                                    <span>Throbbing</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="painType" value="burning">
                                    <span>Burning/Tingling</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Duration in Months</label>
                        <div class="slider-container">
                            <input type="range" id="durationSlider" min="1" max="12" value="3" class="input-slider">
                            <div class="slider-value" id="durationValue">3 months</div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Activity Triggers (Check all that apply)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" name="activityTrigger" value="walking">
                                <span>Walking</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="activityTrigger" value="sitting">
                                <span>Sitting</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="activityTrigger" value="sleeping">
                                <span>Sleeping/Lying down</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="activityTrigger" value="exercise">
                                <span>Exercise/Physical activity</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="activityTrigger" value="standing">
                                <span>Standing</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="activityTrigger" value="bending">
                                <span>Bending/Lifting</span>
                            </label>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Additional Notes (Optional)</label>
                        <textarea id="additionalNotes" class="input-textarea" rows="3" placeholder="Any other symptoms, medications, or relevant information..."></textarea>
                    </div>
                </div>

                <h3 class="subsection-title" style="margin-top: 2rem;">How does it affect you?</h3>
                <p class="step-description">Select all activities that are difficult</p>
                <div class="options-grid">
                    <div class="option-card" data-activity="work" onclick="toggleActivity('work')">
                        <div class="option-icon">
                            <svg viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>
                        </div>
                        <div class="option-text" id="activityWork">Work/Study</div>
                    </div>
                    <div class="option-card" data-activity="exercise" onclick="toggleActivity('exercise')">
                        <div class="option-icon">
                            <svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z"/></svg>
                        </div>
                        <div class="option-text" id="activityExercise">Exercise</div>
                    </div>
                    <div class="option-card" data-activity="sleep" onclick="toggleActivity('sleep')">
                        <div class="option-icon">
                            <svg viewBox="0 0 24 24"><path d="M9 11.75c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zm6 0c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.29.02-.58.05-.86 2.36-1.05 4.23-2.98 5.21-5.37C11.07 8.33 14.05 10 17.42 10c.78 0 1.53-.09 2.25-.26.21.71.33 1.47.33 2.26 0 4.41-3.59 8-8 8z"/></svg>
                        </div>
                        <div class="option-text" id="activitySleep">Sleep</div>
                    </div>
                    <div class="option-card" data-activity="daily" onclick="toggleActivity('daily')">
                        <div class="option-icon">
                            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                        </div>
                        <div class="option-text" id="activityDaily">Daily Tasks</div>
                    </div>
                </div>

                <!-- AI-POWERED IMPACT SECTION -->
                <div id="aiImpactContainer" class="ai-impact-container"></div>
            </div>

            <!-- LOADING -->
            <div class="loading-analysis" id="loadingScreen">
                <lottie-player class="loading-lottie" src="https://assets8.lottiefiles.com/packages/lf20_p8bfn5to.json" background="transparent" speed="1" loop autoplay></lottie-player>
                <div class="loading-text" id="loadingText">Analyzing Your Pain Profile...</div>
                <div class="loading-subtext" id="loadingSubtext">Our AI is processing your assessment with GPT-4</div>
            </div>

            <!-- AI CHAT RESULTS -->
            <div class="ai-chat-results" id="aiResults">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be dynamically inserted -->
                </div>

                <!-- TYPING INDICATOR (shown between messages) -->
                <div class="typing-indicator" id="typingIndicator" style="display:none;">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <span style="margin-left:0.5rem;color:var(--text-secondary);">AI is thinking...</span>
                </div>

                <!-- ENHANCED REHAB PLAN SECTION -->
                <div class="rehab-plan-container" id="rehabPlanContainer" style="display:none;">
                    <div class="rehab-plan-header">
                        <div class="rehab-header-content">
                            <svg class="rehab-icon" viewBox="0 0 24 24">
                                <path d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z"/>
                            </svg>
                            <div>
                                <h3 class="rehab-title" id="rehabTitle">AI-Generated Rehabilitation Plan</h3>
                                <p class="rehab-subtitle" id="rehabSubtitle">Personalized exercises tailored to your condition</p>
                            </div>
                        </div>
                        <div class="rehab-header-actions">
                            <button class="rehab-action-btn" onclick="regenerateRehabPlan()" title="Regenerate Plan">
                                <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:currentColor;">
                                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                                </svg>
                            </button>
                            <select class="difficulty-selector" id="difficultySelector" onchange="updateRehabDifficulty(this.value)">
                                <option value="beginner" id="difficultyBeginner">Beginner</option>
                                <option value="intermediate" selected id="difficultyIntermediate">Intermediate</option>
                                <option value="advanced" id="difficultyAdvanced">Advanced</option>
                            </select>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="rehab-progress-container">
                        <div class="progress-label">
                            <span id="progressText">Completion Progress</span>
                            <span class="progress-percentage" id="progressPercentage">0%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
                        </div>
                    </div>

                    <!-- Exercises Grid -->
                    <div class="exercises-grid" id="exercisesGrid">
                        <!-- Exercises will be dynamically inserted -->
                    </div>

                    <!-- Action Buttons -->
                    <div class="rehab-actions">
                        <button class="rehab-btn btn-primary-rehab" onclick="downloadRehabPlan()">
                            <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:white;">
                                <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                            </svg>
                            <span id="downloadPlanText">Download Plan (PDF)</span>
                        </button>
                        <button class="rehab-btn btn-secondary-rehab" onclick="shareRehabPlan()">
                            <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:currentColor;">
                                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                            </svg>
                            <span id="sharePlanText">Share Plan</span>
                        </button>
                    </div>

                    <!-- AI Connection Notice -->
                    <div class="ai-connect-notice" id="aiConnectNotice" style="display:none;">
                        <svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:var(--warning);margin-right:8px;">
                            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                        </svg>
                        <span id="aiConnectNoticeText">Connect AI to personalize your rehab plan with advanced recommendations.</span>
                        <button class="connect-ai-btn" onclick="openConfig()">
                            <span id="connectAIText">Connect AI</span>
                        </button>
                    </div>
                </div>

                <!-- SUMMARY CARD -->
                <div class="summary-card" id="summaryCard" style="display:none;">
                    <div class="summary-header">
                        <h3 class="summary-title">Assessment Summary</h3>
                        <span class="summary-date" id="summaryDate"></span>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">Affected Area</div>
                            <div class="summary-value" id="summaryArea">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Pain Level</div>
                            <div class="summary-value" id="summaryLevel">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Duration</div>
                            <div class="summary-value" id="summaryDuration">-</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Recovery Estimate</div>
                            <div class="summary-value" id="summaryRecovery">-</div>
                        </div>
                    </div>
                    <div class="summary-actions">
                        <button class="summary-btn btn-download" onclick="downloadPDF()">
                            <svg class="icon-svg" viewBox="0 0 24 24" style="fill:white;">
                                <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                            </svg>
                            Download PDF
                        </button>
                        <button class="summary-btn btn-share" onclick="shareWithDoctor()">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                            </svg>
                            Share with Doctor
                        </button>
                    </div>
                </div>

                <!-- CHART.JS VISUALIZATIONS -->
                <div class="chart-container" id="recoveryChart" style="display:none;">
                    <h3 class="chart-title">Recovery Forecast</h3>
                    <div class="chart-wrapper">
                        <canvas id="forecastCanvas"></canvas>
                    </div>
                </div>

                <div class="chart-container" id="confidenceChart" style="display:none;">
                    <h3 class="chart-title">Analysis Confidence</h3>
                    <div class="chart-wrapper">
                        <canvas id="confidenceCanvas"></canvas>
                    </div>
                </div>

                <!-- DAILY TIPS -->
                <div class="daily-tips" id="dailyTips" style="display:none;">
                    <h3 class="message-title">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="fill:var(--primary);">
                            <path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/>
                        </svg>
                        Personalized Daily Tips
                    </h3>
                    <div class="tips-grid" id="tipsGrid">
                        <!-- Tips will be dynamically inserted -->
                    </div>
                </div>

                <!-- CONVERSATIONAL FOLLOW-UP CHAT -->
                <div class="follow-up-section" id="followUpSection" style="display:none;">
                    <div class="follow-up-title">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width:20px;height:20px;vertical-align:middle;margin-right:8px;fill:var(--primary);">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                        </svg>
                        Ask AI a Follow-up Question
                    </div>
                    <div class="follow-up-chat-container" id="followUpChatContainer">
                        <!-- Chat messages will be dynamically inserted here -->
                    </div>
                    <div class="follow-up-input-group">
                        <button class="mic-btn" id="micBtn" onclick="startVoiceInput()" title="Voice Input">
                            <svg class="icon-svg" viewBox="0 0 24 24" style="fill:var(--primary);">
                                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                            </svg>
                        </button>
                        <input type="text" class="follow-up-input" id="followUpInput" placeholder="e.g., What exercises should I do?" onkeypress="if(event.key==='Enter') askFollowUp()">
                        <button class="follow-up-btn" onclick="askFollowUp()">
                            <svg class="icon-svg" viewBox="0 0 24 24" style="fill:white;">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- FEEDBACK -->
                <div class="feedback-section" id="feedbackSection" style="display:none;">
                    <div class="feedback-title" id="feedbackTitle">Was this analysis helpful?</div>
                    <div class="feedback-buttons">
                        <button class="feedback-btn" onclick="submitFeedback('yes')">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/>
                            </svg>
                            <span id="feedbackYes">Yes, very helpful</span>
                        </button>
                        <button class="feedback-btn" onclick="submitFeedback('no')">
                            <svg class="icon-svg" viewBox="0 0 24 24">
                                <path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/>
                            </svg>
                            <span id="feedbackNo">Needs improvement</span>
                        </button>
                    </div>
                    <div class="feedback-message" id="feedbackMessage" style="display:none;color:var(--success);margin-top:1rem;font-weight:600;">Thank you for your feedback!</div>
                </div>
            </div>

            <!-- NAVIGATION -->
            <div class="nav-buttons">
                <button class="btn btn-secondary" id="backBtn" onclick="previousStep()" style="display: none;">
                    <svg class="icon-svg" viewBox="0 0 24 24" style="fill:currentColor;">
                        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
                    </svg>
                    <span id="backBtnText">Back</span>
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextStep()" disabled>
                    <span id="nextBtnText">Continue</span>
                    <svg class="icon-svg" viewBox="0 0 24 24" style="fill:white;">
                        <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================================================
        // PRODUCTION CONFIGURATION
        // ========================================================================
        const PRODUCTION_MODE = true; // Set to false for development
        const DEBUG_ENABLED = !PRODUCTION_MODE;

        // Production-ready logger
        const logger = {
            log: (...args) => DEBUG_ENABLED && console.log(...args),
            info: (...args) => DEBUG_ENABLED && console.info(...args),
            warn: (...args) => console.warn(...args), // Always show warnings
            error: (...args) => console.error(...args) // Always show errors
        };

        // Performance optimization: Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Performance optimization: Throttle utility
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // ========================================================================
        // STATE MANAGEMENT
        // ========================================================================
        let assessmentData = {
            bodyPart: null,  // Keep for backward compatibility (first selected part)
            selectedParts: [],  // NEW: Track multiple selected body parts
            intensity: null,
            intensityLabel: 'moderate',
            duration: null,
            activities: [],
            painFrequency: '',
            painType: '',
            durationMonths: 3,
            activityTriggers: [],
            additionalNotes: '',
            currentStep: 1,
            totalSteps: 4,
            currentLanguage: 'en',
            voiceEnabled: false,
            gender: 'male',
            sessionId: generateSessionId(),
            timestamp: new Date().toISOString(),
            aiResponse: null,
            aiMessages: []
        };

        // TRANSLATIONS SYSTEM - Loaded from external translations.js file
        // TRANSLATIONS object is now available globally

        /**
         * SIMPLIFIED LANGUAGE SYSTEM
         * - Two fixed languages: English, Hindi
         * - No third regional language
         * - Translations generated on-demand when user switches language
         * - Clean and reliable
         */
        let regionalLanguage = null;  // No third language
        let regionalLanguageName = '';  // No regional button

        // Language names mapping for readable labels
        const LANGUAGE_NAMES = {
            'en': 'English',
            'hi': 'à¤¹à¤¿à¤‚à¤¦à¥€',
            'mr': 'à¤®à¤°à¤¾à¤ à¥€',
            'ta': 'à®¤à®®à®¿à®´à¯',
            'gu': 'àª—à«àªœàª°àª¾àª¤à«€',
            'kn': 'à²•à²¨à³à²¨à²¡',
            'te': 'à°¤à±†à°²à±à°—à±',
            'bn': 'à¦¬à¦¾à¦‚à¦²à¦¾',
            'ml': 'à´®à´²à´¯à´¾à´³à´‚',
            'pa': 'à¨ªà©°à¨œà¨¾à¨¬à©€',
            'ar': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
            'es': 'EspaÃ±ol',
            'fr': 'FranÃ§ais',
            'de': 'Deutsch',
            'pt': 'PortuguÃªs',
            'ru': 'Ð ÑƒÑÑÐºÐ¸Ð¹',
            'zh': 'ä¸­æ–‡',
            'ja': 'æ—¥æœ¬èªž',
            'ko': 'í•œêµ­ì–´'
        };

        /**
         * REMOVED: Complex IP-based language detection
         * Now using simple fixed languages: EN, HI, MR
         * Users can manually switch between them as needed
         */

        /**
         * TRANSLATION CACHE - Store translations in localStorage
         */
        function getCachedTranslation(text, lang) {
            try {
                const cacheKey = `trans_${lang}_${text.substring(0, 50)}`; // Use first 50 chars for key
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    return cached;
                }
            } catch (err) {
                // Ignore cache errors
            }
            return null;
        }

        function setCachedTranslation(text, lang, translation) {
            try {
                const cacheKey = `trans_${lang}_${text.substring(0, 50)}`;
                localStorage.setItem(cacheKey, translation);
            } catch (err) {
                // Ignore cache errors (quota exceeded, etc.)
            }
        }

        /**
         * HYBRID TRANSLATION ENGINE with Caching & Smart Fallback
         * 1. Check localStorage cache first
         * 2. Try DeepL (if supported and key configured)
         * 3. Try MyMemory primary endpoint
         * 4. Try MyMemory alternative endpoint on rate limit
         * 5. Return English as final fallback
         */
        /**
         * Translate using Google Translate API (optional fast path)
         */
        async function translateTextGoogle(text, targetLang) {
            const googleKey = localStorage.getItem('google_translate_api_key');
            if (!googleKey) return null;

            try {
                const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${googleKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        q: text,
                        target: targetLang,
                        source: 'en'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.data && data.data.translations && data.data.translations[0]) {
                        return data.data.translations[0].translatedText;
                    }
                }
            } catch (err) {
                // Silent fail
            }
            return null;
        }

        /**
         * ULTRA-FAST Translation with retry logic (2Ã— retry, 300ms gap)
         */
        async function translateTextSmart(text, targetLang, maxRetries = 2) {
            // Check cache first (instant!)
            const cached = getCachedTranslation(text, targetLang);
            if (cached) {
                return cached;
            }

            const deeplKey = localStorage.getItem('deepl_api_key');
            const googleKey = localStorage.getItem('google_translate_api_key');

            // DeepL supported languages (API doesn't support Arabic, Hindi, Chinese, etc.)
            const deeplSupported = ['de', 'es', 'fr', 'it', 'pt', 'nl', 'pl', 'ru', 'tr', 'bg', 'cs', 'da', 'el', 'et', 'fi', 'hu', 'id', 'lt', 'lv', 'ro', 'sk', 'sl', 'sv', 'uk', 'nb'];
            const isDeeplSupported = deeplSupported.includes(targetLang.toLowerCase());

            // Try Google Translate first if available (fastest!)
            if (googleKey) {
                const googleResult = await translateTextGoogle(text, targetLang);
                if (googleResult) {
                    setCachedTranslation(text, targetLang, googleResult);
                    return googleResult;
                }
            }

            // Try DeepL for supported languages
            if (deeplKey && isDeeplSupported) {
                for (let retry = 0; retry < maxRetries; retry++) {
                    try {
                        const response = await fetch('https://api-free.deepl.com/v2/translate', {
                            method: 'POST',
                            headers: {
                                'Authorization': `DeepL-Auth-Key ${deeplKey}`,
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: `text=${encodeURIComponent(text)}&target_lang=${targetLang.toUpperCase()}`
                        });

                        if (response.ok) {
                            const data = await response.json();
                            if (data.translations && data.translations[0] && data.translations[0].text) {
                                const translated = data.translations[0].text;
                                if (translated !== text) {
                                    setCachedTranslation(text, targetLang, translated);
                                    return translated;
                                }
                            }
                        }
                        // If DeepL returns empty or same text, immediately fall through to MyMemory
                        break;
                    } catch (err) {
                        if (retry < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }
                }
            }

            // MyMemory API with smart endpoint fallback and retry (300ms delay)
            const myMemoryEndpoints = [
                'https://api.mymemory.translated.net/get',
                'https://translated-mymemory---api.herokuapp.com/get'
            ];

            for (const endpoint of myMemoryEndpoints) {
                for (let retry = 0; retry < maxRetries; retry++) {
                    try {
                        const url = `${endpoint}?q=${encodeURIComponent(text)}&langpair=en|${targetLang}`;
                        const response = await fetch(url);

                        if (response.status === 429 && retry < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                            continue;
                        }

                        if (response.ok) {
                            const data = await response.json();
                            if (data.responseData && data.responseData.translatedText) {
                                const translated = data.responseData.translatedText;
                                setCachedTranslation(text, targetLang, translated);
                                return translated;
                            }
                        }
                        break;
                    } catch (err) {
                        if (retry < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }
                }
            }

            // Final fallback - return original English text
            return text;
        }

        /**
         * TASK POOL LIMITER - Manages max 5 concurrent API calls
         * Prevents browser throttling and keeps UI responsive
         */
        /**
         * STREAMING TRANSLATION QUEUE
         * - Async generator that yields results as they complete
         * - Max 5 concurrent API calls with backpressure
         * - Non-blocking, real-time progress updates
         * - Smooth progress animation via requestAnimationFrame
         */
        async function* streamingTranslationQueue(tasks, limit = 5) {
            const executing = new Set();
            const taskIterator = tasks[Symbol.iterator]();
            let completedCount = 0;

            // Start initial batch
            while (executing.size < limit) {
                const { value: task, done } = taskIterator.next();
                if (done) break;

                const promise = (async () => {
                    try {
                        const result = await task();
                        return { success: true, result };
                    } catch (error) {
                        return { success: false, error };
                    }
                })();

                // Track with cleanup
                promise.finally(() => executing.delete(promise));
                executing.add(promise);
            }

            // Stream results as they complete
            while (executing.size > 0) {
                const completed = await Promise.race(executing);
                completedCount++;

                // Yield result immediately for smooth progress
                yield { ...completed, completedCount };

                // Start next task if available
                const { value: nextTask, done } = taskIterator.next();
                if (!done) {
                    const promise = (async () => {
                        try {
                            const result = await nextTask();
                            return { success: true, result };
                        } catch (error) {
                            return { success: false, error };
                        }
                    })();

                    promise.finally(() => executing.delete(promise));
                    executing.add(promise);
                }
            }
        }

        /**
         * ULTRA-SMOOTH PROGRESS ANIMATOR
         * - Uses requestAnimationFrame for 60fps updates
         * - Smooth interpolation to target progress
         * - No chunky jumps
         */
        class SmoothProgressAnimator {
            constructor(callback) {
                this.callback = callback;
                this.currentProgress = 0;
                this.targetProgress = 0;
                this.animating = false;
                this.rafId = null;
            }

            setTarget(progress) {
                this.targetProgress = Math.min(100, Math.max(0, progress));
                if (!this.animating) {
                    this.startAnimation();
                }
            }

            startAnimation() {
                this.animating = true;
                const animate = () => {
                    // Smooth interpolation (ease-out)
                    const diff = this.targetProgress - this.currentProgress;
                    if (Math.abs(diff) < 0.1) {
                        this.currentProgress = this.targetProgress;
                        this.callback(Math.round(this.currentProgress));
                        this.animating = false;
                        return;
                    }

                    this.currentProgress += diff * 0.2; // Smooth easing
                    this.callback(Math.round(this.currentProgress));
                    this.rafId = requestAnimationFrame(animate);
                };
                this.rafId = requestAnimationFrame(animate);
            }

            complete() {
                this.setTarget(100);
                if (this.rafId) {
                    cancelAnimationFrame(this.rafId);
                }
            }
        }

        /**
         * STREAMING TRANSLATION ENGINE
         * - Yields results as they complete (not waiting for all)
         * - Smooth 60fps progress animation
         * - Max 5 concurrent API calls
         * - Completes in <5 seconds for ~130 strings
         */
        async function generateDynamicTranslation(langCode, progressCallback) {
            const startTime = Date.now();
            const hasGoogle = localStorage.getItem('google_translate_api_key');
            const hasDeepL = localStorage.getItem('deepl_api_key');
            const languageName = getLanguageName(langCode);

            console.log(`ðŸš€ STREAMING translation for: ${languageName} (${langCode})`);
            if (hasGoogle) {
                console.log('âš¡ Using Google Translate API (fastest!)');
            } else if (hasDeepL) {
                console.log('âš¡ Using DeepL API with MyMemory fallback');
            } else {
                console.log('ðŸŒ Using MyMemory API (free)');
            }

            try {
                // Get English translations as base
                const englishTranslations = typeof TRANSLATIONS !== 'undefined' ? TRANSLATIONS.en : {};

                if (!englishTranslations || Object.keys(englishTranslations).length === 0) {
                    console.error('âŒ No English translations found as base');
                    return null;
                }

                const keys = Object.keys(englishTranslations);
                const totalKeys = keys.length;

                console.log(`âš¡ Starting streaming queue (max 5 concurrent)...`);
                console.log(`ðŸ“ Total: ${totalKeys} strings to translate`);

                const translated = {};

                // Setup smooth progress animator
                const progressAnimator = progressCallback
                    ? new SmoothProgressAnimator(progressCallback)
                    : null;

                // Create translation tasks
                const tasks = keys.map(key => async () => {
                    const englishText = englishTranslations[key];

                    // Skip empty strings
                    if (!englishText || englishText.trim() === '') {
                        return { key, translatedText: englishText };
                    }

                    // Use hybrid translation function
                    try {
                        const translatedText = await translateTextSmart(englishText, langCode);
                        return { key, translatedText };
                    } catch (err) {
                        console.warn(`âš ï¸ Translation failed for key "${key}":`, err.message);
                        return { key, translatedText: englishText };
                    }
                });

                // Stream results as they complete
                let processedCount = 0;
                for await (const { success, result, completedCount } of streamingTranslationQueue(tasks, 5)) {
                    if (success && result) {
                        const { key, translatedText } = result;
                        translated[key] = translatedText;
                        processedCount++;

                        // Update smooth progress
                        const progress = (completedCount / totalKeys) * 100;
                        if (progressAnimator) {
                            progressAnimator.setTarget(progress);
                        }

                        // Log progress every 10%
                        if (completedCount % Math.ceil(totalKeys / 10) === 0) {
                            console.log(`âš¡ Progress: ${completedCount}/${totalKeys} (${Math.round(progress)}%)`);
                        }
                    }
                }

                // Ensure progress reaches 100%
                if (progressAnimator) {
                    progressAnimator.complete();
                }

                const duration = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`âœ… STREAMING translation complete in ${duration}s for ${languageName}!`);
                console.log(`ðŸ“Š Total: ${processedCount}/${totalKeys} strings translated`);
                console.log(`ðŸ’¾ All cached in localStorage for instant reuse`);

                // Store in TRANSLATIONS object
                if (typeof TRANSLATIONS !== 'undefined') {
                    TRANSLATIONS[langCode] = translated;
                    console.log(`âœ… Stored ${langCode} translations in TRANSLATIONS object`);
                } else {
                    console.warn('âš ï¸ TRANSLATIONS object not available');
                }

                return translated;

            } catch (error) {
                console.error('âŒ Translation generation failed:', error);
                return null;
            }
        }

        /**
         * Get human-readable language name from code
         */
        function getLanguageName(langCode) {
            const languageNames = {
                'en': 'English',
                'hi': 'Hindi',
                'ta': 'Tamil',
                'gu': 'Gujarati',
                'mr': 'Marathi',
                'es': 'Spanish',
                'fr': 'French',
                'de': 'German',
                'it': 'Italian',
                'pt': 'Portuguese',
                'ja': 'Japanese',
                'ko': 'Korean',
                'zh': 'Chinese',
                'ar': 'Arabic',
                'ru': 'Russian',
                'tr': 'Turkish',
                'pl': 'Polish',
                'nl': 'Dutch',
                'sv': 'Swedish',
                'da': 'Danish',
                'fi': 'Finnish',
                'no': 'Norwegian',
                'cs': 'Czech',
                'ro': 'Romanian',
                'bg': 'Bulgarian',
                'el': 'Greek',
                'he': 'Hebrew',
                'th': 'Thai',
                'vi': 'Vietnamese',
                'id': 'Indonesian',
                'ms': 'Malay',
                'uk': 'Ukrainian',
                'hu': 'Hungarian',
                'sk': 'Slovak'
            };
            return languageNames[langCode] || langCode.toUpperCase();
        }

        /**
         * SIMPLIFIED: Initialize language system
         * Two fixed languages: English, Hindi
         * Translations generated on-demand when user switches
         */
        async function initializeLanguageSystem() {
            logger.log('ðŸš€ Initializing language system (EN, HI)');

            // Set default language to English
            if (!assessmentData.currentLanguage) {
                assessmentData.currentLanguage = 'en';
            }

            // Check saved preference (only en or hi)
            const savedLang = localStorage.getItem('preferred_language');
            if (savedLang && ['en', 'hi'].includes(savedLang)) {
                assessmentData.currentLanguage = savedLang;
                logger.log('âœ… Loaded language preference:', savedLang);
            } else if (savedLang) {
                // Reset any other language to English
                logger.warn('âš ï¸ Invalid saved language:', savedLang, '- resetting to English');
                assessmentData.currentLanguage = 'en';
                localStorage.setItem('preferred_language', 'en');
            }

            // Setup language buttons (will show EN and HI only)
            setupLanguages();
            logger.log('âœ… Language system ready');
        }

        // CONTEXT MATRIX - Comprehensive body-part specific configuration
        const CONTEXT_MATRIX = {
            knee: {
                duration: {
                    options: ['1-2 weeks', '2-4 weeks', '1-3 months', '3-6 months', '6+ months'],
                    contextQuestions: [
                        { label: 'Does it hurt when climbing stairs?', type: 'radio', options: ['Yes', 'No', 'Sometimes'] },
                        { label: 'Do you hear any clicking or popping sounds?', type: 'radio', options: ['Yes', 'No', 'Occasionally'] },
                        { label: 'Is there swelling around the knee?', type: 'radio', options: ['Yes', 'No', 'Mild swelling'] }
                    ]
                },
                activities: ['Walking', 'Running', 'Climbing stairs', 'Squatting', 'Standing for long periods']
            },
            back: {
                duration: {
                    options: ['Less than 1 week', '1-4 weeks', '1-3 months', '3-6 months', 'Chronic (6+ months)'],
                    contextQuestions: [
                        { label: 'Does the pain radiate to your legs?', type: 'radio', options: ['Yes', 'No', 'Sometimes'] },
                        { label: 'Is it worse in the morning?', type: 'radio', options: ['Yes', 'No', 'About the same'] },
                        { label: 'Does coughing or sneezing increase the pain?', type: 'radio', options: ['Yes', 'No', 'Slightly'] }
                    ]
                },
                activities: ['Sitting', 'Standing', 'Bending', 'Lifting objects', 'Sleeping']
            },
            shoulder: {
                duration: {
                    options: ['1-2 weeks', '2-4 weeks', '1-3 months', '3-6 months', '6+ months'],
                    contextQuestions: [
                        { label: 'Can you raise your arm above your head?', type: 'radio', options: ['Yes', 'No', 'With difficulty'] },
                        { label: 'Do you feel weakness in the shoulder?', type: 'radio', options: ['Yes', 'No', 'Sometimes'] },
                        { label: 'Is there pain at night?', type: 'radio', options: ['Yes', 'No', 'Occasionally'] }
                    ]
                },
                activities: ['Reaching overhead', 'Lifting objects', 'Carrying bags', 'Sleeping on that side', 'Throwing motions']
            },
            neck: {
                duration: {
                    options: ['1-2 days', '3-7 days', '1-4 weeks', '1-3 months', '3+ months'],
                    contextQuestions: [
                        { label: 'Do you have headaches associated with neck pain?', type: 'radio', options: ['Yes', 'No', 'Sometimes'] },
                        { label: 'Does the pain radiate to your arms?', type: 'radio', options: ['Yes', 'No', 'Occasionally'] },
                        { label: 'Is it difficult to turn your head?', type: 'radio', options: ['Yes', 'No', 'Slightly'] }
                    ]
                },
                activities: ['Looking at phone/computer', 'Driving', 'Reading', 'Sleeping', 'Turning head']
            },
            wrist: {
                duration: {
                    options: ['1-3 days', '4-7 days', '1-2 weeks', '2-4 weeks', '1+ month'],
                    contextQuestions: [
                        { label: 'Do you have numbness or tingling in your fingers?', type: 'radio', options: ['Yes', 'No', 'Sometimes'] },
                        { label: 'Is grip strength affected?', type: 'radio', options: ['Yes', 'No', 'Slightly'] },
                        { label: 'Does typing or writing increase pain?', type: 'radio', options: ['Yes', 'No', 'Moderately'] }
                    ]
                },
                activities: ['Typing', 'Writing', 'Gripping objects', 'Using phone', 'Lifting items']
            },
            ankle: {
                duration: {
                    options: ['1-3 days', '4-7 days', '1-2 weeks', '2-4 weeks', '1+ month'],
                    contextQuestions: [
                        { label: 'Did you injure your ankle recently?', type: 'radio', options: ['Yes', 'No', 'Not sure'] },
                        { label: 'Is there visible swelling or bruising?', type: 'radio', options: ['Yes', 'No', 'Mild'] },
                        { label: 'Can you bear weight on it?', type: 'radio', options: ['Yes', 'No', 'With difficulty'] }
                    ]
                },
                activities: ['Walking', 'Running', 'Climbing stairs', 'Standing', 'Sports activities']
            },
            hip: {
                duration: {
                    options: ['1-2 weeks', '2-4 weeks', '1-3 months', '3-6 months', '6+ months'],
                    contextQuestions: [
                        { label: 'Does the pain radiate to the groin?', type: 'radio', options: ['Yes', 'No', 'Sometimes'] },
                        { label: 'Is it difficult to put on shoes/socks?', type: 'radio', options: ['Yes', 'No', 'Slightly'] },
                        { label: 'Do you hear clicking sounds from the hip?', type: 'radio', options: ['Yes', 'No', 'Occasionally'] }
                    ]
                },
                activities: ['Walking', 'Climbing stairs', 'Sitting for long periods', 'Getting up from sitting', 'Lying on that side']
            }
        };

        // IMPACT MATRIX - Body-part specific impact questions
        const IMPACT_MATRIX = {
            knee: {
                mild: { title: 'Mild Discomfort', description: 'Slight stiffness, manageable with rest', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Difficulty with stairs and prolonged standing', icon: 'alert-triangle' },
                severe: { title: 'Severe Limitation', description: 'Walking is painful, daily activities affected', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Unable to bear weight, needs immediate attention', icon: 'alert-octagon' }
            },
            back: {
                mild: { title: 'Mild Ache', description: 'Occasional discomfort when sitting/standing', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Affects bending, lifting, and daily tasks', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Radiating pain, difficulty with movement', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Immobilizing pain, neurological symptoms', icon: 'alert-octagon' }
            },
            shoulder: {
                mild: { title: 'Mild Stiffness', description: 'Limited overhead reach, manageable', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Difficulty with dressing and carrying', icon: 'alert-triangle' },
                severe: { title: 'Severe Restriction', description: 'Cannot lift arm, nighttime pain', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Frozen shoulder, severe weakness', icon: 'alert-octagon' }
            },
            neck: {
                mild: { title: 'Mild Stiffness', description: 'Slight discomfort turning head', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Headaches, difficulty driving', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Radiating pain to arms, constant discomfort', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Severe headaches, numbness, tingling', icon: 'alert-octagon' }
            },
            wrist: {
                mild: { title: 'Mild Ache', description: 'Slight discomfort with gripping', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Difficulty typing, writing, gripping', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Constant pain, weakness, numbness', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Unable to use hand, severe weakness', icon: 'alert-octagon' }
            },
            ankle: {
                mild: { title: 'Mild Discomfort', description: 'Slight pain when walking', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Swelling, difficulty with stairs', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Significant swelling, limited mobility', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Cannot bear weight, severe instability', icon: 'alert-octagon' }
            },
            hip: {
                mild: { title: 'Mild Ache', description: 'Occasional discomfort with movement', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Difficulty with stairs, getting up', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Constant pain, limping, limited range', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Unable to walk, severe stiffness', icon: 'alert-octagon' }
            },
            head: {
                mild: { title: 'Mild Headache', description: 'Occasional discomfort, manageable', icon: 'check-circle' },
                moderate: { title: 'Moderate Headache', description: 'Frequent pain, affects concentration', icon: 'alert-triangle' },
                severe: { title: 'Severe Headache', description: 'Constant pain, light/sound sensitivity', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Debilitating migraines, vision changes', icon: 'alert-octagon' }
            },
            arm: {
                mild: { title: 'Mild Discomfort', description: 'Slight ache during movement', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Difficulty lifting objects, reaching', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Constant pain, weakness, limited use', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Cannot use arm, severe weakness', icon: 'alert-octagon' }
            },
            elbow: {
                mild: { title: 'Mild Stiffness', description: 'Slight discomfort bending arm', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Tennis/golfer elbow symptoms', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Constant pain, gripping difficulty', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Unable to bend arm, severe inflammation', icon: 'alert-octagon' }
            },
            leg: {
                mild: { title: 'Mild Ache', description: 'Slight discomfort when walking', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Difficulty with stairs, running', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Walking is painful, frequent resting', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Cannot walk properly, severe weakness', icon: 'alert-octagon' }
            },
            hand: {
                mild: { title: 'Mild Discomfort', description: 'Slight pain with fine movements', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Difficulty gripping, writing, typing', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Constant pain, swelling, numbness', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Cannot use hand, severe dysfunction', icon: 'alert-octagon' }
            },
            foot: {
                mild: { title: 'Mild Discomfort', description: 'Slight pain when walking', icon: 'check-circle' },
                moderate: { title: 'Moderate Pain', description: 'Difficulty standing, heel pain', icon: 'alert-triangle' },
                severe: { title: 'Severe Pain', description: 'Walking is painful, swelling present', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Cannot bear weight, severe dysfunction', icon: 'alert-octagon' }
            },
            // Default for other body parts
            default: {
                mild: { title: 'Mild', description: 'Slightly annoying', icon: 'check-circle' },
                moderate: { title: 'Moderate', description: 'Affects some activities', icon: 'alert-triangle' },
                severe: { title: 'Severe', description: 'Significantly limits daily life', icon: 'alert-circle' },
                critical: { title: 'Critical', description: 'Unable to perform basic tasks', icon: 'alert-octagon' }
            }
        };

        // API Configuration for OpenAI and TTS
        let API_CONFIG = {
            openai: {
                key: localStorage.getItem('openai_api_key') || '',
                model: 'gpt-4o-mini',
                endpoint: 'https://api.openai.com/v1/chat/completions'
            },
            whisper: {
                endpoint: 'https://api.openai.com/v1/audio/transcriptions',
                model: 'whisper-1'
            },
            tts: {
                provider: localStorage.getItem('tts_provider') || 'browser',
                key: localStorage.getItem('tts_api_key') || '',
                openai: {
                    endpoint: 'https://api.openai.com/v1/audio/speech',
                    voice: localStorage.getItem('openai_tts_voice') || 'alloy',
                    model: 'tts-1'
                },
                elevenlabs: {
                    endpoint: 'https://api.elevenlabs.io/v1/text-to-speech',
                    voiceId: '21m00Tcm4TlvDq8ikWAM'
                },
                google: {
                    endpoint: 'https://texttospeech.googleapis.com/v1/text:synthesize'
                }
            }
        };

        // Additional state variables
        let currentAudio = null;
        let forecastChart = null;
        let confidenceChart = null;
        let tooltipTimeout = null;

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ==================== AI-POWERED IMPACT GENERATION ====================
        /**
         * Generate smart, context-aware impact questions and activity triggers
         * using OpenAI GPT based on selected body parts
         */
        async function generateAIImpactContext(selectedParts) {
            console.log('ðŸ§  generateAIImpactContext() called with:', selectedParts);

            if (!selectedParts || selectedParts.length === 0) {
                console.log('â„¹ï¸ No body parts selected, skipping AI generation');
                return null;
            }

            // Check if API key is configured
            if (!API_CONFIG.openai.key) {
                console.warn('âš ï¸ OpenAI API key not configured, using fallback impact data');
                return getFallbackImpactContext(selectedParts);
            }

            try {
                const prompt = `
You are a physiotherapy assistant. The user has reported pain in the following body parts: ${selectedParts.join(', ')}.

Generate personalized assessment data in JSON format:
1. 3-5 "contextQuestions" (yes/no/sometimes format) - specific to the affected body parts
2. 4-6 "activityTriggers" - daily activities likely to be affected

Use simple, patient-friendly language. Be specific to the body parts mentioned.

Example format:
{
    "contextQuestions": [
        "Does your pain increase while walking?",
        "Do you feel stiffness in the morning?",
        "Is there swelling in the affected area?"
    ],
    "activityTriggers": [
        "Walking",
        "Standing",
        "Climbing stairs",
        "Sitting for long periods"
    ]
}

Respond ONLY with valid JSON, no additional text.
                `.trim();

                console.log('ðŸ¤– Sending request to OpenAI API...');
                console.log('ðŸ“ Prompt:', prompt.substring(0, 150) + '...');

                const response = await fetch(API_CONFIG.openai.endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${API_CONFIG.openai.key}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.openai.model,
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });

                if (!response.ok) {
                    console.error('âŒ OpenAI API error:', response.status, response.statusText);
                    return getFallbackImpactContext(selectedParts);
                }

                const data = await response.json();
                console.log('âœ… OpenAI API response received');

                const content = data.choices?.[0]?.message?.content;
                if (!content) {
                    console.error('âŒ No content in OpenAI response');
                    return getFallbackImpactContext(selectedParts);
                }

                console.log('ðŸ“Š Raw AI response:', content);

                // Parse JSON response
                const impactData = JSON.parse(content);
                console.log('âœ… Parsed AI impact data:', impactData);

                // Validate structure
                if (!impactData.contextQuestions || !impactData.activityTriggers) {
                    console.error('âŒ Invalid impact data structure');
                    return getFallbackImpactContext(selectedParts);
                }

                console.log(`âœ… AI generated ${impactData.contextQuestions.length} questions and ${impactData.activityTriggers.length} triggers`);
                return impactData;

            } catch (error) {
                console.error('âŒ AI Impact generation failed:', error);
                return getFallbackImpactContext(selectedParts);
            }
        }

        /**
         * Fallback impact context when AI is unavailable
         */
        function getFallbackImpactContext(selectedParts) {
            console.log('ðŸ“¦ Using fallback impact context');

            const genericQuestions = [
                "Does your pain increase with movement?",
                "Do you experience stiffness in the morning?",
                "Is there visible swelling or redness?",
                "Does rest help reduce the pain?"
            ];

            const genericTriggers = [
                "Walking",
                "Standing",
                "Sitting",
                "Bending",
                "Lifting objects",
                "Sleeping"
            ];

            return {
                contextQuestions: genericQuestions,
                activityTriggers: genericTriggers
            };
        }

        /**
         * Render AI-generated impact section with animations
         */
        async function renderAIImpactSection() {
            console.log('ðŸŽ¨ renderAIImpactSection() called');

            const selected = assessmentData.selectedParts || [];
            if (!selected.length) {
                console.log('â„¹ï¸ No body parts selected');
                return;
            }

            // Show loading state
            const impactContainer = document.getElementById('aiImpactContainer');
            if (!impactContainer) {
                console.error('âŒ aiImpactContainer element not found');
                return;
            }

            impactContainer.innerHTML = `
                <div class="ai-loading">
                    <div class="loading-spinner"></div>
                    <p>ðŸ§  Generating personalized questions...</p>
                </div>
            `;

            // Generate AI context
            const aiData = await generateAIImpactContext(selected);

            if (!aiData) {
                console.log('âš ï¸ No AI data generated');
                impactContainer.innerHTML = '';
                return;
            }

            const { contextQuestions, activityTriggers } = aiData;

            // Build questions HTML
            const questionsHTML = contextQuestions.map((q, idx) => `
                <div class="context-question fade-in" style="animation-delay: ${idx * 0.1}s">
                    <label class="question-label">${q}</label>
                    <div class="question-options">
                        <button class="option-btn" onclick="selectContextOption('${q}', 'Yes')">Yes</button>
                        <button class="option-btn" onclick="selectContextOption('${q}', 'No')">No</button>
                        <button class="option-btn" onclick="selectContextOption('${q}', 'Sometimes')">Sometimes</button>
                    </div>
                </div>
            `).join('');

            // Build triggers HTML
            const triggersHTML = activityTriggers.map((t, idx) => `
                <button class="trigger-btn pulse-btn" style="animation-delay: ${idx * 0.05}s" onclick="toggleActivityTrigger('${t}')">${t}</button>
            `).join('');

            // Render with animations
            impactContainer.innerHTML = `
                <div class="dynamic-impact ai-generated">
                    <div class="ai-badge">ðŸ§  AI-Generated</div>
                    <h4 class="impact-section-title">ðŸ“‹ Additional Context Questions</h4>
                    <div class="context-questions-container">
                        ${questionsHTML}
                    </div>
                    <h4 class="impact-section-title">âš¡ Activity Triggers</h4>
                    <p class="impact-subtitle">Select activities that worsen your pain:</p>
                    <div class="trigger-list">
                        ${triggersHTML}
                    </div>
                </div>
            `;

            console.log('âœ… AI impact section rendered');
        }

        /**
         * Handle context option selection
         */
        function selectContextOption(question, answer) {
            console.log(`ðŸ“ Context answer: "${question}" â†’ ${answer}`);

            if (!assessmentData.contextAnswers) {
                assessmentData.contextAnswers = {};
            }

            assessmentData.contextAnswers[question] = answer;

            // Visual feedback
            const questionDiv = event.target.closest('.context-question');
            if (questionDiv) {
                questionDiv.classList.add('answered');
                // Update button states
                questionDiv.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                event.target.classList.add('selected');
            }

            saveSession();
        }

        /**
         * Toggle activity trigger selection
         */
        function toggleActivityTrigger(trigger) {
            console.log(`âš¡ Toggle activity trigger: ${trigger}`);

            if (!assessmentData.activityTriggers) {
                assessmentData.activityTriggers = [];
            }

            const index = assessmentData.activityTriggers.indexOf(trigger);
            if (index > -1) {
                assessmentData.activityTriggers.splice(index, 1);
                event.target.classList.remove('selected');
                console.log('âž– Removed trigger');
            } else {
                assessmentData.activityTriggers.push(trigger);
                event.target.classList.add('selected');
                console.log('âž• Added trigger');
            }

            console.log('ðŸ“Š Current triggers:', assessmentData.activityTriggers);
            saveSession();
        }

        // LOCALSTORAGE MANAGEMENT
        function saveSession() {
            try {
                localStorage.setItem('painAssessmentSession', JSON.stringify(assessmentData));
                localStorage.setItem('painAssessmentTimestamp', Date.now().toString());
                console.log('Session saved successfully');
            } catch (e) {
                console.error('Error saving session:', e);
            }
        }

        function loadSession() {
            try {
                const saved = localStorage.getItem('painAssessmentSession');
                const timestamp = localStorage.getItem('painAssessmentTimestamp');

                if (saved && timestamp) {
                    const age = Date.now() - parseInt(timestamp);
                    // Session expires after 24 hours
                    if (age < 24 * 60 * 60 * 1000) {
                        const data = JSON.parse(saved);
                        // Restore only if on first step
                        if (data.currentStep === 1 && confirm('Continue previous assessment?')) {
                            assessmentData = data;
                            restoreUI();
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading session:', e);
            }
        }

        function restoreUI() {
            if (assessmentData.bodyPart) {
                selectBodyPart(assessmentData.bodyPart, false);
            }
            if (assessmentData.intensity) {
                selectIntensity(assessmentData.intensity, false);
            }
            if (assessmentData.gender) {
                toggleGender(assessmentData.gender, false);
            }
        }

        // ====================  API CONFIGURATION ====================
        function openConfig() {
            document.getElementById('configModal').classList.add('active');
            document.getElementById('openaiKey').value = API_CONFIG.openai.key;
            document.getElementById('googleTranslateKey').value = localStorage.getItem('google_translate_api_key') || '';
            document.getElementById('deeplKey').value = localStorage.getItem('deepl_api_key') || '';
            document.getElementById('ttsProvider').value = API_CONFIG.tts.provider;
            document.getElementById('openaiVoice').value = API_CONFIG.tts.openai.voice;

            // Show/hide OpenAI voice selector
            const openaiVoiceGroup = document.getElementById('openaiVoiceGroup');
            if (API_CONFIG.tts.provider === 'openai') {
                openaiVoiceGroup.style.display = 'block';
            } else {
                openaiVoiceGroup.style.display = 'none';
            }

            // Show/hide TTS key field
            if (API_CONFIG.tts.provider !== 'browser' && API_CONFIG.tts.provider !== 'openai') {
                document.getElementById('ttsKeyGroup').style.display = 'block';
                document.getElementById('ttsKey').value = API_CONFIG.tts.key;
            } else {
                document.getElementById('ttsKeyGroup').style.display = 'none';
            }
        }

        document.getElementById('ttsProvider')?.addEventListener('change', function(e) {
            const ttsKeyGroup = document.getElementById('ttsKeyGroup');
            const openaiVoiceGroup = document.getElementById('openaiVoiceGroup');

            // Show OpenAI voice selector only when OpenAI TTS is selected
            if (e.target.value === 'openai') {
                openaiVoiceGroup.style.display = 'block';
                ttsKeyGroup.style.display = 'none';
            } else {
                openaiVoiceGroup.style.display = 'none';
            }

            // Show TTS key field for ElevenLabs and Google Cloud
            if (e.target.value === 'browser' || e.target.value === 'openai') {
                ttsKeyGroup.style.display = 'none';
            } else {
                ttsKeyGroup.style.display = 'block';
            }
        });

        // Duration slider is now initialized inside DOMContentLoaded event

        function saveConfig() {
            const openaiKey = document.getElementById('openaiKey').value.trim();
            const googleTranslateKey = document.getElementById('googleTranslateKey').value.trim();
            const deeplKey = document.getElementById('deeplKey').value.trim();
            const ttsProvider = document.getElementById('ttsProvider').value;
            const ttsKey = document.getElementById('ttsKey').value.trim();
            const openaiVoice = document.getElementById('openaiVoice').value;

            if (!openaiKey) {
                alert('Please enter your OpenAI API key');
                return;
            }

            localStorage.setItem('openai_api_key', openaiKey);
            localStorage.setItem('tts_provider', ttsProvider);
            localStorage.setItem('openai_tts_voice', openaiVoice);

            // Save Google Translate key if provided (optional)
            if (googleTranslateKey) {
                localStorage.setItem('google_translate_api_key', googleTranslateKey);
            } else {
                localStorage.removeItem('google_translate_api_key');
            }

            // Save DeepL key if provided (optional)
            if (deeplKey) {
                localStorage.setItem('deepl_api_key', deeplKey);
            } else {
                localStorage.removeItem('deepl_api_key');
            }

            if (ttsProvider !== 'browser' && ttsProvider !== 'openai') {
                localStorage.setItem('tts_api_key', ttsKey);
            }

            API_CONFIG.openai.key = openaiKey;
            API_CONFIG.tts.provider = ttsProvider;
            API_CONFIG.tts.key = ttsKey;
            API_CONFIG.tts.openai.voice = openaiVoice;

            document.getElementById('configModal').classList.remove('active');
            speak('Configuration saved successfully');
        }

        // ==================== OPENAI INTEGRATION ====================
        async function callOpenAI(prompt) {
            // Graceful fallback: Check if API key is configured
            if (!API_CONFIG.openai.key) {
                logger.info('â„¹ï¸ OpenAI API key not configured - using local analysis');
                showAPIKeyNotice();
                return null;
            }

            try {
                logger.log('ðŸ¤– Sending request to OpenAI API...');

                const response = await fetch(API_CONFIG.openai.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.openai.key}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.openai.model,
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert physiotherapist providing professional medical assessment. Be thorough, accurate, and empathetic.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ error: 'Unknown error' }));
                    logger.error('âŒ OpenAI API Error:', error);

                    // User-friendly error messages
                    if (response.status === 401) {
                        showErrorNotice('Invalid API key. Please update your configuration.', 'auth');
                    } else if (response.status === 429) {
                        showErrorNotice('Rate limit exceeded. Please try again in a moment.', 'rate');
                    } else if (response.status === 500) {
                        showErrorNotice('Service temporarily unavailable. Using local analysis.', 'server');
                    } else {
                        showErrorNotice('Unable to connect to AI service. Using local analysis.', 'network');
                    }
                    return null;
                }

                const data = await response.json();
                logger.log('âœ… OpenAI response received successfully');
                return data.choices[0].message.content;

            } catch (error) {
                logger.error('âŒ Error calling OpenAI:', error.message);
                showErrorNotice('Connection failed. Using local analysis.', 'network');
                return null;
            }
        }

        // Show user-friendly API key notice
        function showAPIKeyNotice() {
            const notice = document.getElementById('aiConnectNotice');
            if (notice) {
                notice.style.display = 'flex';
                setTimeout(() => {
                    notice.style.opacity = '1';
                }, 100);
            }
        }

        // Show error notice with auto-dismiss
        function showErrorNotice(message, type) {
            logger.warn(`âš ï¸ ${type.toUpperCase()}: ${message}`);

            // Create temporary notice if needed
            const existingNotice = document.querySelector('.error-notice');
            if (!existingNotice) {
                const notice = document.createElement('div');
                notice.className = 'error-notice';
                notice.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(239, 68, 68, 0.95);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 12px;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                    z-index: 10000;
                    animation: slideIn 0.3s ease-out;
                    max-width: 350px;
                `;
                notice.innerHTML = `
                    <div style="display:flex;align-items:center;gap:0.75rem;">
                        <svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:white;">
                            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                        </svg>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(notice);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    notice.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => notice.remove(), 300);
                }, 5000);
            }
        }

        function buildPhysiotherapyPrompt() {
            const frequencyText = assessmentData.painFrequency ? `\n- Pain Frequency: ${assessmentData.painFrequency}` : '';
            const painTypeText = assessmentData.painType ? `\n- Pain Type: ${assessmentData.painType}` : '';
            const durationMonthsText = assessmentData.durationMonths ? `\n- Duration in Months: ${assessmentData.durationMonths} month(s)` : '';
            const triggersText = assessmentData.activityTriggers.length > 0 ? `\n- Activity Triggers: ${assessmentData.activityTriggers.join(', ')}` : '';
            const notesText = assessmentData.additionalNotes ? `\n- Additional Notes: ${assessmentData.additionalNotes}` : '';

            return `You are an expert physiotherapist AI assistant with years of clinical experience. Analyze the following comprehensive patient pain assessment and provide professional, evidence-based insights.

PATIENT DETAILS:
- Gender: ${assessmentData.gender}
- Affected Body Part: ${assessmentData.bodyPart}
- Pain Intensity: ${assessmentData.intensity}/10 (${assessmentData.intensityLabel})
- Duration: ${assessmentData.duration}${durationMonthsText}${frequencyText}${painTypeText}${triggersText}
- Affected Activities: ${assessmentData.activities.join(', ')}${notesText}

INSTRUCTIONS:
Based on this detailed information, provide a comprehensive analysis:

1. **Initial Assessment**: Give a brief clinical impression (2-3 sentences) considering pain type, frequency, and triggers.

2. **Likely Diagnosis**: Provide 1-2 possible diagnoses based on:
   - Pain location and type (${assessmentData.painType || 'not specified'})
   - Frequency pattern (${assessmentData.painFrequency || 'not specified'})
   - Activity triggers and aggravating factors
   - Duration and progression
   Be specific but include appropriate medical disclaimers.

3. **Recovery Timeline**: Provide a realistic timeline with:
   - Expected recovery duration
   - Key milestones (week 2, week 4, week 8, etc.)
   - Factors that may speed up or slow recovery
   - Confidence level in the timeline

4. **Treatment Plan**: Recommend:
   - Specific exercises (with frequency/duration)
   - Physical therapy modalities
   - Lifestyle modifications
   - When to seek immediate medical attention
   - Self-care strategies

Format your response in 4 clear sections with headers:
- Initial Assessment
- Diagnosis & Analysis
- Recovery Timeline
- Treatment Plan

Keep each section concise, evidence-based, and patient-friendly. Use professional but accessible language.`;
        }

        // ==================== TEXT-TO-SPEECH ====================
        async function speak(text) {
            if (!assessmentData.voiceEnabled) return;

            const provider = API_CONFIG.tts.provider;

            if (provider === 'browser') {
                speakBrowser(text);
            } else if (provider === 'openai' && API_CONFIG.openai.key) {
                await speakOpenAI(text);
            } else if (provider === 'elevenlabs' && API_CONFIG.tts.key) {
                await speakElevenLabs(text);
            } else if (provider === 'google' && API_CONFIG.tts.key) {
                await speakGoogle(text);
            } else {
                speakBrowser(text);
            }
        }

        function speakBrowser(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;

                if (assessmentData.currentLanguage === 'hi') {
                    utterance.lang = 'hi-IN';
                } else {
                    utterance.lang = 'en-US';
                }

                speechSynthesis.speak(utterance);
            }
        }

        async function speakOpenAI(text) {
            try {
                const response = await fetch(API_CONFIG.tts.openai.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.openai.key}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.tts.openai.model,
                        voice: API_CONFIG.tts.openai.voice,
                        input: text,
                        speed: 1.0
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    playAudioUrl(audioUrl);
                } else {
                    const errorText = await response.text();
                    console.error('OpenAI TTS error:', errorText);
                    speakBrowser(text);
                }
            } catch (error) {
                console.error('Error with OpenAI TTS:', error);
                speakBrowser(text);
            }
        }

        async function speakElevenLabs(text) {
            try {
                const response = await fetch(`${API_CONFIG.tts.elevenlabs.endpoint}/${API_CONFIG.tts.elevenlabs.voiceId}`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': API_CONFIG.tts.key
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_monolingual_v1',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.5
                        }
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    playAudioUrl(audioUrl);
                } else {
                    console.error('ElevenLabs TTS error:', await response.text());
                    speakBrowser(text);
                }
            } catch (error) {
                console.error('Error with ElevenLabs TTS:', error);
                speakBrowser(text);
            }
        }

        async function speakGoogle(text) {
            try {
                const response = await fetch(`${API_CONFIG.tts.google.endpoint}?key=${API_CONFIG.tts.key}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        input: { text: text },
                        voice: {
                            languageCode: assessmentData.currentLanguage === 'hi' ? 'hi-IN' : 'en-US',
                            name: assessmentData.currentLanguage === 'hi' ? 'hi-IN-Wavenet-A' : 'en-US-Wavenet-D'
                        },
                        audioConfig: {
                            audioEncoding: 'MP3'
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const audioContent = data.audioContent;
                    const audioBlob = base64ToBlob(audioContent, 'audio/mp3');
                    const audioUrl = URL.createObjectURL(audioBlob);
                    playAudioUrl(audioUrl);
                } else {
                    console.error('Google TTS error:', await response.text());
                    speakBrowser(text);
                }
            } catch (error) {
                console.error('Error with Google TTS:', error);
                speakBrowser(text);
            }
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        function playAudioUrl(url) {
            if (currentAudio) {
                currentAudio.pause();
            }

            currentAudio = new Audio(url);
            currentAudio.play();

            const voiceWave = document.getElementById('voiceWave');
            if (voiceWave) voiceWave.style.display = 'inline-flex';

            currentAudio.addEventListener('ended', () => {
                currentAudio = null;
                if (voiceWave) voiceWave.style.display = 'none';
            });
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }

            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }

            const voiceWave = document.getElementById('voiceWave');
            if (voiceWave) voiceWave.style.display = 'none';
        }

        // ==================== VOICE HELPERS FOR DYNAMIC QUESTIONS ====================
        function speakQuestion(text, event) {
            if (event) event.preventDefault();
            const btn = event?.target?.closest('.voice-btn');

            // Toggle speaking class
            if (btn) {
                btn.classList.add('speaking');
                setTimeout(() => btn.classList.remove('speaking'), 3000);
            }

            // Use browser TTS for questions (always available)
            speakBrowser(text);
        }

        async function startVoiceAnswerInput(questionIndex, event) {
            if (event) event.preventDefault();

            const btn = event?.target?.closest('.voice-btn');
            if (!API_CONFIG.openai.key) {
                alert('OpenAI API key required for voice input. Please configure in settings.');
                return;
            }

            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];

                if (btn) {
                    btn.classList.add('listening');
                }

                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener('stop', async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());

                    if (btn) {
                        btn.classList.remove('listening');
                    }

                    // Transcribe with Whisper
                    const transcription = await transcribeAudio(audioBlob);
                    if (transcription) {
                        // Find closest match from options
                        const question = document.querySelectorAll('.context-question')[questionIndex];
                        const radios = question.querySelectorAll('input[type="radio"]');
                        const transcriptLower = transcription.toLowerCase();

                        // Simple matching logic
                        let bestMatch = null;
                        radios.forEach(radio => {
                            const value = radio.value.toLowerCase();
                            if (transcriptLower.includes(value) || value.includes(transcriptLower)) {
                                bestMatch = radio;
                            }
                        });

                        if (bestMatch) {
                            bestMatch.checked = true;
                            saveContextAnswer(questionIndex, bestMatch.value);
                            speakBrowser(`Answered: ${bestMatch.value}`);
                        } else {
                            speakBrowser('Could not understand. Please try again or select manually.');
                        }
                    }
                });

                // Record for 3 seconds
                mediaRecorder.start();
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 3000);

            } catch (error) {
                console.error('Voice input error:', error);
                if (btn) btn.classList.remove('listening');
                alert('Microphone access denied or not available');
            }
        }

        function saveContextAnswer(questionIndex, answer) {
            // Save to assessmentData
            if (!assessmentData.contextAnswers) {
                assessmentData.contextAnswers = {};
            }
            assessmentData.contextAnswers[`q${questionIndex}`] = answer;
            saveSession();
        }

        async function transcribeAudio(audioBlob) {
            if (!API_CONFIG.openai.key) return null;

            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', API_CONFIG.whisper.model);

                const response = await fetch(API_CONFIG.whisper.endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_CONFIG.openai.key}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.text;
                } else {
                    console.error('Whisper error:', await response.text());
                    return null;
                }
            } catch (error) {
                console.error('Transcription error:', error);
                return null;
            }
        }

        function toggleVoice() {
            assessmentData.voiceEnabled = !assessmentData.voiceEnabled;

            const voiceToggle = document.getElementById('voiceToggle');
            const voiceWave = document.getElementById('voiceWave');

            if (assessmentData.voiceEnabled) {
                voiceToggle.style.background = 'linear-gradient(135deg, var(--success) 0%, #059669 100%)';
                speak('Voice enabled');
            } else {
                voiceToggle.style.background = '';
                stopAudio();
                if (voiceWave) voiceWave.style.display = 'none';
            }

            saveSession();
        }

        // GENDER TOGGLE
        function toggleGender(gender, save = true) {
            assessmentData.gender = gender;

            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-gender="${gender}"]`).classList.add('active');

            // Toggle SVG visibility
            document.getElementById('maleSvg').style.display = gender === 'male' ? 'block' : 'none';
            document.getElementById('femaleSvg').style.display = gender === 'female' ? 'block' : 'none';

            if (save) saveSession();
        }

        // TOOLTIP FUNCTIONALITY
        function showTooltip(event, part) {
            clearTimeout(tooltipTimeout);

            const tooltip = document.getElementById('painTooltip');
            const element = event.currentTarget;
            const painTypes = element.getAttribute('data-pain-types').split(',');

            document.getElementById('tooltipTitle').textContent = part.charAt(0).toUpperCase() + part.slice(1) + ' Pain';

            const typesHtml = painTypes.map(type =>
                `<span class="pain-type-badge">${type}</span>`
            ).join('');
            document.querySelector('.tooltip-types').innerHTML = typesHtml;

            const rect = element.getBoundingClientRect();
            const container = document.querySelector('.body-svg-wrapper').getBoundingClientRect();

            tooltip.style.left = (rect.left - container.left + rect.width / 2) + 'px';
            tooltip.style.top = (rect.top - container.top - 10) + 'px';
            tooltip.style.transform = 'translate(-50%, -100%)';

            tooltipTimeout = setTimeout(() => {
                tooltip.classList.add('show');
            }, 200);
        }

        function hideTooltip() {
            clearTimeout(tooltipTimeout);
            document.getElementById('painTooltip').classList.remove('show');
        }

        // BODY PART SELECTION - Multi-selection with toggle support
        function selectBodyPart(part, save = true, clickEvent = null) {
            console.log('ðŸ” selectBodyPart called:', { part, hasClickEvent: !!clickEvent, hasWindowEvent: !!window.event });

            const currentSvg = assessmentData.gender === 'male' ? 'maleSvg' : 'femaleSvg';
            let clickedElement = null;

            // Determine which element was clicked - IMPROVED EVENT DETECTION
            if (clickEvent && clickEvent.target) {
                clickedElement = clickEvent.target;
                console.log('âœ… Got element from clickEvent.target');
            } else if (clickEvent && clickEvent.currentTarget) {
                clickedElement = clickEvent.currentTarget;
                console.log('âœ… Got element from clickEvent.currentTarget');
            } else if (typeof window !== 'undefined' && window.event && window.event.target) {
                // Fallback for inline onclick handlers
                clickedElement = window.event.target;
                console.log('âœ… Got element from window.event.target');
            } else if (typeof window !== 'undefined' && window.event && window.event.srcElement) {
                // IE fallback
                clickedElement = window.event.srcElement;
                console.log('âœ… Got element from window.event.srcElement (IE fallback)');
            } else {
                // Last resort: find first matching part for programmatic selection
                console.log('âš ï¸ Using fallback: querying DOM for first matching part');
                const matchingParts = document.querySelectorAll(`#${currentSvg} [data-part="${part}"]`);
                if (matchingParts.length > 0) {
                    clickedElement = matchingParts[0];
                }
            }

            if (!clickedElement) {
                console.error('âŒ No clicked element found!');
                return;
            }

            // Ensure we're working with the body-part element
            if (!clickedElement.classList.contains('body-part')) {
                clickedElement = clickedElement.closest('.body-part');
            }
            if (!clickedElement) {
                console.error('âŒ Could not find .body-part element');
                return;
            }

            console.log('âœ… Found body-part element:', clickedElement.getAttribute('data-part'), 'at position:', {
                cx: clickedElement.getAttribute('cx'),
                x: clickedElement.getAttribute('x')
            });

            // Toggle selection
            const isCurrentlySelected = clickedElement.classList.contains('selected');

            if (isCurrentlySelected) {
                // Deselect this part
                clickedElement.classList.remove('selected');
                console.log('âž– Deselected:', clickedElement.getAttribute('data-part'));
            } else {
                // Select this part
                clickedElement.classList.add('selected');
                console.log('âž• Selected:', clickedElement.getAttribute('data-part'));
            }

            // Rebuild selectedParts from all selected elements
            const allSelected = document.querySelectorAll(`#${currentSvg} .body-part.selected`);
            assessmentData.selectedParts = Array.from(allSelected).map(el => el.getAttribute('data-part'));

            // Remove duplicates from selectedParts
            assessmentData.selectedParts = [...new Set(assessmentData.selectedParts)];

            console.log('ðŸ“‹ Selected parts:', assessmentData.selectedParts);

            // Update the main bodyPart to the first selected (for backward compatibility)
            assessmentData.bodyPart = assessmentData.selectedParts.length > 0 ? assessmentData.selectedParts[0] : null;

            // Update all dependent UI elements
            updateSelectedParts();
            updateSelectedPartsFeedback();

            checkStep1Complete();
            if (save) saveSession();

            // Voice feedback
            const action = isCurrentlySelected ? 'deselected' : 'selected';
            speak(`${part} ${action}`);
        }

        // Update the selected parts feedback bar in Step 1
        function updateSelectedPartsFeedback() {
            console.log('ðŸŽ¨ updateSelectedPartsFeedback() called');

            const feedbackBar = document.getElementById('selectedPartsDisplay');
            if (!feedbackBar) {
                console.error('âŒ selectedPartsDisplay element not found');
                return;
            }

            const selectedParts = assessmentData.selectedParts || [];
            console.log('ðŸ“ Updating feedback bar with parts:', selectedParts);

            // Emoji mapping for body parts
            const emojiMap = {
                'head': 'ðŸ§ ',
                'neck': 'ðŸ¦´',
                'shoulder': 'ðŸ’ª',
                'back': 'ðŸ”™',
                'arm': 'ðŸ’ª',
                'elbow': 'ðŸ¦¾',
                'wrist': 'ðŸ¤²',
                'hand': 'âœ‹',
                'hip': 'ðŸ¦µ',
                'leg': 'ðŸ¦µ',
                'knee': 'ðŸ¦µ',
                'ankle': 'ðŸ¦¶',
                'foot': 'ðŸ¦¶'
            };

            if (selectedParts.length === 0) {
                feedbackBar.innerHTML = '';
                console.log('âœ… Cleared feedback bar (no parts selected)');
                return;
            }

            // Build feedback HTML
            const partBadges = selectedParts.map(part => {
                const emoji = emojiMap[part] || 'ðŸ“';
                const formattedName = part.split('-').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
                return `<span class="part-name">${emoji} ${formattedName}</span>`;
            }).join('');

            feedbackBar.innerHTML = `
                <span class="feedback-label">Selected:</span>
                ${partBadges}
            `;

            console.log(`âœ… Updated feedback bar with ${selectedParts.length} part(s)`);
        }

        // Update UI based on all selected parts
        function updateSelectedParts() {
            const selectedParts = assessmentData.selectedParts;

            // Update selected parts display
            showSelectedPartsDisplay();

            if (selectedParts.length === 0) {
                // No parts selected - clear dynamic content
                return;
            }

            if (selectedParts.length === 1) {
                // Single part selected - use existing logic
                renderDynamicSections(selectedParts[0]);
                renderImpactOptions();
            } else {
                // Multiple parts selected - merge context
                renderDynamicSections(selectedParts[0]); // Use first part's context for now
                renderImpactForMultipleParts(selectedParts);
            }
        }

        // Display selected parts names above impact section WITH EMOJI BADGES
        function showSelectedPartsDisplay() {
            console.log('ðŸŽ¨ showSelectedPartsDisplay called');

            const step3 = document.getElementById('step3');
            if (!step3) {
                console.error('âŒ Step3 element not found!');
                return;
            }

            const selectedParts = assessmentData.selectedParts;
            console.log('ðŸ“‹ Displaying parts:', selectedParts);

            // Find or create selected parts display
            let selectedDisplay = step3.querySelector('.selected-parts-display');
            if (!selectedDisplay) {
                selectedDisplay = document.createElement('div');
                selectedDisplay.className = 'selected-parts-display';
                // step3 IS the .step-content div, use it directly
                step3.insertBefore(selectedDisplay, step3.firstChild);
                console.log('âœ… Created selected-parts-display element');
            }

            if (selectedParts.length === 0) {
                selectedDisplay.style.display = 'none';
                selectedDisplay.innerHTML = '<div class="selected-parts-empty">ðŸ‘† Click on body parts above to select them</div>';
                console.log('â„¹ï¸ No parts selected, hiding display');
                return;
            }

            // Emoji mapping for body parts
            const emojiMap = {
                'head': 'ðŸ§ ',
                'neck': 'ðŸ¦´',
                'shoulder': 'ðŸ’ª',
                'back': 'ðŸ”™',
                'arm': 'ðŸ’ª',
                'elbow': 'ðŸ¦¾',
                'wrist': 'ðŸ¤²',
                'hand': 'âœ‹',
                'hip': 'ðŸ¦µ',
                'leg': 'ðŸ¦µ',
                'knee': 'ðŸ¦µ',
                'ankle': 'ðŸ¦¶',
                'foot': 'ðŸ¦¶'
            };

            // Format part names with emojis as badges
            const formatPartName = (part) => {
                const emoji = emojiMap[part] || 'ðŸ“';
                const name = part.split('-').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');
                return `<span class="part-badge">${emoji} ${name}</span>`;
            };

            const partBadges = selectedParts.map(formatPartName).join(' ');

            selectedDisplay.style.display = 'block';
            selectedDisplay.innerHTML = `
                <div class="selected-parts-label">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    <span>Selected Areas (${selectedParts.length}):</span>
                </div>
                <div class="selected-parts-badges">${partBadges}</div>
            `;

            console.log('âœ… Display updated with', selectedParts.length, 'badges');
        }

        // Render combined impact options for multiple body parts WITH EMOJIS
        function renderImpactForMultipleParts(selectedParts) {
            console.log('ðŸ’¥ renderImpactForMultipleParts called with:', selectedParts);

            const step3 = document.getElementById('step3');
            if (!step3) {
                console.error('âŒ Step3 not found!');
                return;
            }
            if (!selectedParts || selectedParts.length === 0) {
                console.log('â„¹ï¸ No selected parts, skipping impact rendering');
                return;
            }

            // Emoji icons for impact levels
            const impactEmojis = {
                'mild': 'âœ…',
                'moderate': 'âš ï¸',
                'severe': 'ðŸ”´',
                'critical': 'ðŸš¨'
            };

            // Collect all unique impact descriptions from all selected parts
            const allImpacts = {
                mild: [],
                moderate: [],
                severe: [],
                critical: []
            };

            console.log('ðŸ”„ Gathering impacts from IMPACT_MATRIX...');

            // Gather impacts from all selected parts with validation
            selectedParts.forEach(part => {
                if (!part) {
                    console.warn('âš ï¸ Skipping null/undefined part');
                    return;
                }

                const impactSet = IMPACT_MATRIX[part] || IMPACT_MATRIX.default;
                if (!impactSet) {
                    console.warn(`âš ï¸ No impact set found for part: ${part}`);
                    return;
                }

                console.log(`âœ… Found impact set for ${part}:`, Object.keys(impactSet));

                Object.keys(allImpacts).forEach(level => {
                    const impactData = impactSet[level];
                    if (impactData && impactData.title && impactData.description) {
                        allImpacts[level].push({
                            title: impactData.title,
                            description: impactData.description,
                            icon: impactData.icon || 'check-circle',
                            part: part
                        });
                    }
                });
            });

            console.log('ðŸ“Š Collected impacts:', {
                mild: allImpacts.mild.length,
                moderate: allImpacts.moderate.length,
                severe: allImpacts.severe.length,
                critical: allImpacts.critical.length
            });

            // Find or create impact section with error handling
            let impactSection = step3.querySelector('.impact-section');
            if (!impactSection) {
                impactSection = document.createElement('div');
                impactSection.className = 'impact-section';
                // step3 IS the .step-content div, use it directly
                // Insert after selected parts display if it exists
                const selectedDisplay = step3.querySelector('.selected-parts-display');
                if (selectedDisplay) {
                    step3.insertBefore(impactSection, selectedDisplay.nextSibling);
                    console.log('âœ… Impact section inserted after selected parts display');
                } else {
                    step3.insertBefore(impactSection, step3.firstChild);
                    console.log('âœ… Impact section inserted at beginning of step3');
                }
            }

            // SVG icons for each impact level
            const svgIcons = {
                'check-circle': '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>',
                'alert-triangle': '<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>',
                'alert-circle': '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>',
                'alert-octagon': '<path d="M12 2L1 21h22L12 2zm0 3.99L19.53 19H4.47L12 5.99zM11 16h2v2h-2zm0-6h2v4h-2z"/>'
            };

            // Build deduplicated impact cards with validation
            const impactLevels = ['mild', 'moderate', 'severe', 'critical'];
            const cardsHTML = impactLevels.map(level => {
                const impacts = allImpacts[level];

                // Validate we have impacts for this level
                if (!impacts || impacts.length === 0) {
                    return ''; // Skip this level if no impacts
                }

                // Deduplicate descriptions using Set with comprehensive validation
                const validImpacts = impacts.filter(i =>
                    i &&
                    typeof i === 'object' &&
                    i.description &&
                    typeof i.description === 'string' &&
                    i.description.trim() !== ''
                );

                if (validImpacts.length === 0) return ''; // Skip if no valid impacts

                const uniqueDescriptions = [...new Set(validImpacts.map(i => i.description))];

                // Use the first valid impact's data
                const firstImpact = validImpacts[0];

                // Combine descriptions if multiple unique ones exist
                const combinedDescription = uniqueDescriptions.length > 1
                    ? uniqueDescriptions.join('; ')
                    : uniqueDescriptions[0];

                const emoji = impactEmojis[level] || 'ðŸ“';

                return `
                    <div class="impact-card" data-impact="${level}" tabindex="0" role="button" aria-label="${emoji} ${firstImpact.title}: ${combinedDescription}">
                        <div class="impact-icon">
                            <svg viewBox="0 0 24 24">
                                ${svgIcons[firstImpact.icon] || svgIcons['check-circle']}
                            </svg>
                        </div>
                        <div class="impact-content">
                            <div class="impact-title">${emoji} ${firstImpact.title || level}</div>
                            <div class="impact-description">${combinedDescription}</div>
                        </div>
                    </div>
                `;
            }).filter(Boolean).join(''); // Remove empty cards

            console.log('ðŸŽ¨ Generated', cardsHTML.split('impact-card').length - 1, 'impact cards');

            impactSection.innerHTML = `
                <h3 class="section-title" data-i18n="impactLabel">${t('impactLabel') || 'Impact on Daily Life'}</h3>
                <div class="impact-options">
                    ${cardsHTML}
                </div>
            `;

            console.log('âœ… Impact section HTML updated');

            // Add event delegation for impact card clicks
            const impactOptions = impactSection.querySelector('.impact-options');
            if (impactOptions) {
                // Remove old listeners by cloning
                const newImpactOptions = impactOptions.cloneNode(true);
                impactOptions.parentNode.replaceChild(newImpactOptions, impactOptions);

                // Add new event listener with delegation for clicks
                newImpactOptions.addEventListener('click', (e) => {
                    const card = e.target.closest('.impact-card');
                    if (card) {
                        const level = card.getAttribute('data-impact');
                        if (level) {
                            handleImpactSelect(level);
                        }
                    }
                });

                // Add keyboard navigation support
                newImpactOptions.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const card = e.target.closest('.impact-card');
                        if (card) {
                            const level = card.getAttribute('data-impact');
                            if (level) {
                                handleImpactSelect(level);
                            }
                        }
                    }
                });
            }

            // Highlight selected impact if exists
            if (assessmentData.impactLevel) {
                const selectedCard = impactSection.querySelector(`[data-impact="${assessmentData.impactLevel}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
            }
        }

        // DYNAMIC SECTION RENDERING BASED ON BODY PART
        function renderDynamicSections(bodyPart) {
            const sectionConfig = CONTEXT_MATRIX[bodyPart];
            if (!sectionConfig) {
                console.log(`No specific configuration for ${bodyPart}, using default`);
                return;
            }

            // Render dynamic duration options (Step 2)
            renderDynamicDuration(sectionConfig.duration);

            // Render dynamic activities (Step 3)
            renderDynamicActivities(sectionConfig.activities);

            // Render context-specific questions (Step 3)
            renderContextQuestions(sectionConfig.duration.contextQuestions);
        }

        function renderDynamicDuration(durationConfig) {
            const step2 = document.getElementById('step2');
            const durationGrid = step2.querySelector('.options-grid');

            if (!durationGrid || !durationConfig) return;

            // Clear existing options
            durationGrid.innerHTML = '';

            // Add animation class
            durationGrid.style.opacity = '0';

            // Render new options
            durationConfig.options.forEach(option => {
                const card = document.createElement('div');
                card.className = 'option-card';
                card.setAttribute('data-duration', option);
                card.onclick = () => selectDuration(option);
                card.innerHTML = `
                    <div class="option-icon">
                        <svg viewBox="0 0 24 24">
                            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                        </svg>
                    </div>
                    <div class="option-text">${option}</div>
                `;
                durationGrid.appendChild(card);
            });

            // Fade in
            setTimeout(() => {
                durationGrid.style.transition = 'opacity 0.5s ease';
                durationGrid.style.opacity = '1';
            }, 100);
        }

        function renderDynamicActivities(activities) {
            const step3 = document.getElementById('step3');
            const activityGrid = step3.querySelector('.options-grid');

            if (!activityGrid || !activities) return;

            // Clear existing activities
            activityGrid.innerHTML = '';

            // Add animation
            activityGrid.style.opacity = '0';

            // Render new activities
            activities.forEach((activity, index) => {
                const activityId = activity.toLowerCase().replace(/\s+/g, '-');
                const card = document.createElement('div');
                card.className = 'option-card';
                card.setAttribute('data-activity', activityId);
                card.onclick = () => toggleActivity(activityId);

                const icons = [
                    '<path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/>',
                    '<path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z"/>',
                    '<path d="M9 11.75c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zm6 0c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.29.02-.58.05-.86 2.36-1.05 4.23-2.98 5.21-5.37C11.07 8.33 14.05 10 17.42 10c.78 0 1.53-.09 2.25-.26.21.71.33 1.47.33 2.26 0 4.41-3.59 8-8 8z"/>',
                    '<path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>',
                    '<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>'
                ];

                card.innerHTML = `
                    <div class="option-icon">
                        <svg viewBox="0 0 24 24">${icons[index % icons.length]}</svg>
                    </div>
                    <div class="option-text">${activity}</div>
                `;
                activityGrid.appendChild(card);
            });

            // Fade in
            setTimeout(() => {
                activityGrid.style.transition = 'opacity 0.5s ease';
                activityGrid.style.opacity = '1';
            }, 100);
        }

        function renderContextQuestions(questions) {
            if (!questions || questions.length === 0) return;

            const step3 = document.getElementById('step3');
            let contextContainer = step3.querySelector('.context-questions-container');

            // Create container if it doesn't exist
            if (!contextContainer) {
                contextContainer = document.createElement('div');
                contextContainer.className = 'context-questions-container';
                contextContainer.style.opacity = '0';

                // Insert before the enhanced-inputs section
                const enhancedInputs = step3.querySelector('.enhanced-inputs');
                if (enhancedInputs) {
                    step3.insertBefore(contextContainer, enhancedInputs);
                }
            }

            // Clear existing questions
            contextContainer.innerHTML = '<h3 class="subsection-title">Additional Context</h3>';

            // Render questions with voice features
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'context-question';
                questionDiv.innerHTML = `
                    <div class="question-header">
                        <label class="input-label">${q.label}</label>
                        <div class="voice-buttons">
                            <button class="voice-btn listen-btn" onclick="speakQuestion('${q.label.replace(/'/g, "\\'")}', event)" title="${t('voiceListen') || 'ðŸŽ§ Read Question'}">
                                <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;">
                                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                </svg>
                            </button>
                            <button class="voice-btn speak-btn" onclick="startVoiceAnswerInput(${index}, event)" title="${t('voiceSpeak') || 'ðŸŽ¤ Speak Answer'}">
                                <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;">
                                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="radio-group">
                        ${q.options.map((opt, i) => `
                            <label class="radio-label">
                                <input type="radio" name="contextQ${index}" value="${opt}" onchange="saveContextAnswer(${index}, '${opt}')">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                contextContainer.appendChild(questionDiv);
            });

            // Fade in
            setTimeout(() => {
                contextContainer.style.transition = 'opacity 0.5s ease';
                contextContainer.style.opacity = '1';
            }, 200);
        }

        function selectIntensity(level, save = true) {
            assessmentData.intensity = level;

            document.querySelectorAll('.intensity-level').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-level="${level}"]`).classList.add('selected');

            checkStep1Complete();
            if (save) saveSession();
            speak(`${level} pain intensity selected`);
        }

        function checkStep1Complete() {
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.disabled = !(assessmentData.bodyPart && assessmentData.intensity);
        }

        // DURATION
        function selectDuration(duration) {
            console.log('ðŸ• selectDuration() called with:', duration);
            assessmentData.duration = duration;

            document.querySelectorAll('[data-duration]').forEach(card => card.classList.remove('selected'));
            const selectedCard = document.querySelector(`[data-duration="${duration}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                console.log('âœ… Duration card selected:', duration);
            } else {
                console.error('âŒ Duration card not found for:', duration);
            }

            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.disabled = false;
                console.log('âœ… Next button enabled');
            }

            saveSession();
            speak(`${duration} selected`);
        }

        // ACTIVITY
        function toggleActivity(activity) {
            const index = assessmentData.activities.indexOf(activity);
            const card = document.querySelector(`[data-activity="${activity}"]`);

            if (index > -1) {
                assessmentData.activities.splice(index, 1);
                card.classList.remove('selected');
            } else {
                assessmentData.activities.push(activity);
                card.classList.add('selected');
            }

            document.getElementById('nextBtn').disabled = assessmentData.activities.length === 0;
            saveSession();
        }

        // NAVIGATION
        function nextStep() {
            const currentStep = assessmentData.currentStep;

            if (currentStep === 3) {
                // Collect enhanced input fields before AI analysis
                const painFrequency = document.getElementById('painFrequency')?.value || '';
                const painType = document.querySelector('input[name="painType"]:checked')?.value || '';
                const durationMonths = document.getElementById('durationSlider')?.value || 3;
                const activityTriggers = Array.from(document.querySelectorAll('input[name="activityTrigger"]:checked'))
                    .map(el => el.value);
                const additionalNotes = document.getElementById('additionalNotes')?.value || '';

                assessmentData.painFrequency = painFrequency;
                assessmentData.painType = painType;
                assessmentData.durationMonths = parseInt(durationMonths);
                assessmentData.activityTriggers = activityTriggers;
                assessmentData.additionalNotes = additionalNotes;

                saveSession();
                runAIAnalysis();
                return;
            }

            if (currentStep === 4) {
                window.location.href = '/book-consultation';  // Update with your booking URL
                return;
            }

            assessmentData.currentStep++;
            updateStepDisplay();
            saveSession();
        }

        function previousStep() {
            if (assessmentData.currentStep > 1) {
                assessmentData.currentStep--;
                updateStepDisplay();
            }
        }

        function goToStep(step) {
            // Allow navigation to completed steps only
            if (step <= assessmentData.currentStep || assessmentData.currentStep === 4) {
                assessmentData.currentStep = step;
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            const step = assessmentData.currentStep;

            updateProgress();

            document.querySelectorAll('.step-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');

            document.getElementById('backBtn').style.display = step > 1 ? 'inline-flex' : 'none';

            checkNextButtonState();
            updateNextButton();

            const titleElement = document.getElementById(`step${step}Title`);
            if (titleElement) {
                speak(titleElement.textContent);
            }

            // Render AI-powered impact section when entering Step 3
            if (step === 3) {
                // Handle both multi-part and single-part selection
                const hasMultiParts = assessmentData.selectedParts && assessmentData.selectedParts.length > 0;
                const hasSinglePart = assessmentData.bodyPart;

                if (hasMultiParts || hasSinglePart) {
                    console.log('ðŸ“ Entering Step 3, rendering AI impact section...');

                    // If using single part system, convert to array for AI generation
                    if (hasSinglePart && !hasMultiParts) {
                        assessmentData.selectedParts = [assessmentData.bodyPart];
                    }

                    renderAIImpactSection();
                }
            }
        }

        function checkNextButtonState() {
            const step = assessmentData.currentStep;
            let enabled = false;

            switch(step) {
                case 1:
                    enabled = assessmentData.bodyPart && assessmentData.intensity;
                    break;
                case 2:
                    enabled = assessmentData.duration !== null;
                    break;
                case 3:
                    enabled = assessmentData.activities.length > 0;
                    break;
                case 4:
                    enabled = true;
                    break;
            }

            document.getElementById('nextBtn').disabled = !enabled;
        }

        function updateProgress() {
            const step = assessmentData.currentStep;
            const percentage = ((step - 1) / (assessmentData.totalSteps - 1)) * 100;

            // Update main progress bar
            const progressLineFill = document.getElementById('progressLineFill');
            if (progressLineFill) {
                progressLineFill.style.width = `${percentage}%`;
            }

            // Update all progress steps (both main and sticky header)
            document.querySelectorAll('.progress-step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');

                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });

            // Update sticky progress header
            const stickyHeader = document.getElementById('stickyProgressHeader');
            const progressBarFill = document.getElementById('progressBarFill');

            if (stickyHeader && progressBarFill) {
                // Show sticky header after step 1
                if (step > 1) {
                    stickyHeader.style.display = 'block';
                } else {
                    stickyHeader.style.display = 'none';
                }

                // Update progress bar fill
                const stickyPercentage = (step / assessmentData.totalSteps) * 100;
                progressBarFill.style.width = `${stickyPercentage}%`;
            }
        }

        function updateNextButton() {
            const step = assessmentData.currentStep;
            const nextBtnText = document.getElementById('nextBtnText');
            const nextBtn = document.getElementById('nextBtn');

            if (step === 3) {
                nextBtnText.textContent = t('analyzeBtn');
                if (nextBtn && !nextBtn.disabled) {
                    nextBtn.classList.add('pulse');
                }
            } else if (step === 4) {
                nextBtnText.textContent = t('bookBtn');
                if (nextBtn) nextBtn.classList.remove('pulse');
            } else {
                nextBtnText.textContent = t('continueBtn');
                if (nextBtn) nextBtn.classList.remove('pulse');
            }
        }

        // AI ANALYSIS WITH REAL OPENAI
        async function runAIAnalysis() {
            // Safe DOM element access with null checks
            const step3 = document.getElementById('step3');
            const loadingScreen = document.getElementById('loadingScreen');
            const nextBtn = document.getElementById('nextBtn');
            const backBtn = document.getElementById('backBtn');
            const aiResults = document.getElementById('aiResults');

            // Hide step 3 and show loading
            if (step3) step3.classList.remove('active');
            if (loadingScreen) loadingScreen.classList.add('active');
            if (nextBtn) nextBtn.style.display = 'none';
            if (backBtn) backBtn.style.display = 'none';

            speak('Analyzing your pain profile with AI');

            try {
                const prompt = buildPhysiotherapyPrompt();
                const aiResponse = await callOpenAI(prompt);

                if (aiResponse) {
                    // Translate AI response if not in English
                    const translatedResponse = await translateAIResponse(aiResponse);

                    assessmentData.aiResponse = translatedResponse;
                    assessmentData.aiMessages = parseAIResponse(translatedResponse);
                } else {
                    assessmentData.aiMessages = getLocalAnalysis();
                }

            } catch (error) {
                console.error('AI Analysis error:', error);
                assessmentData.aiMessages = getLocalAnalysis();
            }

            setTimeout(() => {
                displayAIChatResults();

                // Hide loading and show results
                if (loadingScreen) loadingScreen.classList.remove('active');
                if (aiResults) aiResults.classList.add('active');
                if (nextBtn) {
                    nextBtn.style.display = 'inline-flex';
                    nextBtn.disabled = false;
                }

                assessmentData.currentStep = 4;
                updateProgress();
                updateNextButton();

                saveSession();
            }, 2000);
        }

        function parseAIResponse(aiText) {
            const messages = [];

            const sections = [
                { title: 'Initial Assessment', icon: '<svg viewBox="0 0 24 24" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;fill:currentColor;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' },
                { title: 'Diagnosis & Analysis', icon: '<svg viewBox="0 0 24 24" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;fill:currentColor;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>' },
                { title: 'Recovery Timeline', icon: '<svg viewBox="0 0 24 24" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;fill:currentColor;"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>' },
                { title: 'Treatment Plan', icon: '<svg viewBox="0 0 24 24" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;fill:currentColor;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>' }
            ];

            sections.forEach(section => {
                const regex = new RegExp(`${section.title}[:\\n]+([\\s\\S]*?)(?=(?:Initial Assessment|Diagnosis|Recovery Timeline|Treatment Plan)|$)`, 'i');
                const match = aiText.match(regex);

                if (match && match[1]) {
                    messages.push({
                        title: `${section.icon} ${section.title}`,
                        content: match[1].trim()
                    });
                }
            });

            if (messages.length === 0) {
                messages.push({
                    title: '<svg viewBox="0 0 24 24" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;fill:currentColor;"><path d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3zM7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5zM16 17H8v-2h8v2zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13z"/></svg> AI Analysis',
                    content: aiText
                });
            }

            return messages;
        }

        function getLocalAnalysis() {
            return [
                {
                    title: '<svg viewBox="0 0 24 24" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;fill:currentColor;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg> Initial Assessment',
                    content: `Based on your ${assessmentData.intensityLabel} ${assessmentData.bodyPart} pain that's been present for ${assessmentData.duration}, I've analyzed your condition. The fact that it affects ${assessmentData.activities.join(', ')} suggests we need to address this carefully.`
                },
                {
                    title: '<svg viewBox="0 0 24 24" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;fill:currentColor;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg> Diagnosis',
                    content: `You likely have ${assessmentData.intensityLabel === 'severe' ? 'significant soft tissue involvement' : 'muscle strain or minor soft tissue injury'}. This is common and treatable with proper care. The pattern suggests potential inflammation and possibly some compensatory movement patterns.`
                },
                {
                    title: '<svg viewBox="0 0 24 24" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;fill:currentColor;"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg> Recovery Timeline',
                    content: `Expected recovery: ${assessmentData.intensityLabel === 'severe' ? '6-12 weeks' : '2-4 weeks'} with consistent treatment. Most patients see significant improvement within the first 2 weeks. Week 1-2: Pain reduction, Week 3-4: Function restoration, Beyond: Strengthening phase.`
                },
                {
                    title: '<svg viewBox="0 0 24 24" style="width:18px;height:18px;vertical-align:middle;margin-right:6px;fill:currentColor;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg> Treatment Plan',
                    content: "I recommend: 1) Professional physiotherapy evaluation, 2) Targeted strengthening exercises (progressive loading), 3) Pain management techniques (ice/heat therapy), 4) Lifestyle modifications to avoid aggravating activities, 5) Gradual return to normal function."
                }
            ];
        }

        // AI CHAT DISPLAY WITH TYPING INDICATOR
        function displayAIChatResults() {
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) {
                console.error('Chat container not found');
                return;
            }

            chatContainer.innerHTML = '';

            assessmentData.aiMessages.forEach((msg, index) => {
                setTimeout(() => {
                    // Show typing indicator
                    const typingIndicator = document.getElementById('typingIndicator');
                    if (typingIndicator) {
                        typingIndicator.style.display = 'inline-flex';
                    }

                    setTimeout(() => {
                        // Hide typing indicator
                        if (typingIndicator) {
                            typingIndicator.style.display = 'none';
                        }

                        // Show message
                        const messageEl = document.createElement('div');
                        messageEl.className = 'chat-message';
                        messageEl.style.animationDelay = `${index * 0.1}s`;

                        messageEl.innerHTML = `
                            <div class="chat-avatar">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
                                </svg>
                            </div>
                            <div class="chat-bubble">
                                <div class="message-title">${msg.title}</div>
                                <div class="message-content" id="msg${index}"></div>
                            </div>
                        `;

                        if (chatContainer) {
                            chatContainer.appendChild(messageEl);
                        }

                        // Typing effect
                        typeMessage(msg.content, `msg${index}`, 20);

                        // Speak message
                        setTimeout(() => speak(msg.content), 300);
                    }, 1500); // Typing indicator duration
                }, index * 3500);
            });

            // Show summary card, charts, tips, and feedback after all messages
            setTimeout(() => {
                showSummaryCard();
                showCharts();
                generateDailyTips();

                // Display enhanced rehab plan
                displayRehabPlan();

                const followUpSection = document.getElementById('followUpSection');
                const feedbackSection = document.getElementById('feedbackSection');

                if (followUpSection) followUpSection.style.display = 'block';
                if (feedbackSection) feedbackSection.style.display = 'block';
            }, 12000);
        }

        function typeMessage(text, elementId, speed) {
            const element = document.getElementById(elementId);
            if (!element) return;

            let i = 0;

            function type() {
                if (i < text.length && element) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }

            type();
        }

        // SUMMARY CARD
        function showSummaryCard() {
            const summaryCard = document.getElementById('summaryCard');
            const summaryDate = document.getElementById('summaryDate');
            const summaryArea = document.getElementById('summaryArea');
            const summaryLevel = document.getElementById('summaryLevel');
            const summaryDuration = document.getElementById('summaryDuration');
            const summaryRecovery = document.getElementById('summaryRecovery');

            if (summaryCard) summaryCard.style.display = 'block';
            if (summaryDate) summaryDate.textContent = new Date().toLocaleDateString();
            if (summaryArea && assessmentData.bodyPart) {
                summaryArea.textContent = assessmentData.bodyPart.charAt(0).toUpperCase() + assessmentData.bodyPart.slice(1);
            }
            if (summaryLevel && assessmentData.intensity) {
                summaryLevel.textContent = assessmentData.intensity.charAt(0).toUpperCase() + assessmentData.intensity.slice(1);
            }
            if (summaryDuration && assessmentData.duration) {
                summaryDuration.textContent = assessmentData.duration.charAt(0).toUpperCase() + assessmentData.duration.slice(1);
            }
            if (summaryRecovery) {
                summaryRecovery.textContent = assessmentData.intensity === 'severe' ? '6-12 weeks' : '2-4 weeks';
            }

            // Add context summary chips
            showContextChips();
        }

        function showContextChips() {
            const summaryCard = document.getElementById('summaryCard');
            if (!summaryCard) return;

            // Remove existing chips if any
            let chipsContainer = summaryCard.querySelector('.context-chips');
            if (chipsContainer) {
                chipsContainer.remove();
            }

            // Create new chips container
            chipsContainer = document.createElement('div');
            chipsContainer.className = 'context-chips';

            // Prepare chip data
            const chips = [];

            if (assessmentData.painType) {
                chips.push({
                    icon: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>',
                    label: `${assessmentData.painType} pain`
                });
            }

            if (assessmentData.painFrequency) {
                chips.push({
                    icon: '<path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>',
                    label: assessmentData.painFrequency
                });
            }

            if (assessmentData.activities && assessmentData.activities.length > 0) {
                chips.push({
                    icon: '<path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>',
                    label: `${assessmentData.activities.length} activities affected`
                });
            }

            if (assessmentData.durationMonths) {
                chips.push({
                    icon: '<path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>',
                    label: `${assessmentData.durationMonths} ${assessmentData.durationMonths === 1 ? 'month' : 'months'}`
                });
            }

            const confidence = assessmentData.intensity === 'severe' ? 'High confidence' : 'Moderate confidence';
            chips.push({
                icon: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>',
                label: confidence
            });

            // Render chips
            chips.forEach(chip => {
                const chipEl = document.createElement('div');
                chipEl.className = 'context-chip';
                chipEl.innerHTML = `
                    <svg viewBox="0 0 24 24">${chip.icon}</svg>
                    <span>${chip.label}</span>
                `;
                chipsContainer.appendChild(chipEl);
            });

            // Insert chips after summary grid
            const summaryActions = summaryCard.querySelector('.summary-actions');
            if (summaryActions) {
                summaryCard.insertBefore(chipsContainer, summaryActions);
            } else {
                summaryCard.appendChild(chipsContainer);
            }
        }

        // PDF DOWNLOAD
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(20);
            doc.setTextColor(243, 112, 33);
            doc.text('Pain Assessment Report', 20, 20);

            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 30);
            doc.text(`Session ID: ${assessmentData.sessionId}`, 20, 35);

            // Summary
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Assessment Summary', 20, 50);

            doc.setFontSize(11);
            doc.text(`Affected Area: ${assessmentData.bodyPart}`, 20, 60);
            doc.text(`Pain Level: ${assessmentData.intensity}`, 20, 67);
            doc.text(`Duration: ${assessmentData.duration}`, 20, 74);
            doc.text(`Recovery Estimate: ${assessmentData.intensity === 'severe' ? '6-12 weeks' : '2-4 weeks'}`, 20, 81);

            // Affected Activities
            doc.text('Affected Activities:', 20, 95);
            assessmentData.activities.forEach((activity, index) => {
                doc.text(`â€¢ ${activity}`, 25, 102 + (index * 7));
            });

            // Recommendations
            doc.setFontSize(14);
            doc.text('Recommendations', 20, 130);

            doc.setFontSize(11);
            const recommendations = [
                'â€¢ Consult with a professional physiotherapist',
                'â€¢ Follow prescribed exercise routine',
                'â€¢ Apply heat/ice therapy as recommended',
                'â€¢ Maintain proper posture and ergonomics',
                'â€¢ Gradual return to normal activities'
            ];

            recommendations.forEach((rec, index) => {
                doc.text(rec, 20, 140 + (index * 7));
            });

            // Footer
            doc.setFontSize(9);
            doc.setTextColor(150, 150, 150);
            doc.text('Generated by Physiosmetic AI Pain Assessment', 20, 280);
            doc.text('This report is for informational purposes only. Consult a healthcare professional.', 20, 285);

            doc.save(`Pain-Assessment-${Date.now()}.pdf`);

            speak('PDF downloaded successfully');
        }

        // SHARE WITH DOCTOR
        function shareWithDoctor() {
            const reportData = {
                ...assessmentData,
                summaryUrl: window.location.href
            };

            const emailSubject = encodeURIComponent('Pain Assessment Report');
            const emailBody = encodeURIComponent(
                `Pain Assessment Report\n\n` +
                `Affected Area: ${assessmentData.bodyPart}\n` +
                `Pain Level: ${assessmentData.intensity}\n` +
                `Duration: ${assessmentData.duration}\n` +
                `Recovery Estimate: ${assessmentData.intensity === 'severe' ? '6-12 weeks' : '2-4 weeks'}\n\n` +
                `Session ID: ${assessmentData.sessionId}\n` +
                `Date: ${new Date().toLocaleDateString()}`
            );

            window.location.href = `mailto:?subject=${emailSubject}&body=${emailBody}`;

            speak('Opening email to share with doctor');
        }

        // ========================================================================
        // ENHANCED REHAB PLAN FUNCTIONS
        // ========================================================================

        // Exercise database with different difficulty levels
        const exerciseDatabase = {
            back: {
                beginner: [
                    {
                        name: 'Gentle Cat-Cow Stretch',
                        icon: 'ðŸ±',
                        duration: '2 min',
                        reps: '10 reps',
                        sets: '2 sets',
                        description: 'A gentle spinal mobility exercise to warm up your back and improve flexibility.',
                        steps: [
                            'Start on hands and knees in tabletop position',
                            'Inhale and arch your back, dropping belly towards floor (Cow)',
                            'Exhale and round your spine, tucking chin to chest (Cat)',
                            'Move slowly and smoothly between positions',
                            'Focus on breathing and controlled movement'
                        ],
                        tips: 'Move gently and never force the stretch. Stop if you feel sharp pain.'
                    },
                    {
                        name: 'Pelvic Tilts',
                        icon: 'ðŸ”„',
                        duration: '3 min',
                        reps: '15 reps',
                        sets: '2 sets',
                        description: 'Strengthens core muscles and improves lower back stability.',
                        steps: [
                            'Lie on your back with knees bent, feet flat',
                            'Flatten your lower back against the floor',
                            'Engage your abdominal muscles',
                            'Hold for 5 seconds',
                            'Relax and repeat'
                        ],
                        tips: 'Breathe normally throughout the exercise. Quality over quantity.'
                    },
                    {
                        name: 'Knee-to-Chest Stretch',
                        icon: 'ðŸ¦µ',
                        duration: '2 min',
                        reps: 'Hold 30s each',
                        sets: '2 sets',
                        description: 'Relieves lower back tension and stretches hip muscles.',
                        steps: [
                            'Lie on your back with knees bent',
                            'Bring one knee towards your chest',
                            'Hold behind the thigh with both hands',
                            'Keep other foot flat on ground',
                            'Switch legs and repeat'
                        ],
                        tips: 'Keep your lower back flat on the floor throughout the stretch.'
                    }
                ],
                intermediate: [
                    {
                        name: 'Bird Dog Exercise',
                        icon: 'ðŸ•',
                        duration: '4 min',
                        reps: '10 each side',
                        sets: '3 sets',
                        description: 'Core stabilization exercise that strengthens back and abdominal muscles.',
                        steps: [
                            'Start in tabletop position',
                            'Extend right arm forward and left leg back',
                            'Keep hips level and core engaged',
                            'Hold for 5 seconds',
                            'Return to start and switch sides'
                        ],
                        tips: 'Focus on stability and control. Avoid rotating your hips.'
                    },
                    {
                        name: 'Bridge Exercise',
                        icon: 'ðŸŒ‰',
                        duration: '3 min',
                        reps: '12 reps',
                        sets: '3 sets',
                        description: 'Strengthens glutes, hamstrings, and lower back muscles.',
                        steps: [
                            'Lie on back with knees bent, feet hip-width apart',
                            'Lift hips off ground until body forms straight line',
                            'Squeeze glutes at top',
                            'Hold for 3 seconds',
                            'Lower slowly and repeat'
                        ],
                        tips: 'Push through heels and keep core engaged throughout movement.'
                    },
                    {
                        name: 'Superman Exercise',
                        icon: 'ðŸ¦¸',
                        duration: '3 min',
                        reps: '10 reps',
                        sets: '3 sets',
                        description: 'Strengthens the entire posterior chain including back extensors.',
                        steps: [
                            'Lie face down with arms extended overhead',
                            'Simultaneously lift arms, chest, and legs off ground',
                            'Hold for 3-5 seconds',
                            'Lower slowly with control',
                            'Rest briefly and repeat'
                        ],
                        tips: 'Start with small lifts and gradually increase range as you get stronger.'
                    }
                ],
                advanced: [
                    {
                        name: 'Plank with Leg Lift',
                        icon: 'ðŸ’ª',
                        duration: '5 min',
                        reps: '8 each side',
                        sets: '3 sets',
                        description: 'Advanced core exercise that challenges stability and strength.',
                        steps: [
                            'Start in forearm plank position',
                            'Engage core and keep body straight',
                            'Lift one leg off ground',
                            'Hold for 5 seconds',
                            'Switch legs and repeat'
                        ],
                        tips: 'Keep hips level throughout. If too challenging, reduce hold time.'
                    },
                    {
                        name: 'Romanian Deadlift',
                        icon: 'ðŸ‹ï¸',
                        duration: '6 min',
                        reps: '12 reps',
                        sets: '3 sets',
                        description: 'Strengthens hamstrings, glutes, and lower back with proper form.',
                        steps: [
                            'Stand with feet hip-width, holding light weights',
                            'Hinge at hips, keeping back straight',
                            'Lower weights along legs to mid-shin',
                            'Feel stretch in hamstrings',
                            'Return to standing by squeezing glutes'
                        ],
                        tips: 'Start with light weights. Focus on form before adding weight.'
                    }
                ]
            },
            neck: {
                beginner: [
                    {
                        name: 'Neck Rotations',
                        icon: 'ðŸ”„',
                        duration: '2 min',
                        reps: '10 each direction',
                        sets: '2 sets',
                        description: 'Improves neck mobility and reduces stiffness.',
                        steps: [
                            'Sit or stand with good posture',
                            'Slowly turn head to look over right shoulder',
                            'Hold for 5 seconds',
                            'Return to center',
                            'Repeat on left side'
                        ],
                        tips: 'Move slowly and never force the rotation. Stop if dizzy.'
                    },
                    {
                        name: 'Chin Tucks',
                        icon: 'ðŸ˜Œ',
                        duration: '2 min',
                        reps: '15 reps',
                        sets: '3 sets',
                        description: 'Strengthens deep neck flexors and improves posture.',
                        steps: [
                            'Sit upright with shoulders relaxed',
                            'Gently pull chin straight back',
                            'Create a "double chin"',
                            'Hold for 5 seconds',
                            'Relax and repeat'
                        ],
                        tips: 'Think about lengthening the back of your neck.'
                    }
                ],
                intermediate: [
                    {
                        name: 'Isometric Neck Strengthening',
                        icon: 'ðŸ’ª',
                        duration: '4 min',
                        reps: '10s hold each direction',
                        sets: '3 sets',
                        description: 'Builds neck strength without movement.',
                        steps: [
                            'Place hand on forehead',
                            'Press head forward against hand resistance',
                            'Hold for 10 seconds without moving',
                            'Repeat on back and both sides',
                            'Keep breathing throughout'
                        ],
                        tips: 'Use only 50% effort. Neck muscles fatigue quickly.'
                    }
                ]
            },
            shoulder: {
                beginner: [
                    {
                        name: 'Pendulum Stretch',
                        icon: 'â­•',
                        duration: '3 min',
                        reps: '20 circles each direction',
                        sets: '2 sets',
                        description: 'Gentle shoulder mobilization to reduce stiffness.',
                        steps: [
                            'Lean forward, supporting yourself with good arm',
                            'Let affected arm hang relaxed',
                            'Make small circles with hanging arm',
                            'Change direction after 20 circles',
                            'Keep movement gentle and controlled'
                        ],
                        tips: 'Let gravity do the work. Don\'t force movement.'
                    },
                    {
                        name: 'Wall Angels',
                        icon: 'ðŸ‘¼',
                        duration: '3 min',
                        reps: '12 reps',
                        sets: '2 sets',
                        description: 'Improves shoulder mobility and posture.',
                        steps: [
                            'Stand with back against wall',
                            'Raise arms to 90 degrees, elbows bent',
                            'Slide arms up wall maintaining contact',
                            'Lower slowly and repeat',
                            'Keep lower back flat against wall'
                        ],
                        tips: 'Move within comfortable range. Don\'t arch your back.'
                    }
                ],
                intermediate: [
                    {
                        name: 'Shoulder Blade Squeezes',
                        icon: 'ðŸ”²',
                        duration: '4 min',
                        reps: '15 reps',
                        sets: '3 sets',
                        description: 'Strengthens muscles between shoulder blades.',
                        steps: [
                            'Sit or stand with good posture',
                            'Pull shoulder blades back and together',
                            'Imagine squeezing a pencil between them',
                            'Hold for 5 seconds',
                            'Release slowly and repeat'
                        ],
                        tips: 'Don\'t shrug shoulders up. Keep them down and back.'
                    }
                ]
            }
        };

        // Generate exercises based on body part and difficulty
        function generateRehabPlan(bodyPart, difficulty = 'intermediate') {
            const exercises = exerciseDatabase[bodyPart]?.[difficulty] || exerciseDatabase.back.beginner;
            return exercises;
        }

        // Display rehab plan
        function displayRehabPlan() {
            const rehabContainer = document.getElementById('rehabPlanContainer');
            const exercisesGrid = document.getElementById('exercisesGrid');

            if (!rehabContainer || !exercisesGrid) return;

            // Update translations for rehab plan
            updateRehabTranslations();

            // Show rehab plan container with fade-in
            rehabContainer.style.display = 'block';

            // Get current body part and difficulty
            const bodyPart = assessmentData.bodyPart || 'back';
            const difficulty = document.getElementById('difficultySelector')?.value || 'intermediate';

            // Generate exercises
            const exercises = generateRehabPlan(bodyPart, difficulty);

            // Clear existing exercises
            exercisesGrid.innerHTML = '';

            // Create exercise cards with staggered animation
            exercises.forEach((exercise, index) => {
                const card = createExerciseCard(exercise, index);
                exercisesGrid.appendChild(card);
            });

            // Update progress
            updateRehabProgress();
        }

        // Update rehab plan translations
        function updateRehabTranslations() {
            const elements = {
                'rehabTitle': 'rehabTitle',
                'rehabSubtitle': 'rehabSubtitle',
                'progressText': 'rehabProgressText',
                'difficultyBeginner': 'rehabDifficultyBeginner',
                'difficultyIntermediate': 'rehabDifficultyIntermediate',
                'difficultyAdvanced': 'rehabDifficultyAdvanced',
                'downloadPlanText': 'rehabDownloadPlan',
                'sharePlanText': 'rehabSharePlan',
                'aiConnectNoticeText': 'rehabConnectAI',
                'connectAIText': 'rehabConnectButton'
            };

            for (const [elementId, translationKey] of Object.entries(elements)) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = t(translationKey);
                }
            }
        }

        // Create exercise card HTML
        function createExerciseCard(exercise, index) {
            const card = document.createElement('div');
            card.className = 'exercise-card';
            card.style.animationDelay = `${index * 0.1}s`;
            card.setAttribute('data-exercise-id', index);

            // Check if exercise is completed
            const isCompleted = assessmentData.completedExercises?.includes(index) || false;

            card.innerHTML = `
                <div class="exercise-header" onclick="toggleExerciseExpand(${index})">
                    <div class="exercise-header-left">
                        <div class="exercise-checkbox ${isCompleted ? 'checked' : ''}"
                             onclick="event.stopPropagation(); toggleExerciseComplete(${index})">
                        </div>
                        <div class="exercise-icon">${exercise.icon}</div>
                        <div class="exercise-info">
                            <h4 class="exercise-name">${exercise.name}</h4>
                            <div class="exercise-meta">
                                <span class="exercise-meta-item">
                                    <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:currentColor;">
                                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
                                        <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                    </svg>
                                    ${exercise.duration}
                                </span>
                                <span class="exercise-meta-item">
                                    <svg viewBox="0 0 24 24" style="width:14px;height:14px;fill:currentColor;">
                                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                                    </svg>
                                    ${exercise.reps}
                                </span>
                                ${exercise.sets ? `<span class="exercise-meta-item">${exercise.sets}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <span class="difficulty-badge ${document.getElementById('difficultySelector')?.value || 'intermediate'}">
                        ${document.getElementById('difficultySelector')?.value || 'intermediate'}
                    </span>
                    <svg class="expand-icon" viewBox="0 0 24 24">
                        <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/>
                    </svg>
                </div>
                <div class="exercise-content">
                    <div class="exercise-description">
                        ${exercise.description}
                    </div>
                    <div class="exercise-steps">
                        <div class="exercise-steps-title">How to perform:</div>
                        <ol>
                            ${exercise.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                    <div class="exercise-tips">
                        <div class="exercise-tips-title">
                            <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                            </svg>
                            Pro Tip
                        </div>
                        <div class="exercise-tips-content">${exercise.tips}</div>
                    </div>
                </div>
            `;

            return card;
        }

        // Toggle exercise expansion
        function toggleExerciseExpand(index) {
            const card = document.querySelector(`[data-exercise-id="${index}"]`);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        // Toggle exercise completion
        function toggleExerciseComplete(index) {
            // Initialize completed exercises array if not exists
            if (!assessmentData.completedExercises) {
                assessmentData.completedExercises = [];
            }

            const exerciseIndex = assessmentData.completedExercises.indexOf(index);

            if (exerciseIndex > -1) {
                // Remove from completed
                assessmentData.completedExercises.splice(exerciseIndex, 1);
            } else {
                // Add to completed
                assessmentData.completedExercises.push(index);
            }

            // Update checkbox visual
            const checkbox = document.querySelector(`[data-exercise-id="${index}"] .exercise-checkbox`);
            if (checkbox) {
                checkbox.classList.toggle('checked');
            }

            // Update progress
            updateRehabProgress();

            // Save session
            saveSession();
        }

        // Update progress bar
        function updateRehabProgress() {
            const totalExercises = document.querySelectorAll('.exercise-card').length;
            const completedExercises = assessmentData.completedExercises?.length || 0;
            const percentage = totalExercises > 0 ? Math.round((completedExercises / totalExercises) * 100) : 0;

            const progressFill = document.getElementById('progressBarFill');
            const progressPercentage = document.getElementById('progressPercentage');

            if (progressFill) {
                progressFill.style.width = `${percentage}%`;
            }

            if (progressPercentage) {
                progressPercentage.textContent = `${percentage}%`;
            }
        }

        // Update difficulty
        function updateRehabDifficulty(difficulty) {
            displayRehabPlan();
            speak(`Difficulty changed to ${difficulty}`);
        }

        // Regenerate plan
        function regenerateRehabPlan() {
            speak('Regenerating rehabilitation plan');

            // Clear completed exercises
            assessmentData.completedExercises = [];

            // Regenerate plan
            displayRehabPlan();
        }

        // Download rehab plan as PDF
        function downloadRehabPlan() {
            speak('Preparing your rehabilitation plan for download');

            // Reuse existing downloadPDF function but focus on rehab plan
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.setTextColor(243, 112, 33);
            doc.text('Rehabilitation Plan', 20, 20);

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Body Part: ${assessmentData.bodyPart || 'Back'}`, 20, 35);
            doc.text(`Difficulty: ${document.getElementById('difficultySelector')?.value || 'Intermediate'}`, 20, 42);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 49);

            const bodyPart = assessmentData.bodyPart || 'back';
            const difficulty = document.getElementById('difficultySelector')?.value || 'intermediate';
            const exercises = generateRehabPlan(bodyPart, difficulty);

            let yPos = 65;
            exercises.forEach((exercise, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`${index + 1}. ${exercise.name}`, 20, yPos);
                yPos += 7;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Duration: ${exercise.duration} | Reps: ${exercise.reps}`, 25, yPos);
                yPos += 7;

                const descLines = doc.splitTextToSize(exercise.description, 170);
                doc.text(descLines, 25, yPos);
                yPos += descLines.length * 5 + 5;
            });

            doc.save(`Rehab-Plan-${new Date().getTime()}.pdf`);
        }

        // Share rehab plan
        function shareRehabPlan() {
            const bodyPart = assessmentData.bodyPart || 'Back';
            const difficulty = document.getElementById('difficultySelector')?.value || 'intermediate';

            const subject = encodeURIComponent(`Rehabilitation Plan - ${bodyPart}`);
            const body = encodeURIComponent(
                `My Rehabilitation Plan\n\n` +
                `Body Part: ${bodyPart}\n` +
                `Difficulty Level: ${difficulty}\n` +
                `Date: ${new Date().toLocaleDateString()}\n\n` +
                `View full plan: ${window.location.href}`
            );

            window.location.href = `mailto:?subject=${subject}&body=${body}`;
            speak('Opening email to share your rehabilitation plan');
        }

        // CHART.JS VISUALIZATIONS
        function showCharts() {
            const recoveryChart = document.getElementById('recoveryChart');
            const confidenceChart = document.getElementById('confidenceChart');

            if (recoveryChart) recoveryChart.style.display = 'block';
            if (confidenceChart) confidenceChart.style.display = 'block';

            setTimeout(() => createForecastChart(), 500);
            setTimeout(() => createConfidenceChart(), 1000);
        }

        function createForecastChart() {
            const canvas = document.getElementById('forecastCanvas');
            if (!canvas) {
                console.error('Forecast canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            const weeks = assessmentData.intensity === 'severe' ? 12 : 6;
            const labels = Array.from({length: weeks}, (_, i) => `Week ${i + 1}`);
            const data = Array.from({length: weeks}, (_, i) => {
                const progress = (i + 1) / weeks;
                return Math.min(100, 10 + (90 * Math.pow(progress, 0.7)));
            });

            forecastChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Recovery Progress (%)',
                        data: data,
                        borderColor: 'rgba(243, 112, 33, 1)',
                        backgroundColor: 'rgba(243, 112, 33, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgba(243, 112, 33, 1)',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    family: 'Inter',
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 15, 25, 0.95)',
                            titleColor: 'rgba(243, 112, 33, 1)',
                            bodyColor: 'rgba(255, 255, 255, 0.9)',
                            borderColor: 'rgba(243, 112, 33, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return `Recovery: ${Math.round(context.parsed.y)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function createConfidenceChart() {
            const canvas = document.getElementById('confidenceCanvas');
            if (!canvas) {
                console.error('Confidence canvas not found');
                return;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) return;

            const confidence = 85 + Math.floor(Math.random() * 10);
            const remaining = 100 - confidence;

            confidenceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Confidence', 'Margin'],
                    datasets: [{
                        data: [confidence, remaining],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(255, 255, 255, 0.05)'
                        ],
                        borderColor: [
                            'rgba(16, 185, 129, 1)',
                            'rgba(255, 255, 255, 0.1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(10, 15, 25, 0.95)',
                            titleColor: 'rgba(16, 185, 129, 1)',
                            bodyColor: 'rgba(255, 255, 255, 0.9)',
                            borderColor: 'rgba(16, 185, 129, 0.5)',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed}%`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                },
                plugins: [{
                    id: 'centerText',
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        ctx.save();
                        const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                        const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;

                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = 'bold 32px Space Grotesk';
                        ctx.fillStyle = 'rgba(16, 185, 129, 1)';
                        ctx.fillText(`${confidence}%`, centerX, centerY - 10);

                        ctx.font = '14px Inter';
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.fillText('Confidence', centerX, centerY + 20);
                        ctx.restore();
                    }
                }]
            });
        }

        // DAILY TIPS
        const tipsDatabase = {
            neck: {
                mild: [
                    { icon: 'M12 2l-5 9h10l-5-9zm0 3.84L13.93 9h-3.87L12 5.84z', title: 'Gentle Stretches', text: 'Perform neck rotations every 2 hours - 10 reps each direction' },
                    { icon: 'M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4z', title: 'Ergonomic Setup', text: 'Position screen at eye level to reduce neck strain' },
                    { icon: 'M12 2C8.69 2 6 4.69 6 8c0 1.5.55 2.86 1.46 3.91-.07.14-.16.28-.23.42-.19.38-.28.77-.28 1.17 0 .66.15 1.29.43 1.88L9 19h6l1.62-3.62c.28-.59.43-1.22.43-1.88 0-.4-.09-.79-.28-1.17-.07-.14-.16-.28-.23-.42C17.45 10.86 18 9.5 18 8c0-3.31-2.69-6-6-6z', title: 'Heat Therapy', text: 'Apply warm compress for 15 minutes, 3x daily' }
                ],
                severe: [
                    { icon: 'M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z', title: 'Ice Application', text: 'Apply ice pack for 15-20 minutes every 3-4 hours' },
                    { icon: 'M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z', title: 'Sleep Position', text: 'Use a supportive pillow that keeps neck neutral' },
                    { icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z', title: 'Avoid Strain', text: 'Minimize looking down at phone - hold at eye level' }
                ]
            },
            // Add more body parts as needed
        };

        function generateDailyTips() {
            const tipsGrid = document.getElementById('tipsGrid');
            const dailyTips = document.getElementById('dailyTips');

            if (!tipsGrid) {
                console.error('Tips grid not found');
                return;
            }

            const bodyPart = assessmentData.bodyPart || 'neck';
            const severity = assessmentData.intensity === 'severe' ? 'severe' : 'mild';

            const tips = tipsDatabase[bodyPart]?.[severity] || tipsDatabase.neck?.mild || [];

            tipsGrid.innerHTML = '';

            tips.forEach((tip, index) => {
                setTimeout(() => {
                    const tipCard = document.createElement('div');
                    tipCard.className = 'tip-card';
                    tipCard.style.animation = `slideIn 0.5s ease ${index * 0.2}s both`;

                    tipCard.innerHTML = `
                        <div class="tip-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="${tip.icon || ''}"/>
                            </svg>
                        </div>
                        <div class="tip-content">
                            <div class="tip-title">${tip.title || ''}</div>
                            <div class="tip-text">${tip.text || ''}</div>
                        </div>
                    `;

                    if (tipsGrid) {
                        tipsGrid.appendChild(tipCard);
                    }
                }, index * 300);
            });

            if (dailyTips) dailyTips.style.display = 'block';
        }

        // FOLLOW-UP QUESTIONS
        // Conversation history for follow-up chat
        let followUpConversation = [];
        let mediaRecorder = null;
        let audioChunks = [];

        // OPENAI WHISPER VOICE INPUT
        async function startVoiceInput() {
            const micBtn = document.getElementById('micBtn');
            const followUpInput = document.getElementById('followUpInput');

            // If already recording, stop
            if (micBtn.classList.contains('recording')) {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                micBtn.classList.remove('recording');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener('stop', async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

                    // Convert to format suitable for Whisper API
                    const formData = new FormData();
                    formData.append('file', audioBlob, 'recording.webm');
                    formData.append('model', API_CONFIG.whisper.model);
                    formData.append('language', assessmentData.currentLanguage);

                    // Show processing state
                    followUpInput.placeholder = 'Transcribing...';
                    followUpInput.disabled = true;

                    try {
                        if (API_CONFIG.openai.key) {
                            const response = await fetch(API_CONFIG.whisper.endpoint, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${API_CONFIG.openai.key}`
                                },
                                body: formData
                            });

                            if (response.ok) {
                                const data = await response.json();
                                followUpInput.value = data.text;
                                followUpInput.disabled = false;
                                followUpInput.placeholder = t('followUpPlaceholder');

                                // Auto-submit the transcribed text
                                setTimeout(() => askFollowUp(), 500);
                            } else {
                                console.error('Whisper API error:', await response.text());
                                alert('Voice transcription failed. Please check your API key.');
                                followUpInput.disabled = false;
                                followUpInput.placeholder = t('followUpPlaceholder');
                            }
                        } else {
                            alert('OpenAI API key required for voice input.');
                            followUpInput.disabled = false;
                            followUpInput.placeholder = t('followUpPlaceholder');
                        }
                    } catch (error) {
                        console.error('Error transcribing audio:', error);
                        alert('Voice transcription failed: ' + error.message);
                        followUpInput.disabled = false;
                        followUpInput.placeholder = t('followUpPlaceholder');
                    }

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                });

                mediaRecorder.start();
                micBtn.classList.add('recording');
                followUpInput.placeholder = 'Recording... Click mic to stop';

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Could not access microphone. Please check permissions.');
            }
        }

        async function askFollowUp() {
            const input = document.getElementById('followUpInput');
            const question = input.value.trim();

            if (!question) return;

            const chatContainer = document.getElementById('followUpChatContainer');
            input.value = '';
            input.disabled = true;

            // Add user message to UI
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message-user';
            userMessage.textContent = question;
            chatContainer.appendChild(userMessage);

            // Add to conversation history
            followUpConversation.push({
                role: 'user',
                content: question
            });

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-typing-indicator';
            typingIndicator.id = 'followUpTyping';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(typingIndicator);

            // Scroll to show typing indicator
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Call OpenAI API with conversation context
            let answer = `Based on your ${assessmentData.bodyPart} pain assessment, I recommend consulting with a healthcare professional for personalized advice.`;

            try {
                if (API_CONFIG.openai.key) {
                    // Build context message
                    const contextMessage = `Patient has ${assessmentData.intensityLabel} ${assessmentData.bodyPart} pain for ${assessmentData.duration}. Pain type: ${assessmentData.painType || 'unspecified'}. Frequency: ${assessmentData.painFrequency || 'unspecified'}. Activities affected: ${assessmentData.activities.join(', ') || 'none specified'}.`;

                    const messages = [
                        {
                            role: 'system',
                            content: 'You are an expert physiotherapist assistant. Provide helpful, evidence-based advice about pain management and exercises. Keep responses concise (2-3 sentences) and friendly.'
                        },
                        {
                            role: 'assistant',
                            content: contextMessage
                        },
                        ...followUpConversation
                    ];

                    const response = await fetch(API_CONFIG.openai.endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_CONFIG.openai.key}`
                        },
                        body: JSON.stringify({
                            model: API_CONFIG.openai.model,
                            messages: messages,
                            max_tokens: 200,
                            temperature: 0.7
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        answer = data.choices[0].message.content.trim();
                    }
                }
            } catch (error) {
                console.error('Error getting follow-up response:', error);
            }

            // Remove typing indicator
            setTimeout(() => {
                const typing = document.getElementById('followUpTyping');
                if (typing) typing.remove();

                // Add AI response
                const aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message-ai';
                aiMessage.textContent = answer;
                chatContainer.appendChild(aiMessage);

                // Add to conversation history
                followUpConversation.push({
                    role: 'assistant',
                    content: answer
                });

                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;

                // Re-enable input
                input.disabled = false;
                input.focus();

                // Speak the response
                if (assessmentData.voiceEnabled) {
                    speak(answer);
                }
            }, 1500);
        }

        // FEEDBACK
        function submitFeedback(type) {
            document.querySelectorAll('.feedback-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.feedback-btn').classList.add('selected');

            document.getElementById('feedbackMessage').style.display = 'block';

            // Send to API
            callAPI('submitFeedback', {
                sessionId: assessmentData.sessionId,
                feedback: type,
                data: assessmentData
            });

            speak('Thank you for your feedback');
        }

        // LANGUAGE SWITCHING (Simplified)
        // TRANSLATION HELPER FUNCTION
        function t(key, lang = null) {
            // Use provided language or current language
            const targetLang = lang || assessmentData.currentLanguage;

            // Normalize language code (e.g., "mr-IN" â†’ "mr")
            const normalizedLang = normalizeLangCode(targetLang);

            // Ensure TRANSLATIONS is loaded
            if (typeof TRANSLATIONS === 'undefined') {
                console.warn('TRANSLATIONS not loaded');
                return key;
            }

            // Try current language, fallback to English, then return key
            return TRANSLATIONS[normalizedLang]?.[key] || TRANSLATIONS.en?.[key] || key;
        }

        // Normalize language code helper
        function normalizeLangCode(code) {
            if (!code) return 'en';
            // Extract base language code (mr-IN â†’ mr, en-US â†’ en)
            return code.split('-')[0].toLowerCase();
        }

        function applyTranslations(lang = null) {
            console.log('ðŸŒ applyTranslations() START');
            console.log('  Input lang:', lang);

            // Use specified language or current language
            const targetLang = lang || assessmentData.currentLanguage;
            const normalizedLang = normalizeLangCode(targetLang);
            console.log('  Target lang:', targetLang, 'â†’ Normalized:', normalizedLang);

            // Ensure we're using the normalized language
            if (assessmentData.currentLanguage !== normalizedLang) {
                assessmentData.currentLanguage = normalizedLang;
            }

            // Test translation function
            const testTranslation = t('headerTitle', normalizedLang);
            console.log('  Test translation t("headerTitle"):', testTranslation);

            // Header
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            if (headerTitle) {
                const newText = t('headerTitle');
                console.log('  ðŸ” headerTitle translation: EN="' + TRANSLATIONS.en.headerTitle + '" â†’ ' + normalizedLang + '="' + newText + '"');
                headerTitle.textContent = newText;
                console.log('  âœ… Updated headerTitle element to:', headerTitle.textContent);
            } else {
                console.error('  âŒ headerTitle element NOT FOUND!');
            }
            if (headerSubtitle) {
                const newText = t('headerSubtitle');
                headerSubtitle.textContent = newText;
                console.log('  âœ… Updated headerSubtitle to:', headerSubtitle.textContent);
            }

            // Step titles and descriptions
            const step1Title = document.getElementById('step1Title');
            const step1Description = document.getElementById('step1Description');
            const step2Title = document.getElementById('step2Title');
            const step2Description = document.getElementById('step2Description');
            const step3Title = document.getElementById('step3Title');
            const step3Description = document.getElementById('step3Description');

            if (step1Title) {
                step1Title.textContent = t('step1Title');
                console.log('  âœ… Updated step1Title to:', step1Title.textContent);
            }
            if (step1Description) step1Description.textContent = t('step1Description');
            if (step2Title) step2Title.textContent = t('step2Title');
            if (step2Description) step2Description.textContent = t('step2Description');
            if (step3Title) step3Title.textContent = t('step3Title');
            if (step3Description) step3Description.textContent = t('step3Description');

            // Step 3 form labels
            document.querySelectorAll('.input-label').forEach((label, index) => {
                const labels = ['painFrequencyLabel', 'painTypeLabel', 'durationMonthsLabel', 'activityTriggersLabel', 'additionalNotesLabel'];
                if (labels[index]) {
                    label.textContent = t(labels[index]);
                }
            });

            // Pain frequency options
            const painFrequency = document.getElementById('painFrequency');
            if (painFrequency) {
                painFrequency.options[0].text = t('painFrequencyPlaceholder');
                painFrequency.options[1].text = t('painFrequencyOccasional');
                painFrequency.options[2].text = t('painFrequencyFrequent');
                painFrequency.options[3].text = t('painFrequencyConstant');
            }

            // Pain type labels
            const painTypeLabels = document.querySelectorAll('.radio-label span');
            const painTypes = ['painTypeDull', 'painTypeSharp', 'painTypeThrobbing', 'painTypeBurning'];
            painTypeLabels.forEach((span, index) => {
                if (painTypes[index]) {
                    span.textContent = t(painTypes[index]);
                }
            });

            // Activity triggers
            const triggerLabels = document.querySelectorAll('.checkbox-label span');
            const triggers = ['triggerWalking', 'triggerSitting', 'triggerSleeping', 'triggerExercise', 'triggerStanding', 'triggerBending'];
            triggerLabels.forEach((span, index) => {
                if (triggers[index]) {
                    span.textContent = t(triggers[index]);
                }
            });

            // Additional notes placeholder
            const additionalNotes = document.getElementById('additionalNotes');
            if (additionalNotes) {
                additionalNotes.placeholder = t('additionalNotesPlaceholder');
            }

            // Subsection
            const subsectionTitle = document.querySelector('.subsection-title');
            if (subsectionTitle) {
                subsectionTitle.textContent = t('subsectionTitle');
            }

            // Activity cards
            const activityWork = document.getElementById('activityWork');
            const activityExercise = document.getElementById('activityExercise');
            const activitySleep = document.getElementById('activitySleep');
            const activityDaily = document.getElementById('activityDaily');

            if (activityWork) activityWork.textContent = t('activityWork');
            if (activityExercise) activityExercise.textContent = t('activityExercise');
            if (activitySleep) activitySleep.textContent = t('activitySleep');
            if (activityDaily) activityDaily.textContent = t('activityDaily');

            // Navigation buttons
            const backBtnText = document.getElementById('backBtnText');
            if (backBtnText) backBtnText.textContent = t('backBtn');

            // Loading screen
            const loadingText = document.getElementById('loadingText');
            const loadingSubtext = document.getElementById('loadingSubtext');
            if (loadingText) loadingText.textContent = t('loadingText');
            if (loadingSubtext) loadingSubtext.textContent = t('loadingSubtext');

            // Follow-up section
            const followUpTitle = document.querySelector('.follow-up-title');
            const followUpInput = document.getElementById('followUpInput');
            if (followUpTitle) followUpTitle.textContent = t('followUpTitle');
            if (followUpInput) followUpInput.placeholder = t('followUpPlaceholder');

            // Update duration slider display with current language
            const durationValue = document.getElementById('durationValue');
            const durationSlider = document.getElementById('durationSlider');
            if (durationValue && durationSlider) {
                const value = parseInt(durationSlider.value) || assessmentData.durationMonths || 3;
                durationValue.textContent = value === 1 ? `1 ${t('month')}` : `${value} ${t('months')}`;
                console.log('ðŸ”„ Updated duration label for language change:', durationValue.textContent);
            }

            // Update duration option cards in Step 2
            const durationHours = document.getElementById('durationHours');
            const durationDays = document.getElementById('durationDays');
            const durationWeeks = document.getElementById('durationWeeks');
            const durationMonthsText = document.getElementById('durationMonths');
            if (durationHours) durationHours.textContent = t('durationHours');
            if (durationDays) durationDays.textContent = t('durationDays');
            if (durationWeeks) durationWeeks.textContent = t('durationWeeks');
            if (durationMonthsText) durationMonthsText.textContent = t('durationMonths');

            // Update next button text based on current step
            updateNextButton();
        }

        // ==================== LANGUAGE SYSTEM (2 Languages) ====================
        function setupLanguages() {
            console.log('ðŸŽ¨ setupLanguages() called');
            console.log('ðŸŒ Current regionalLanguage value:', regionalLanguage);
            // Build 2-language buttons: EN, HI only
            const stickyLangBar = document.getElementById('stickyLangBar');
            if (!stickyLangBar) {
                console.error('âŒ stickyLangBar element not found!');
                return;
            }
            console.log('âœ… Found stickyLangBar element');

            // Clear existing buttons
            stickyLangBar.innerHTML = '';
            console.log('ðŸ—‘ï¸ Cleared existing language buttons');

            // Language configurations with flag emojis
            const languages = [
                { code: 'en', name: 'EN', flag: 'ðŸ‡¬ðŸ‡§', fullName: 'English' },
                { code: 'hi', name: 'à¤¹à¤¿à¤‚', flag: 'ðŸ‡®ðŸ‡³', fullName: 'Hindi' }
            ];
            console.log('ðŸ“ Base languages added: EN, HI');

            // Add regional language if detected and different from EN/HI
            // IMPORTANT: Only add if we actually have translations for it!
            if (regionalLanguage && regionalLanguage !== 'en' && regionalLanguage !== 'hi') {
                console.log('âœ… regionalLanguage is truthy and unique:', regionalLanguage);

                // Check if translations exist for this language
                const hasTranslations = typeof TRANSLATIONS !== 'undefined' && TRANSLATIONS[regionalLanguage];
                console.log('ðŸ“š Does TRANSLATIONS have', regionalLanguage, '?', hasTranslations);

                if (!hasTranslations) {
                    console.warn('âš ï¸âš ï¸âš ï¸ CRITICAL: No translations loaded for', regionalLanguage);
                    console.log('   Available languages in TRANSLATIONS:', typeof TRANSLATIONS !== 'undefined' ? Object.keys(TRANSLATIONS) : 'TRANSLATIONS not loaded');
                    console.log('   The third button will appear but WON\'T work because translations don\'t exist!');
                    console.log('   Solution: Add', regionalLanguage, 'to translations.js OR configure OpenAI API key');
                }

                const regionalConfig = {
                    // Indian languages
                    'mr': { code: 'mr', name: 'à¤®à¤°à¤¾à¤ à¥€', flag: 'ðŸ‡®ðŸ‡³', fullName: 'Marathi' },
                    'ta': { code: 'ta', name: 'à®¤à®®à®¿à®´à¯', flag: 'ðŸ‡®ðŸ‡³', fullName: 'Tamil' },
                    'gu': { code: 'gu', name: 'àª—à«àªœàª°àª¾àª¤à«€', flag: 'ðŸ‡®ðŸ‡³', fullName: 'Gujarati' },
                    'kn': { code: 'kn', name: 'à²•à²¨à³à²¨à²¡', flag: 'ðŸ‡®ðŸ‡³', fullName: 'Kannada' },
                    'te': { code: 'te', name: 'à°¤à±†à°²à±à°—à±', flag: 'ðŸ‡®ðŸ‡³', fullName: 'Telugu' },
                    'bn': { code: 'bn', name: 'à¦¬à¦¾à¦‚à¦²à¦¾', flag: 'ðŸ‡®ðŸ‡³', fullName: 'Bengali' },
                    'ml': { code: 'ml', name: 'à´®à´²à´¯à´¾à´³à´‚', flag: 'ðŸ‡®ðŸ‡³', fullName: 'Malayalam' },
                    'pa': { code: 'pa', name: 'à¨ªà©°à¨œà¨¾à¨¬à©€', flag: 'ðŸ‡®ðŸ‡³', fullName: 'Punjabi' },
                    // International languages
                    'ar': { code: 'ar', name: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', flag: 'ðŸ‡¸ðŸ‡¦', fullName: 'Arabic' },
                    'es': { code: 'es', name: 'EspaÃ±ol', flag: 'ðŸ‡ªðŸ‡¸', fullName: 'Spanish' },
                    'fr': { code: 'fr', name: 'FranÃ§ais', flag: 'ðŸ‡«ðŸ‡·', fullName: 'French' },
                    'de': { code: 'de', name: 'Deutsch', flag: 'ðŸ‡©ðŸ‡ª', fullName: 'German' },
                    'pt': { code: 'pt', name: 'PortuguÃªs', flag: 'ðŸ‡µðŸ‡¹', fullName: 'Portuguese' },
                    'ru': { code: 'ru', name: 'Ð ÑƒÑÑÐºÐ¸Ð¹', flag: 'ðŸ‡·ðŸ‡º', fullName: 'Russian' },
                    'zh': { code: 'zh', name: 'ä¸­æ–‡', flag: 'ðŸ‡¨ðŸ‡³', fullName: 'Chinese' },
                    'ja': { code: 'ja', name: 'æ—¥æœ¬èªž', flag: 'ðŸ‡¯ðŸ‡µ', fullName: 'Japanese' },
                    'ko': { code: 'ko', name: 'í•œêµ­ì–´', flag: 'ðŸ‡°ðŸ‡·', fullName: 'Korean' }
                };

                // ALWAYS add the button - translations will be generated on click if needed
                if (regionalConfig[regionalLanguage]) {
                    console.log('âœ… Found regional config for:', regionalLanguage);
                    languages.push(regionalConfig[regionalLanguage]);
                    console.log('âœ… Added third language button:', regionalConfig[regionalLanguage].fullName, 'with label:', regionalConfig[regionalLanguage].name);

                    if (!hasTranslations) {
                        console.warn('âš ï¸ Note: Translations for', regionalLanguage, 'will be generated when button is clicked');
                        console.log('   AI will generate translations if OpenAI API key is configured');
                    } else {
                        console.log('âœ… Translations already available for', regionalLanguage);
                    }
                } else {
                    // No config - add generic button
                    console.warn('âš ï¸ No predefined config for:', regionalLanguage, '- adding generic button');
                    const langName = regionalLanguage.toUpperCase();
                    languages.push({
                        code: regionalLanguage,
                        name: langName,
                        flag: 'ðŸŒ',
                        fullName: langName
                    });
                    console.log('âœ… Added generic third language button:', langName);

                    if (!hasTranslations) {
                        console.warn('âš ï¸ Note: Translations will be generated when button is clicked');
                    }
                }
            } else {
                console.log('â„¹ï¸ No regional language configured, showing only 2 buttons (EN, HI)');
            }

            console.log('ðŸ“Š Total languages to render:', languages.length);
            console.log('ðŸ”¤ Languages array:', languages);

            // Create buttons
            languages.forEach((lang, index) => {
                const btn = document.createElement('button');
                btn.className = 'sticky-lang-btn';
                btn.setAttribute('data-lang', lang.code);
                btn.setAttribute('title', lang.fullName);
                btn.onclick = async () => await switchLanguage(lang.code);

                // Add flag and name
                btn.innerHTML = `<span class="lang-flag">${lang.flag}</span> ${lang.name}`;

                // Set active state
                if (lang.code === assessmentData.currentLanguage) {
                    btn.classList.add('active');
                }

                stickyLangBar.appendChild(btn);
                console.log(`âœ… Created button ${index + 1}:`, lang.fullName, '| Active:', lang.code === assessmentData.currentLanguage);
            });
            console.log('âœ… setupLanguages() completed. Total buttons created:', languages.length);
        }

        async function switchLanguage(lang) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ”„ switchLanguage() START - called with:', lang);
            console.log('ðŸ“Š Current assessmentData.currentLanguage:', assessmentData.currentLanguage);

            // Normalize language code (e.g., ar-SA â†’ ar, mr-IN â†’ mr)
            const normalizedLang = normalizeLangCode(lang);
            console.log('âœ… Normalized language code:', normalizedLang);

            // Update current language
            assessmentData.currentLanguage = normalizedLang;
            localStorage.setItem('preferred_language', normalizedLang);
            console.log('ðŸ’¾ Saved language preference to localStorage:', normalizedLang);
            console.log('ðŸ’¾ Updated assessmentData.currentLanguage to:', assessmentData.currentLanguage);

            // Check if translations exist for this language
            console.log('ðŸ” Checking if TRANSLATIONS object exists...');
            if (typeof TRANSLATIONS !== 'undefined') {
                console.log('âœ… TRANSLATIONS object is loaded');
                console.log('ðŸ“š Available languages in TRANSLATIONS:', Object.keys(TRANSLATIONS));

                if (TRANSLATIONS[normalizedLang]) {
                    console.log('âœ… Translations available for:', normalizedLang);
                    console.log('ðŸ“Š Sample translation keys:', Object.keys(TRANSLATIONS[normalizedLang]).slice(0, 10));
                    console.log('ðŸ“Š Sample translations:');
                    console.log('  - headerTitle:', TRANSLATIONS[normalizedLang].headerTitle);
                    console.log('  - step1Title:', TRANSLATIONS[normalizedLang].step1Title);
                } else {
                    console.warn('âš ï¸ No translations found for:', normalizedLang);

                    // Try to generate translations if not English
                    if (normalizedLang !== 'en') {
                        console.log('ðŸ§  Attempting to generate translation for:', normalizedLang);

                        // Show loading indicator with progress
                        const headerTitle = document.getElementById('headerTitle');
                        const originalHeaderText = headerTitle ? headerTitle.textContent : '';

                        if (headerTitle) {
                            headerTitle.textContent = 'ðŸŒ Translating interface... [0% done]';
                        }

                        // Progress callback to update UI
                        const updateProgress = (progress) => {
                            if (headerTitle) {
                                headerTitle.textContent = `ðŸŒ Translating interface... [${progress}% done]`;
                            }
                        };

                        // Auto-hide loading message after 5 seconds regardless of outcome
                        const autoHideTimer = setTimeout(() => {
                            if (headerTitle && headerTitle.textContent.includes('Translating interface')) {
                                console.log('â° Auto-hiding translation banner after 5 seconds');
                                // Try to get the translated title, or fall back to English
                                if (TRANSLATIONS[normalizedLang] && TRANSLATIONS[normalizedLang].headerTitle) {
                                    headerTitle.textContent = TRANSLATIONS[normalizedLang].headerTitle;
                                } else {
                                    headerTitle.textContent = 'AI-Powered Pain Assessment';
                                }
                            }
                        }, 5000);

                        console.log('ðŸŒ Starting hybrid translation (DeepL + MyMemory)...');
                        const newTranslation = await generateDynamicTranslation(normalizedLang, updateProgress);

                        // Clear auto-hide timer since we're done
                        clearTimeout(autoHideTimer);

                        if (newTranslation) {
                            console.log('âœ… Successfully generated translation for:', normalizedLang);
                            console.log('ðŸŽ‰ Translation is now available! Applying to UI...');

                            // Clear loading message immediately on success with fade effect
                            if (headerTitle && TRANSLATIONS[normalizedLang] && TRANSLATIONS[normalizedLang].headerTitle) {
                                headerTitle.textContent = 'âœ… Translation complete!';
                                // Fade to actual translated title after 500ms
                                setTimeout(() => {
                                    headerTitle.textContent = TRANSLATIONS[normalizedLang].headerTitle;
                                }, 500);
                            }

                            // NOW translations exist in TRANSLATIONS[normalizedLang]
                            // Continue to apply them below
                        } else {
                            console.warn('âš ï¸ Translation generation failed');
                            console.log('ðŸ’¡ Translation API may be temporarily unavailable');

                            // Clear loading message and show error
                            if (headerTitle) {
                                headerTitle.textContent = 'AI-Powered Pain Assessment (Translation service temporarily unavailable)';
                                setTimeout(() => {
                                    headerTitle.textContent = 'AI-Powered Pain Assessment';
                                }, 3000);
                            }

                            // Don't continue - stay in current language
                            return;
                        }
                    }
                }
            } else {
                console.error('âŒ TRANSLATIONS object is NOT loaded!');
                return;
            }

            // Rebuild language buttons to update active state
            console.log('ðŸŽ¨ Rebuilding language buttons to update active state...');
            setupLanguages();
            console.log('âœ… Language buttons rebuilt');

            // Re-apply all translations globally (explicitly pass language for fallback)
            console.log('ðŸŒ Applying translations for:', normalizedLang);
            applyTranslations(normalizedLang);
            console.log('âœ… Translations applied');

            // Update all UI text elements
            console.log('ðŸ”„ Updating UI text elements...');
            updateUIText();
            console.log('âœ… UI text updated');

            // Re-render dynamic content with new language
            if (assessmentData.selectedParts && assessmentData.selectedParts.length > 0) {
                console.log('ðŸ“ Re-rendering multi-part selection UI');
                // Multi-part or single-part selection
                updateSelectedParts();
                showSelectedPartsDisplay();
                renderImpactForMultipleParts(assessmentData.selectedParts);
            } else if (assessmentData.bodyPart && CONTEXT_MATRIX[assessmentData.bodyPart]) {
                console.log('ðŸ“ Re-rendering single part UI');
                // Legacy single part
                renderDynamicSections(assessmentData.bodyPart);
                renderImpactOptions();
            }

            saveSession();

            // Speak confirmation
            speak(t('headerTitle'));

            // Auto-scroll to current section
            autoScrollToCurrentSection();

            // Visual confirmation - flash the header to show language changed
            if (headerTitle) {
                headerTitle.style.transition = 'all 0.3s ease';
                headerTitle.style.backgroundColor = 'rgba(0, 242, 255, 0.3)';
                setTimeout(() => {
                    headerTitle.style.backgroundColor = 'transparent';
                }, 300);
            }

            console.log('âœ… Language switch completed to:', normalizedLang);
            console.log('ðŸŽ¯ FINAL CHECK - headerTitle.textContent is now:', document.getElementById('headerTitle')?.textContent);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        }

        function updateUIText() {
            console.log('ðŸ”„ updateUIText() called');
            console.log('ðŸŒ Current language:', assessmentData.currentLanguage);

            // Force re-translation of all visible text
            // This is called after language switch to ensure everything updates

            // Update all elements with data-i18n attribute
            const translatableElements = document.querySelectorAll('[data-i18n]');
            console.log(`ðŸ“ Found ${translatableElements.length} elements with data-i18n`);

            translatableElements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key) {
                    const translation = t(key);
                    if (translation !== key) { // Only update if translation exists
                        el.textContent = translation;
                        console.log(`âœ… Translated [${key}] to: ${translation.substring(0, 30)}...`);
                    }
                }
            });

            // Update navigation buttons
            const prevButtons = document.querySelectorAll('.prev-button, .btn-prev');
            const nextButtons = document.querySelectorAll('.next-button, .btn-next');
            prevButtons.forEach(btn => {
                if (btn.textContent && !btn.querySelector('svg')) {
                    btn.textContent = t('prevButton') || 'Previous';
                }
            });
            nextButtons.forEach(btn => {
                if (btn.textContent && !btn.querySelector('svg')) {
                    btn.textContent = t('nextButton') || 'Next';
                }
            });

            // Update any other dynamic UI elements
            const submitButtons = document.querySelectorAll('[type="submit"], .submit-button');
            submitButtons.forEach(btn => {
                if (btn.dataset.translateKey) {
                    btn.textContent = t(btn.dataset.translateKey);
                }
            });

            console.log('âœ… UI text updated for language:', assessmentData.currentLanguage);
        }

        // ==================== AUTO-SCROLL ====================
        function autoScrollToCurrentSection() {
            const currentStep = assessmentData.currentStep;
            const stepElement = document.getElementById(`step${currentStep}`);

            if (stepElement && stepElement.style.display !== 'none') {
                setTimeout(() => {
                    stepElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 300);
            }
        }

        // ==================== MUTATION OBSERVER FOR DYNAMIC CONTENT ====================
        const translationObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        // Translate elements with data-i18n attribute
                        const i18nElements = node.querySelectorAll?.('[data-i18n]') || [];
                        i18nElements.forEach(el => {
                            const key = el.getAttribute('data-i18n');
                            if (key && t(key)) {
                                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                                    el.placeholder = t(key);
                                } else {
                                    el.textContent = t(key);
                                }
                            }
                        });

                        // If the added node itself has data-i18n
                        if (node.hasAttribute?.('data-i18n')) {
                            const key = node.getAttribute('data-i18n');
                            if (key && t(key)) {
                                if (node.tagName === 'INPUT' || node.tagName === 'TEXTAREA') {
                                    node.placeholder = t(key);
                                } else {
                                    node.textContent = t(key);
                                }
                            }
                        }
                    }
                });
            });
        });

        // Start observing the document for changes
        function startTranslationObserver() {
            translationObserver.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // ==================== AI RESPONSE TRANSLATION ====================
        async function translateAIResponse(text) {
            const currentLang = assessmentData.currentLanguage;

            // No translation needed for English
            if (currentLang === 'en') {
                return text;
            }

            // Try OpenAI translation if API key is available
            if (API_CONFIG.openai.key) {
                try {
                    const langNames = {
                        'hi': 'Hindi',
                        'mr': 'Marathi',
                        'ta': 'Tamil',
                        'gu': 'Gujarati'
                    };

                    const targetLang = langNames[currentLang] || 'Hindi';

                    const response = await fetch(API_CONFIG.openai.endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_CONFIG.openai.key}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [
                                {
                                    role: 'system',
                                    content: `You are a professional medical translator. Translate the following medical assessment text to ${targetLang}. Maintain medical accuracy and professional tone.`
                                },
                                {
                                    role: 'user',
                                    content: text
                                }
                            ],
                            temperature: 0.3,
                            max_tokens: 1500
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.choices[0].message.content;
                    }
                } catch (error) {
                    console.error('OpenAI translation error:', error);
                }
            }

            // Fallback to MyMemory API (free, no key required)
            try {
                const langCodes = {
                    'hi': 'hi',
                    'mr': 'mr',
                    'ta': 'ta',
                    'gu': 'gu'
                };

                const targetLang = langCodes[currentLang] || 'hi';

                // Split text into chunks (MyMemory has length limits)
                const chunkSize = 500;
                const chunks = [];
                for (let i = 0; i < text.length; i += chunkSize) {
                    chunks.push(text.substring(i, i + chunkSize));
                }

                const translatedChunks = await Promise.all(
                    chunks.map(async (chunk) => {
                        const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(chunk)}&langpair=en|${targetLang}`);
                        if (response.ok) {
                            const data = await response.json();
                            return data.responseData.translatedText;
                        }
                        return chunk;
                    })
                );

                return translatedChunks.join(' ');
            } catch (error) {
                console.error('MyMemory translation error:', error);
                return text; // Return original text if translation fails
            }
        }

        // ==================== IMPACT OPTIONS ====================
        function renderImpactOptions() {
            const step3 = document.getElementById('step3');
            if (!step3) return;

            // Determine which impact set to use based on body part
            const bodyPart = assessmentData.bodyPart;
            const impactSet = IMPACT_MATRIX[bodyPart] || IMPACT_MATRIX.default;

            // Find or create impact section
            let impactSection = step3.querySelector('.impact-section');
            if (!impactSection) {
                impactSection = document.createElement('div');
                impactSection.className = 'impact-section';
                // step3 IS the .step-content div, use it directly
                step3.insertBefore(impactSection, step3.firstChild);
                console.log('âœ… Impact section inserted into step3');
            }

            // SVG icons for each impact level
            const svgIcons = {
                'check-circle': '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>',
                'alert-triangle': '<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>',
                'alert-circle': '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>',
                'alert-octagon': '<path d="M12 2L1 21h22L12 2zm0 3.99L19.53 19H4.47L12 5.99zM11 16h2v2h-2zm0-6h2v4h-2z"/>'
            };

            // Build impact cards dynamically
            const impactLevels = ['mild', 'moderate', 'severe', 'critical'];
            const cardsHTML = impactLevels.map(level => {
                const data = impactSet[level];
                return `
                    <div class="impact-card" data-impact="${level}">
                        <div class="impact-icon">
                            <svg viewBox="0 0 24 24">
                                ${svgIcons[data.icon]}
                            </svg>
                        </div>
                        <div class="impact-content">
                            <div class="impact-title">${data.title}</div>
                            <div class="impact-description">${data.description}</div>
                        </div>
                    </div>
                `;
            }).join('');

            impactSection.innerHTML = `
                <h3 class="section-title" data-i18n="impactLabel">${t('impactLabel') || 'Impact on Daily Life'}</h3>
                <div class="impact-options">
                    ${cardsHTML}
                </div>
            `;

            // Add event delegation for impact card clicks
            const impactOptions = impactSection.querySelector('.impact-options');
            if (impactOptions) {
                // Remove old listeners by cloning
                const newImpactOptions = impactOptions.cloneNode(true);
                impactOptions.parentNode.replaceChild(newImpactOptions, impactOptions);

                // Add new event listener with delegation
                newImpactOptions.addEventListener('click', (e) => {
                    const card = e.target.closest('.impact-card');
                    if (card) {
                        const level = card.getAttribute('data-impact');
                        if (level) {
                            handleImpactSelect(level);
                        }
                    }
                });
            }

            // Highlight selected impact if exists
            if (assessmentData.impactLevel) {
                const selectedCard = impactSection.querySelector(`[data-impact="${assessmentData.impactLevel}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
            }
        }

        function handleImpactSelect(impact) {
            assessmentData.impactLevel = impact;

            // Update UI
            document.querySelectorAll('.impact-card').forEach(card => {
                card.classList.remove('selected');
            });

            const selectedCard = document.querySelector(`[data-impact="${impact}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }

            // Refresh dependent questions based on impact level
            const bodyPart = assessmentData.bodyPart;
            if (bodyPart && CONTEXT_MATRIX[bodyPart]) {
                renderDynamicSections(bodyPart);
            }

            saveSession();
            checkNextButtonState();

            // Speak confirmation
            speak(`${t(impact)} impact selected`);

            // Auto-scroll to next section
            autoScrollToCurrentSection();
        }

        // Initialize body part accessibility and event handling
        function initializeBodyDiagram() {
            const svgs = ['maleSvg', 'femaleSvg'];

            svgs.forEach(svgId => {
                const svg = document.getElementById(svgId);
                if (!svg) return;

                // Add accessibility attributes to all body parts
                const bodyParts = svg.querySelectorAll('.body-part');
                bodyParts.forEach((part, index) => {
                    const partName = part.getAttribute('data-part');
                    if (partName) {
                        // Add tabindex for keyboard navigation
                        part.setAttribute('tabindex', '0');

                        // Add aria-label for screen readers
                        const formattedName = partName.charAt(0).toUpperCase() + partName.slice(1);
                        part.setAttribute('aria-label', `Select ${formattedName}`);
                        part.setAttribute('role', 'button');

                        // Add keyboard support
                        part.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                selectBodyPart(partName, true, e);
                            }
                        });
                    }
                });
            });
        }

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ DOMContentLoaded fired - Starting initialization...');
            // Wait for translations.js to fully load (increased delay for reliability)
            console.log('â³ Waiting 1200ms for translations.js to load...');
            await new Promise(resolve => setTimeout(resolve, 1200));
            console.log('âœ… 1200ms delay completed');

            // Initialize body diagram with accessibility features
            console.log('ðŸŽ¨ Initializing body diagram...');
            initializeBodyDiagram();

            // Initialize simplified language system (EN, HI, MR)
            console.log('ðŸš€ Initializing language system...');
            await initializeLanguageSystem();
            console.log('âœ… Language system initialized successfully');

            updateProgress();
            checkNextButtonState();
            loadSession();

            // Apply translations after loading session
            applyTranslations();

            // Initialize duration slider with proper event handling
            console.log('ðŸŽšï¸ Initializing duration slider...');
            const durationSlider = document.getElementById('durationSlider');
            const durationLabel = document.getElementById('durationValue');

            if (durationSlider && durationLabel) {
                console.log('âœ… Duration slider found');

                // Initialize with current value or default
                const initialValue = parseInt(durationSlider.value) || 3;
                assessmentData.durationMonths = initialValue;
                durationLabel.textContent = initialValue === 1 ? `1 ${t('month')}` : `${initialValue} ${t('months')}`;
                console.log('ðŸ“Š Initialized duration slider with value:', initialValue, 'â†’', durationLabel.textContent);

                durationSlider.addEventListener('input', function(e) {
                    const value = parseInt(e.target.value);
                    console.log('ðŸ”„ Duration slider changed to:', value);

                    // Update assessmentData
                    assessmentData.durationMonths = value;
                    console.log('ðŸ’¾ Stored in assessmentData.durationMonths:', assessmentData.durationMonths);

                    // Update display label with current language (with fallback)
                    const monthText = value === 1 ? (t('month') || 'month') : (t('months') || 'months');
                    durationLabel.textContent = `${value} ${monthText}`;
                    console.log('âœ… Updated label to:', durationLabel.textContent);

                    // Save session
                    saveSession();
                });

                console.log('âœ… Duration slider event listener attached');
            } else {
                console.error('âŒ Duration slider or label not found!');
            }

            // Start mutation observer for dynamic content
            startTranslationObserver();

            // Render impact options in Step 3
            renderImpactOptions();

            // Check if API keys are configured
            if (!API_CONFIG.openai.key) {
                setTimeout(() => {
                    if (confirm('OpenAI API key not configured. Would you like to configure it now for real AI analysis?')) {
                        openConfig();
                    }
                }, 2000);
            }

            setTimeout(() => {
                speak(t('headerTitle'));
            }, 1000);
        });

        // Save session before page unload
        window.addEventListener('beforeunload', function() {
            saveSession();
        });

        // AUTO-SCROLL TO RESULTS
        function scrollToResults() {
            const aiResults = document.getElementById('aiResults');
            if (aiResults && aiResults.classList.contains('active')) {
                setTimeout(() => {
                    aiResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
            }
        }

        // Call this after AI analysis completes
        const originalDisplayAIChatResults = displayAIChatResults;
        displayAIChatResults = function() {
            originalDisplayAIChatResults();
            scrollToResults();
        };

        // ==================== GLOBAL EXPORTS FOR INLINE ONCLICK HANDLERS ====================
        // Make functions globally accessible for inline onclick handlers in HTML
        window.selectBodyPart = selectBodyPart;
        window.selectIntensity = selectIntensity;
        window.selectDuration = selectDuration;
        window.toggleActivity = toggleActivity;
        window.switchLanguage = switchLanguage;
        window.saveConfig = saveConfig;
        window.toggleVoice = toggleVoice;
        window.openConfig = openConfig;
        window.goToStep = goToStep;
        window.showTooltip = showTooltip;
        window.hideTooltip = hideTooltip;
        window.nextStep = nextStep;
        window.previousStep = previousStep;
        window.downloadPDF = downloadPDF;
        window.shareWithDoctor = shareWithDoctor;
        window.askFollowUp = askFollowUp;
        window.submitFeedback = submitFeedback;
        window.selectContextOption = selectContextOption;
        window.toggleActivityTrigger = toggleActivityTrigger;
        window.speakQuestion = speakQuestion;
        window.startVoiceAnswerInput = startVoiceAnswerInput;
        console.log('âœ… All onclick functions exported to window scope');

        // ==================== DIAGNOSTIC TEST FUNCTION ====================
        window.testLanguageSwitch = function(langCode) {
            console.clear();
            console.log('ðŸ§ª DIAGNOSTIC TEST START');
            console.log('Testing language switch to:', langCode);
            console.log('');

            console.log('1ï¸âƒ£ Checking TRANSLATIONS object...');
            if (typeof TRANSLATIONS === 'undefined') {
                console.error('âŒ TRANSLATIONS is UNDEFINED!');
                return;
            }
            console.log('âœ… TRANSLATIONS exists');
            console.log('   Available languages:', Object.keys(TRANSLATIONS));

            console.log('');
            console.log('2ï¸âƒ£ Checking if translations exist for', langCode);
            if (!TRANSLATIONS[langCode]) {
                console.error('âŒ No translations for ' + langCode);
                console.log('   Available:', Object.keys(TRANSLATIONS));
                return;
            }
            console.log('âœ… Translations found for', langCode);
            console.log('   Sample keys:', Object.keys(TRANSLATIONS[langCode]).slice(0, 5));

            console.log('');
            console.log('3ï¸âƒ£ Testing translation values...');
            const headerEN = TRANSLATIONS.en.headerTitle;
            const headerTarget = TRANSLATIONS[langCode].headerTitle;
            console.log('   EN headerTitle:', headerEN);
            console.log('   ' + langCode + ' headerTitle:', headerTarget);

            console.log('');
            console.log('4ï¸âƒ£ Checking DOM elements...');
            const headerElement = document.getElementById('headerTitle');
            if (!headerElement) {
                console.error('âŒ headerTitle element NOT FOUND in DOM!');
                return;
            }
            console.log('âœ… headerTitle element found');
            console.log('   Current text:', headerElement.textContent);

            console.log('');
            console.log('5ï¸âƒ£ Testing switchLanguage() function...');
            if (typeof switchLanguage !== 'function') {
                console.error('âŒ switchLanguage is not a function!');
                return;
            }
            console.log('âœ… switchLanguage is a function');
            console.log('   Calling switchLanguage("' + langCode + '")...');
            switchLanguage(langCode);

            console.log('');
            console.log('6ï¸âƒ£ Checking result after 1 second...');
            setTimeout(function() {
                const newText = document.getElementById('headerTitle')?.textContent;
                console.log('   Header text NOW:', newText);
                if (newText === headerTarget) {
                    console.log('âœ…âœ…âœ… SUCCESS! Language switched to', langCode);
                } else if (newText === headerEN) {
                    console.error('âŒâŒâŒ FAILED! Text is still in English');
                } else {
                    console.warn('âš ï¸âš ï¸âš ï¸ UNEXPECTED! Text is:', newText);
                }
                console.log('ðŸ§ª DIAGNOSTIC TEST END');
            }, 1000);
        };

        // Export shortcuts for easy testing
        window.testHindi = function() { testLanguageSwitch('hi'); };
        window.testMarathi = function() { testLanguageSwitch('mr'); };

        console.log('');
        console.log('ðŸ§ª DIAGNOSTIC FUNCTIONS AVAILABLE:');
        console.log('   Type: testHindi()    - to test Hindi translation');
        console.log('   Type: testMarathi()  - to test Marathi translation');
        console.log('   Type: testLanguageSwitch("ar") - to test any language');
    </script>

    <!-- FLOATING ACTION BAR -->
    <div class="floating-action-bar" id="floatingActionBar">
        <button class="fab-btn" onclick="switchLanguage(assessmentData.currentLanguage === 'en' ? 'hi' : 'en')" title="Switch Language">
            <svg class="icon-svg" viewBox="0 0 24 24">
                <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/>
            </svg>
        </button>
        <button class="fab-btn" onclick="toggleVoice()" title="Toggle Voice">
            <svg class="icon-svg" viewBox="0 0 24 24">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
            </svg>
        </button>
        <button class="fab-btn" onclick="openConfig()" title="Settings">
            <svg class="icon-svg" viewBox="0 0 24 24">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
            </svg>
        </button>
    </div>
</body>
</html>
